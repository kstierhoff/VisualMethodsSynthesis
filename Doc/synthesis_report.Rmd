---
header-includes: \usepackage{array} \usepackage{booktabs} \usepackage{calc} \usepackage{caption}
  \usepackage{colortbl} \usepackage{float} \usepackage{graphicx} \usepackage{hhline} \usepackage{isomath}
  \usepackage{longtable} \usepackage{multirow} \usepackage{pdflscape} \usepackage{siunitx} \usepackage[table]{xcolor} 
  \usepackage{tabu} \usepackage{tabularx} \usepackage{textcomp} \usepackage{threeparttable} \usepackage{upgreek}
  \usepackage{wrapfig} \newcommand{\blandscape}{\begin{landscape}} \newcommand{\elandscape}{\end{landscape}}
output:
  pdf_document:
    fig_caption: no
  html_document: default
  word_document:
    reference_docx: template/report_template_Rmarkdown.docx
    pandoc_args: [
     "--filter", "yaml/pandoc_newpage_filter.R"
     ]
bibliography: bib/ast_bib.bib
csl: csl/ices-journal-of-marine-science.csl
---  

```{r ConfigureDocument, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
# List packages required to run the script
pkgs <- c("raster","tidyverse","knitr","swfscMisc","lubridate","here","boot","sf",
          "maps","readxl","maptools","png","mapdata","flextable","knitr",
          "cowplot","devtools","kableExtra","RODBC","pander","DBI",
          "rnaturalearth","odbc","shadowtext")
# Install and load all CRAN packages provided from a character vector
load_pkgs = function(pkgs) {
  new_pkgs = pkgs[!(pkgs %in% installed.packages()[ ,'Package'])]
  if (length(new_pkgs) > 0) install.packages(new_pkgs,repos = "http://cran.cnr.berkeley.edu/")
  invisible(lapply(pkgs,function(x)
    suppressPackageStartupMessages(library(x,character.only = T))))
}
# Load packages
load_pkgs(pkgs)

# Install and load surveyR package from github
if ("surveyR" %in% installed.packages()[ ,'Package'] == F) {
  install_github("kstierhoff/surveyR")
}
# Load surveyR
library(surveyR)

# determines method of table generation (whether kable or pander) for best formatting
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
if (is.null(doc.type)) {doc.type <- "html"}

# global knitr chunk options
knitr::opts_chunk$set(echo = F, warning = F, message = F, dev = "png", 
                      dev.args = list(type = "cairo"), dpi = 150)

# set global knitr options
options(knitr.kable.NA = '')

# determine global knitr table format
if (doc.type == "latex") {
  knitr.format <- "latex"
} else {
  knitr.format <- "html" 
}

# processing instructions (TRUE/FALSE)
import.data <- F # Download data from SQL database
sub.source  <- "Access" # Or DSN if getting from database directly
save.figs   <- F # Draw plots and maps, or use existing
do.boot     <- F # Conduct bootstrap resampling
get.sf      <- F # Download costline data
n.boot      <- 1000 # Number of bootstrap samples

# Set plotting preferences
rov.colour = "yellow"
sub.colour = "blue"
auv.colour = "green"

# Set figure dimensions
fig.width  = 5
fig.height = 7
```  

```{r ImportSurveyData}
strata.area <- read_csv(here("Data/strata_area.csv")) %>% 
  rename(site = site_name,
         stratum = depth_stratum) %>% 
  mutate(stratum_area = area*1e6) %>% 
  select(-area)
# Summarize strata area by site
site.area <- strata.area %>% 
  group_by(site) %>% 
  summarize(stratum_area = sum(stratum_area))
```

```{r ImportROV}
if (import.data) {
  channel = odbcConnect(dsn = 'ROV2')
  nav.rov <- sqlQuery(channel,"
            SELECT dbo.tbl_NAV.*, dbo.tbl_LOGS.survey_number, dbo.tbl_LOGS.site_general
            FROM dbo.tbl_LOGS INNER JOIN dbo.tbl_NAV ON dbo.tbl_LOGS.dive_name = dbo.tbl_NAV.dive_name
            WHERE (((dbo.tbl_LOGS.survey_number)=40));")
  logs.rov             <- sqlFetch(channel, "dbo.tbl_LOGS")
  events.rov           <- sqlFetch(channel, "dbo.tbl_EVENTS") 
  video.obs.rov        <- sqlFetch(channel, "dbo.tbl_VIDEO_OBS")
  photo.info.rov       <- sqlFetch(channel, "dbo.tbl_PHOTO_INFO")
  photo.obs.rov        <- sqlFetch(channel, "dbo.tbl_PHOTO_OBS")
  lengths.rov          <- sqlFetch(channel, "dbo.tbl_FISH_LENGTHS")
  spp                  <- sqlFetch(channel, "dbo.tlu_SPECIES_CODES")
  size.codes           <- sqlFetch(channel, "dbo.tlu_SIZE_CODES")
  lw.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_WEIGHT_DATA")
  la.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_AGE_DATA")
  close(channel)
  
  save(nav.rov,logs.rov,events.rov,video.obs.rov,photo.info.rov,
       photo.obs.rov,lengths.rov,spp,lw.data,la.data,size.codes,
       file = here("Data/ROV/rov_data.Rdata"))
} else {
  load(here("Data/ROV/rov_data.Rdata"))
}

# Rename species code colums
spp <- spp %>% 
  rename(sciName = sci_name_full,
         commonName = common_name)

# Remove unused logs
logs.rov <- filter(logs.rov,survey_number == 40 & for_analysis == 1) %>% 
  rename(site = site_general)

# Read good nav IDs
nav.rov.good <- read_csv(here("Data/ROV/good_rov_nav.csv"))$nav_id

# Filter, rename nav
nav.rov        <- filter(nav.rov,dive_name %in% logs.rov$dive_name) %>%
  rename(site = site_general,
         long = long_r,
         lat  = lat_r,
         disp = disp_r) %>% 
  filter(nav_id %in% nav.rov.good) %>%
  mutate(depth = depth - altitude, # Calculate seabed depth from pressure and altitude
         stratum = cut(depth,seq(-400,0,100))) %>% 
  arrange(date_time)

# Add lat/long/depth and species information to observations
video.obs.rov <- filter(video.obs.rov,dive_name %in% logs.rov$dive_name) %>% 
  left_join(select(nav.rov,nav_id,lat,long,depth)) %>% 
  left_join(select(spp,species_code,sci_name,sciName,commonName,species_group)) %>% 
  left_join(select(size.codes,size_code,desc_coast11)) %>% 
  rename(size_class = desc_coast11) %>%
  mutate(geol_ps = paste(geol_prim,geol_sec,sep = "")) %>% 
  droplevels()

# Calculate transect width
cw.data <- calc_width(nav.rov$pitch,nav.rov$altitude,ROV = "Phantom")

# Merge data
nav.rov <- bind_cols(nav.rov,cw.data) %>% 
  filter(pitch < 0 & slant_range <= 6) %>% 
  mutate(area = center_width * disp)

# Summmarise nav by dive and depth stratum for bootstrap analysis
nav.rov.boot <- nav.rov %>% 
  group_by(dive_name,stratum) %>% 
  summarise(
    distance = sum(disp),
    area = sum(area),
    depth.min = min(abs(depth)),
    depth.max = max(abs(depth)),
    duration = round(as.numeric(difftime(max(date_time),min(date_time),units = "mins"))))

# Summarize nav by site and stratum for tables
nav.rov.summ <- nav.rov %>% 
  group_by(site, stratum) %>% 
  summarise(
    n.tx = n_distinct(dive_name),
    depth.min = min(abs(depth)),
    depth.max = max(abs(depth)),
    distance = sum(disp),
    survey_area = sum(area)) %>% 
  mutate(platform = "ROV") %>% 
  arrange(site,desc(stratum))

# Filter other data
events.rov <- filter(events.rov,dive_name %in% logs.rov$dive_name)

# Format L/W data table
lw.data <- filter(lw.data, to_use == 1) %>%
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(a)) %>% 
  left_join(select(spp,sciName,commonName)) %>% 
  select(sciName, commonName, a, b, L_max, sex, Reference, comment)

# Format L/age data table
la.data <- filter(la.data, to_use == 1) %>% 
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(L_inf))

# Extract only fish observations
obs.rov <- video.obs.rov %>% 
  filter(str_detect(sciName,"Sebastes|Sebastolobus|Sebastomus|Ophiodon|Merluccius")) %>% 
  left_join(select(lw.data,sciName,a,b,L_max)) %>% 
  mutate(stratum = cut(depth,seq(-400,0,100)),
         length_cm = size_code * 10 + 5,
         weight_g = a * length_cm^b * counts) %>% 
  droplevels()

# Summarize ROV observations
obs.rov.summ <- obs.rov %>% 
  group_by(sciName, commonName) %>% 
  summarise(nROV = sum(counts)) %>% 
  arrange(desc(nROV)) %>% 
  mutate(pctROV = nROV/sum(.$nROV)*100)
  
# ROV data for bootstrap analysis 
boot.data.rov <- obs.rov %>% 
  group_by(dive_name,stratum,sciName) %>% 
  summarise(counts      = sum(counts),
            weight_g    = sum(weight_g)) %>% 
  left_join(nav.rov.boot) %>%
  left_join(select(logs.rov,dive_name,site)) %>%
  mutate(dens_n = counts/area,         # Numeric density (n/m)
         dens_g = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund = dens_n*stratum_area, # Abundance (n)
         biom  = dens_g*stratum_area,
         platform = "ROV") %>%   # Biomass (g)
  arrange(desc(counts))

# Write to CSV
write_csv(boot.data.rov,here("Output/boot_data_rov.csv"))

# Filter photo info 
photo.info.rov <- filter(photo.info.rov,dive_name %in% logs.rov$dive_name)
# Process photo observations
photo.obs.rov  <- filter(photo.obs.rov,photo_id %in% photo.info.rov$photo_id) %>% 
  left_join(select(spp,sci_name,sciName,commonName)) %>%
  filter(str_detect(sciName,"Sebastes|Sebastolobus|Sebastomus|Ophiodon|Merluccius")) %>%
  droplevels()

# Add species info to length data
lengths.rov <- filter(lengths.rov,dive_name %in% logs.rov$dive_name) %>% 
  left_join(select(spp,species_code,sci_name,sciName,commonName,species_group)) %>% 
  droplevels()

lw.data.rov <- obs.rov %>% 
  select(sciName, commonName, counts, length_cm, weight_g)
  
# Expand data frame by counts
lw.data.rov <- obs.rov[rep(row.names(obs.rov),obs.rov$counts), ] %>% 
  select(sciName, commonName, counts, length_cm, weight_g) %>% 
  mutate(platform = "ROV")
```

```{r ImportSUB}
if (import.data) {
  if (sub.source == "DSN") {
    sub.con.dsn <- dbConnect(odbc::odbc(),.connection_string = "
                           Driver={SQL Server};
                           Server=128.114.3.186;
                           Database=riglevisbase;
                           Uid=kevin.stierhoff;
                           Pwd=rockfish;")
    
    # dbListTables(sub.con.dsn)
    dbDisconnect(sub.con.dsn)    
  } else {
    # Configure connection to Acess database
    sub.con <- channel <- odbcConnectAccess2007(here("Data/SUB/sub_data.accdb"))    
    # Import NAV data  
    nav.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_nav") %>% 
      filter(transect != 0 & segment != 0) %>% 
      rename(lat       = latitude,
             long      = longitude,
             cum_dist  = cum_dist_m) %>% 
      unite(date,year,month,day,sep = "-") %>% 
      mutate(time      = str_extract(time,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = paste(dive, transect, sep = "0")) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time),
             dist = c(diff(cum_dist),0)) %>% 
      filter(dist < 5 & dist > -5)
    
    # Import CTD data
    ctd.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_ctd") %>% 
      unite(date,year,month,day,sep = "-") %>% 
      filter(transect != 0 & segment != 0) %>% 
      mutate(time      = str_extract(realtime,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = paste(dive, transect, sep = "0")) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time)) %>% 
      rename(depth     = depth_m,
             oxy_conc  = Oxygen_ml_L,
             oxy_sat   = Oxygen_percent_saturation) %>% 
      filter(dive_name %in% nav.sub$dive_name)
    
    # Close connection
    close(sub.con)
    
    # Import density summary
    counts.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                             sheet = "Yok_Sub_Density_step3") %>% 
      rename(site = bank,
             dive_name = dive_tx,
             sciName   = Scientific_Name,
             counts    = SumOfSumOffreq,
             distance  = SumOfdist,
             stratum   = depth_bin) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             sciName   = str_replace(sciName,"unidentified sebastomus","Sebastomus sp."),
             sciName   = str_replace(sciName,"Sebastes spp.","Sebastes sp."),
             sciName   = str_replace(sciName,"Sebastolobus spp.","Sebastolobus sp."),
             sciName   = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>%
      left_join(select(spp, sciName, commonName)) %>% 
      droplevels()
    
    # Get list of fishcodes and sciNames
    names.sub <- counts.sub %>% 
      select(sciName,fishcode) %>% 
      distinct() %>% 
      arrange(sciName)
    
    # Import biomass summary
    lengths.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                             sheet = "Yok_Sub_Biomass_step2") %>% 
      left_join(names.sub) %>% 
      rename(site = bank,
             dive_name = divetx,
             counts    = SumOffreq,
             length_cm = size_class) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             sciName   = str_replace(sciName,"unidentified sebastomus","Sebastomus sp."),
             sciName   = str_replace(sciName,"Sebastes spp.","Sebastes sp."),
             sciName   = str_replace(sciName,"Sebastolobus spp.","Sebastolobus sp."),
             sciName   = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>%
      left_join(select(spp, sciName, commonName)) %>% 
      droplevels()
    
    # Get transect distances
    tx.dist.sub <- counts.sub %>% 
      select(dive_name,distance) %>% 
      distinct() %>% 
      arrange(dive_name)
    
    # Import sub density summary
    biomass.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                           sheet = "Yok_Sub_Biomass_step2") %>% 
      rename(site = bank,
             dive_name = divetx,
             counts    = SumOffreq,
             length_cm = size_class) %>% 
      select(-a_coeff,-b_coeff,-tx_area_m2,-weight_g) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             stratum = cut(depth_bin * -0.9,seq(-400,0,100))) %>% 
      left_join(names.sub) %>% 
      left_join(select(lw.data,sciName,a,b,L_max)) %>% 
      left_join(tx.dist.sub) %>% 
      mutate(area = distance * 2.5,
             weight_g = a * length_cm^b * counts)
    
    # Get strata for each transect to add to CTD
    tx.strata.sub <- biomass.sub %>% 
      select(site, dive_name, stratum) %>% 
      distinct() %>% 
      arrange(dive_name)
    
    # Add transect info to CTD data for summarizing later
    ctd.sub <- ctd.sub %>% 
      left_join(tx.strata.sub)
  }
  # Save SUB data
  save(counts.sub,biomass.sub,ctd.sub,nav.sub,tx.dist.sub,lengths.sub,file = here("Data/SUB/sub_data.Rdata"))
} else {
  # Load SUB data
  load(here("Data/SUB/sub_data.Rdata"))
}

# Get min and max depth from SUB CTD
ctd.sub.summ <- ctd.sub %>% 
  group_by(dive_name) %>% 
  summarise(depth.min = min(depth),
            depth.max = max(depth))

# Summarize transect duration and distance for the SUB
tx.summ.sub <- nav.sub %>% 
  group_by(dive_name) %>% 
  summarise(
    duration = as.numeric(difftime(max(date_time),min(date_time),units = "mins"))) %>% 
  mutate(platform = "SUB") %>% 
  left_join(tx.dist.sub)

# Summarize SUB nav by site and stratum for tables
nav.sub.summ <- biomass.sub %>%
  select(site, stratum, dive_name, distance, area) %>% 
  distinct() %>% 
  left_join(ctd.sub.summ) %>%
  group_by(site,stratum) %>%
  summarise(
    n.tx = n_distinct(dive_name),
    depth.min = min(depth.min, na.rm = T),
    depth.max = max(depth.max, na.rm = T),
    distance = sum(distance),
    survey_area = sum(area)) %>%
  mutate(platform = "SUB") %>% 
  arrange(site,desc(stratum))

# Summarize SUB observations
obs.sub.summ <- counts.sub %>% 
  group_by(sciName, commonName) %>% 
  summarise(nSUB = sum(counts)) %>% 
  arrange(desc(nSUB)) %>% 
  mutate(pctSUB = nSUB/sum(.$nSUB)*100)

# ROV data for bootstrap analysis 
boot.data.sub <- biomass.sub %>% 
  group_by(site,dive_name,stratum,sciName) %>% 
  summarise(counts   = sum(counts),
            weight_g = sum(weight_g)) %>% 
  left_join(distinct(select(biomass.sub,dive_name,distance,area))) %>% 
  mutate(
    dens_n      = counts/area,         # Numeric density (n/m)
    dens_g      = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund  = dens_n*stratum_area, # Abundance (n)
         biom   = dens_g*stratum_area,
         platform = "SUB") # Biomass (g)

# Write to CSV
write_csv(boot.data.sub,here("Output/boot_data_sub.csv"))

# Expand data frame by counts
lw.data.sub <- lengths.sub[rep(row.names(lengths.sub),lengths.sub$counts), ] %>% 
  select(sciName, commonName, counts, length_cm, weight_g) %>% 
  mutate(platform = "SUB")
```

```{r ImportAUV}

```

```{r LengthWeightHistogram,eval=F}
# Combine all L/W data
lw.data.all <- lw.data.rov %>% 
  bind_rows(lw.data.sub)

# Length histogram for all species
lw.hist.all <- ggplot(lw.data.all, aes(length_cm, fill = platform)) +
  geom_histogram(breaks = seq(0,70,10),colour = "white",alpha = 0.5) +
  scale_fill_manual(name = "Vehicle\n", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  facet_wrap(~sciName, scales = "free_y") +
  theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background.x = element_blank()) +
  xlab("\nTotal length (cm)") + ylab("Frequency")

# Save figure
ggsave(lw.hist.all, filename = here("Figs/fig_histogram_length_comp.png"),
       height = 12, width = 15)
```


```{r CombineBootstrapData}
# Combine data from all vehicles for the bootstrap analysis
boot.data.all <- bind_rows(boot.data.rov, boot.data.sub) # Add AUV data

# Summarize observatiosn from each vehicle for tabular output
obs.summ.all <- boot.data.all %>% 
  group_by(sciName, platform) %>% 
  summarize(counts = sum(counts)) %>% 
  spread(platform,counts) %>% 
  mutate(ALL = sum(ROV,SUB,na.rm = T)) %>% 
  arrange(desc(ALL))

# Write to CSV
write.csv(obs.summ.all,file = here("Output/obs_summ.csv"), row.names = F, quote = F, na = "-")
```

```{r CreateSiteMap}
# rnaturalearth vignette
# https://cran.r-project.org/web/packages/rnaturalearth/vignettes/rnaturalearth.html

# Get land features
if (get.sf) {
  # Download highres polygons for N. America
  na_sf <- ne_countries(type = 'countries', scale = 'large', returnclass = "sf") %>% 
    filter(subregion %in% c("Northern America") & admin %in% c("United States of America","Canada"))
  # Save sf objects
  save(na_sf,file = here("Data/GIS/na_sf.Rdata"))
} else {
  # Load sf objects
  load(here("Data/GIS/na_sf.Rdata"))
}

if (save.figs) {
  # Read bathy and hillshade rasters
  # https://nrelscience.org/2013/05/30/this-is-how-i-did-it-mapping-in-r-with-ggplot2/
  bathy <- raster(here("Data/GIS/bathy_wgs84.tif")) %>% 
    rasterToPoints() %>% 
    as.data.frame() %>% 
    rename(long = x,
           lat = y,
           depth = bathy_wgs84)
  
  hill <- raster(here("Data/GIS/hill_wgs84.tif")) %>% 
    rasterToPoints() %>% 
    as.data.frame() %>% 
    rename(long = x,
           lat = y,
           hill = hill_wgs84)
  
  # Read shapefiles
  sample_frame   <- st_read(here("Data/GIS/sampling_frame.shp"))
  depth_strata   <- st_read(here("Data/GIS/depth_polygons.shp"))
  depth_contours <- st_read(here("Data/GIS/depth_contours.shp"))
  nav.auv        <- st_read(here("Data/GIS/auv_nav_lines.shp"))
  grid.auv       <- st_read(here("Data/GIS/auv_fishnet.shp"))
  bank_labels    <- read_csv(here("Data/GIS/bank_labels.csv"))
  
  # Map ROV tracks
  survey.map <- ggplot() +
    geom_raster(data = hill, aes(long, lat, alpha = hill), show.legend = F) +
    geom_sf(data = depth_strata, aes(fill = stratum_z), alpha = 0.5) +
    geom_sf(data = depth_contours, colour = "gray20", size = 1) + 
    geom_sf(data = grid.auv, fill = NA) +
    geom_sf(data = sample_frame, colour = "black", size = 1.5, fill = NA, linetype = "dashed") + 
    geom_shadowtext(data = bank_labels, aes(long, lat, label = label), 
                    size = 5, fontface = "bold", color = "black", bg.color = "white") +
    geom_path(data = nav.rov, aes(long,lat, group = dive_name), colour = "black",  size = 0.5) +
    geom_path(data = nav.sub, aes(long,lat, group = dive_name), colour = "green", size = 0.5) +
    geom_sf(data = nav.auv, colour = "orange", size = 0.5) +
    scale_alpha(range = c(1, 0.1)) +
    scale_fill_manual(name = "Depth", values = c("white","lightblue1","royalblue","royalblue4")) +
    xlab("\nLongitude") + ylab("Latitude\n") +
    coord_sf(xlim = c(-119.525, -119.435), ylim = c(33.915, 33.97)) +
    theme_bw() +
    theme(axis.text.x = element_text(size = 11),
          axis.text.y = element_text(size = 11, angle = 90, hjust = 0.5),
          axis.title.x = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          panel.grid.major = element_line(colour = "white"))
  
  # Save site map
  ggsave(survey.map, file = here("Figs/fig_survey_map.png"),
         height = 10, width = 12)
}
```  

```{r ROV_bootstrap}
# Bootstrap ROV abundance and biomass by strata
if (do.boot) {
  # i = "Sebastes levis"
  # j = "The Footprint"
  # k = "(-200,-100]"
  boot.df.rov <- data.frame()
  
  for (i in unique(boot.data.rov$sciName)) {
    for (j in unique(boot.data.rov$site)) {
      for (k in unique(boot.data.rov$stratum)) {
        boot.data <- filter(boot.data.rov, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:n.boot)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.rov <- rbind(boot.df.rov,
                               data.frame(platform = "ROV", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,n.boot),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.rov, file = here("Output/boot_results_rov.Rdata"))
} else {
  load(here("Output/boot_results_rov.Rdata"))
}
# Summarise ROV results by stratum
boot.summ.stratum.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# Calculate ROV biomass and abundance across all strata
boot.samples.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

# Summarise ROV biomass and abundance across all strata
boot.summ.sample.rov <- boot.samples.rov %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975)) %>% 
  arrange(sciName, site)
```

```{r SUB_bootstrap}
if (do.boot) {
  # Bootstrap SUB abundance and biomass by strata

  # Create data frame for storing results
  boot.df.sub <- data.frame()
  
  for (i in unique(boot.data.sub$sciName)) {
    for (j in unique(boot.data.sub$site)) {
      for (k in unique(boot.data.sub$stratum)) {
        boot.data <- filter(boot.data.sub, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:n.boot)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.sub <- rbind(boot.df.sub,
                               data.frame(platform = "SUB", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,n.boot),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.sub, file = here("Output/boot_results_sub.Rdata"))
} else {
  load(here("Output/boot_results_sub.Rdata"))
}
# Summarise SUB results by stratum
boot.summ.stratum.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# Calculate SUB biomass and abundance across all strata
boot.samples.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

# Summarise SUB biomass and abundance across all strata
boot.summ.sample.sub <- boot.samples.sub %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))
```

```{r AUV_bootstrap,eval = T}
boot.summ.sample.auv <- boot.summ.sample.rov[0, ]
```

```{r ALL_bootstrap_summary}
boot.summ.sample.all <- bind_rows(boot.summ.sample.rov,boot.summ.sample.sub) %>% 
  ungroup() %>%
  mutate(sciName = fct_rev(factor(sciName)),
         biom_cv_cut = cut(biom.cv,c(0,25,50,75,100)),
         abund_cv_cut = cut(abund.cv,c(0,25,50,75,100)),
         sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>% 
  left_join(site.area) 

main.spp <- c("Sebastes paucispinis", "Sebastes levis","Sebastes chlorostictus","Ophiodon elongatus",
              "Sebastes crocotulus","Sebastes rufus")

raster.biomass.all <- ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold")) +
  ggtitle("Biomass")

ggsave(raster.biomass.all, filename = here("Figs/fig_raster_biomass_all.png"),height = fig.height, width = fig.width)

raster.biomass.select <- ggplot(filter(boot.summ.sample.all,sciName %in% main.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 3) +  
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold")) +
  ggtitle("Biomass")

ggsave(raster.biomass.select, filename = here("Figs/fig_raster_biomass_select.png"),height = 5, width = 5)

raster.abundance.all <- ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"),
        strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = "none") +
  ggtitle("Abundance")

ggsave(raster.abundance.all, filename = here("Figs/fig_raster_abundance_all.png"),height = fig.height, width = fig.width)

raster.abundance.select <- ggplot(filter(boot.summ.sample.all,sciName %in% main.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 3) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"),
        strip.background.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = "none") +
  ggtitle("Abundance")

ggsave(raster.abundance.select, filename = here("Figs/fig_raster_abundance_select.png"),height = 5, width = 5)

raster.both.all <- plot_grid(raster.abundance.all, raster.biomass.all, nrow = 1)
ggsave(raster.both.all, filename = here("Figs/fig_raster_both_all.png"),height = 8, width = 10)

raster.both.select <- plot_grid(raster.abundance.select, raster.biomass.select, nrow = 1)
ggsave(raster.both.select, filename = here("Figs/fig_raster_both_select.png"),height = 4, width = 10)
```

```{r ALL_bootstrap_samples}
boot.samples.all <- bind_rows(boot.samples.rov, boot.samples.sub) %>% 
  ungroup() %>% 
  mutate(sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus"))

# Footprint data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "The Footprint"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_footprint.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "The Footprint"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_footprint.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_footprint.png"), height = 5, width = 12)

# Piggy Bank data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "Piggy Bank"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "Piggy Bank"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_piggy.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "Piggy Bank"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "Piggy Bank"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_piggy.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_piggy.png"), height = 5, width = 15)
```

```{r SampleSummary}
sample.summ <- boot.data.all %>% 
  select(platform, site, stratum, dive_name, distance, area) %>% 
  distinct() %>% 
  group_by(platform, site, stratum) %>% 
  summarise(
    n_samples = n(),
    distance  = sum(distance)/1000,
    area      = sum(area)*1e-6) %>% 
  mutate(
    stratum.name = case_when(
      stratum == "(-100,0]" ~ "<100 m",
      stratum == "(-200,-100]" ~ "100-200 m",
      stratum == "(-300,-200]" ~ "200-300 m",
      stratum == "(-400,-300]" ~ "300-400 m",
      TRUE ~ "All")) %>% 
  select(Vehicle = platform, Site = site, Stratum = stratum.name, 
         Samples = n_samples, Distance = distance, Area = area)

# Summarize transect duration and distance for the ROV
tx.summ.rov <- nav.rov %>% 
  group_by(dive_name) %>% 
  summarise(
    distance = sum(disp),
    duration = as.numeric(difftime(max(date_time),min(date_time),units = "mins"))) %>% 
  mutate(platform = "ROV")
  
# Site totals of transects, distance, area and depth range for each vehicle
tx.summ.site <- nav.rov.summ %>%
  bind_rows(nav.sub.summ) %>% 
  # bind_rows(nav.auv.summ) %>% 
  group_by(platform,site) %>% 
  summarise(n = sum(n.tx),
            D = sum(distance)/1000,
            A = sum(survey_area)*1e-6,
            depth.min = min(depth.min),
            depth.max = max(depth.max))

# Site totals of transects, distance, area and depth range for each vehicle
tx.summ.all <- tx.summ.site %>%
  group_by(platform) %>% 
  summarise(n = sum(n),
            D = sum(D),
            A = sum(A),
            depth.min = min(depth.min),
            depth.max = max(depth.max))
```

```{r ObsSummary}
# Combine summaries from each vehicle
obs.all.summ <- obs.rov.summ %>%
  left_join(obs.sub.summ) %>% 
  replace_na(list(nROV = 0, nSUB = 0)) %>% 
  # left_join(obs.auv.summ) %>% 
  mutate(nGrand = nROV + nSUB) %>% 
  mutate(pctGrand = nGrand/sum(.$nGrand)*100) %>% 
  arrange(desc(pctGrand), sciName) %>% 
  rename(
      "Scientific name" = sciName,
      "Common name"     = commonName,
      "$N_R$"             = nROV,
      "$\\%_R$"           = pctROV,
      "$N_S$"             = nSUB,
      "$\\%_S$"           = pctSUB,
      "$N_G$"             = nGrand,
      "$\\%_G$"           = pctGrand)

```

**Estimates of groundfish biomass, abundance, and diversity using different optical sampling methods** 

Kevin L. Stierhoff^1^, Mary M. Yoklavich^2^, and M. Elizabeth Clarke^3^, Jeff Anderson^4^, Erica L. Fruh^3^, Thomas E. Laidig^2^, Scott A. Mau^1^, David W. Murfin^1^, Abigail Powell^3^, Jeremy C. Taylor^4^, Diana L. Watters^2^  

**Order of authorship is presently: PIs, followed by technical staff (in ABC order). Please suggest additions, subtractions, and/or changes to the order.**  

^1^Fisheries Resources Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
8901 La Jolla Shores Drive
La Jolla, CA 92037, USA

^2^Fisheries Ecology Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
110 McAllister Way  
Santa Cruz, CA 95060, USA

^3^Office of the Science Director  
Northwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
2725 Montlake Boulevard East  
Seattle, WA 98112, USA  

^4^Coral Reef Ecology Division  
Pacific Islands Fisheries Science Center  
NOAA-National Marine Fisheries Service  
1845 Wasp Boulevard  
Honolulu, HI 96818  

Draft date: `r format(Sys.time(), "%d %B %Y")`

\newpage

# Abstract  

**[To Do last]**

\newpage  

# Introduction  

Many managed groundfish stocks on the U.S. west coast inhabit high-relief rocky areas that are inaccessible to traditional net-based survey methods (e.g., swept-area benthic trawls). Several species, such as cowcod (_Sebastes levis_) and yelloweye rockfish (_S. ruberrimus_), are strongly associated with these untrawlable habitats, have populations at various levels of depletion, and occupy habitats that have incurred substantial impacts from mobile fishing gear [@Love2006a; @Yoklavich2007]. Since much of the continental shelf and upper slope are closed to fishing, effective, non-lethal, and non-destructive fishery-independent monitoring tools, whether optical, acoustical, or some combination of both, are required to assess populations of depleted or vulnerable groundfish species living in these untrawlable habitats while minimizing impacts on their habitats. 

**[MORE]**

The goal of this study was to compare population estimates of ecologically and commercially important groundfishes in the southern CA measured using various optical survey tools. Specifically, a SUB, ROV, and AUV was used to: 1) identify, count, and measure rockfishes (_Sebastes_ spp.; both common and rare, large- and small-bodied, and semi-pelagic and highly demersal), lingcod (_Ophiodon elongatus_), thornyheads (_Sebastolobus_ sp.), and Pacific hake (_Merluccius productus_); 2) estimate the density, abundance, and biomass (and associated precision) for these taxa; and 3) estimate diversity within a prescribed study area. **[MORE]**  

# Methods  
## Survey area  
Underwater surveys of demersal fishes and their seabed habitats were conducted on two rocky banks - The Footprint and Piggy Bank - off southern California (**Figure 1**). The study site is located inside the State and Federal Footprint Marine Reserves, offshore of Santa Cruz Island, inside the Channel Islands National Marine Sanctuary. Piggy Bank is about 30 km^2^ in area, ranging in depth from 275 to 900 m; The Footprint is about 10 km^2^ in area, ranging in depth from 80 to 500 m. High-resolution bathymetry and broad-scale seabed classification from multibeam echosounder backscatter data were available prior to our surveys (Dartnell et al. 2005). Each bank was stratified into 100-m depth strata down to 400 m. The total area of each stratum was estimated using using GIS (ArcMap version 9.3; Esri, Inc.) and used to estimate total biomass and abundance from estimates of fish density. 

## Survey design  
Visual surveys were conducted during daylight hours (~06:30 to 17:00 h PST) using a human-occupied submersible (SUB; _Dual DeepWorker_, Nuytco) deployed from the F/V _Velero IV_ between 21 and 30 September 2011; using a remotely operated vehicle (ROV; _Phantom DS4_, Deep Ocean Exploration and Research) deployed from the F/V _Outer Limits_ during four legs between 21 September and 8 December 2011 (Leg 1: 21-22 September; Leg 2: 4 October; Leg 3: 12-13 October; and Leg 4: 4-8 December; and using an autonomous underwater vehicle (AUV; _Lucille_, SeaBED) between **21 and 30 September 2011 (check dates)** aboard the NOAA Vessel _Shearwater_. 

The densities of target species were estimated by each vehicle using strip transect sampling. For the SUB and ROV surveys, each bank was stratified into four 100-m depth bins between 0 and 400 m. Within each depth stratum, transect locations were randomly selected and oriented approximately parallel to isobaths to avoid sampling across multiple strata. Transects were either of fixed duration (~15 min, SUB) or distance (~500 m, ROV). On occasion, ROV transects spanned multiple depth strata, which were post-stratified into multiple transects; only transects greater than 200 m-long were included in the analysis. Additional SUB transects were allocated to the 0-100 m depth strata since earlier studies indicated relatively higher groundfish diversity, species richness, or both at those depths. For the AUV survey, a 250 x 250 m grid was superimposed on the survey area, then each grid cell was assigned to one of three regions: Piggy Bank, The Footprint, and the deeper flank around The Footprint. Within each region, cells were randomly selected and sampled following a pattern of five 200-m long transects connected by four 25-m long (total transect distance of 1.1 km) at a height of approximately 3.5-4 m above the seabed. The analysis included only areas sampled by all three vehicles, which excluded some transects conducted by the AUV in the large area of soft sediment in the northeast section of the study area. 

## Survey vehicles  
### Human-occupied submersible  
An on-board pilot operated the SUB along planned transects. The location of the SUB above the seabed was estimated using a USBL (TrackLink 5000HA; LinkQuest) and differential global positioning system (dGPS, **Make and Model, if known**) interfaced with a GIS, which was used by a navigator aboard the support vessel to guide the path of the SUB. An experienced scientist identified all observed fishes and estimated their size. Video was also recorded from two high-definition (HD; **720 or 1080 i/p**), three-color video cameras (**Make and Model, if known**) mounted at 45^$\circ$^ below horizontal on the starboard side of the SUB: one positioned in the same direction and field of view as the observer and the other camera located below the observer's field of view to record fishes in the area closest to the SUB that may not have been seen by the observer. Camera times were synchronized to the GPS clock; observations from the scientist were recorded on the audio track of the video recordings and later reviewed in the laboratory. Paired lasers spaced 20-cm apart on either side of the main video camera were used for reference to estimate fish size. A DVL (**using speed, or dead reckoning between x/y/z estimates**) and ring-laser gyrocompass (**Make and Model, if known**) attached to the outside of the submersible were used to estimate distance. Temperature, salinity, depth, and dissolved oxygen (DO) were measured using a CTD (SBE-19, Seabird) and oxygen sensor **(Make and Model, if known)**. All data were time-stamped and logged synchronously every 3-s using integrated navigation software (WinFrog, Fugro Pelagos).  

### Remotely operated vehicle  
A pilot aboard the vessel operated the ROV along planned transect routes. The location of the ROV above the seabed was estimated using a USBL (TrackLink 5000HA; LinkQuest) and dGPS (dGPS MAX, CSI Wireless). Video was recorded from a single standard definition (NTSC; 720 pixels x 470 lines of resolution) color video camera (Pegasus, Insite Pacific) mounted on a variable-pitch tray, and later used for enumerating fishes and describing seabed characteristics. High-resolution (3 megapixel) images were collected haphazardly using a digital still camera (Scorpio, Insite Pacific) mounted on the same tray and used to aid the identification and measurement of fishes observed in video recordings. The altitude and speed of the ROV was measured using a Doppler velocity log (DVL, 1200 kHz Workhorse Navigator, Teledyne RD Instruments) and used to estimate transect distance and width. Reference lasers spaced 20 and 60 cm-apart were used to estimate fish size. Temperature, salinity, and DO were measured during each transect using a CTD (Citadel CTD-ES, Teledyne RD Instruments) and optode (Model 3930, Aanderaa, Inc.). All data were time-stamped and logged synchronously using integrated navigation software (Winfrog, Fugro Pelagos). 

### Autonomous underwater vehicle  
The AUV navigated along its programmed route using a DVL (1200 kHz Workhorse Navigator; Teledyne RD Instruments), gyrocompass/inertial motion sensor (iXSea, OCTANS), and the GPS coordinates acquired while on the surface at the dive launch point. The actual location of the AUV above the seabed was estimated from the support vessel using a USBL acoustic tracking system (TrackLink 1500, LinkQuest, Inc.) and dGPS (**Model, Manufacturer??**). The depth of the AUV was determined using a pressure sensor (**Model?**, Paroscientific) and temperature, salinity, **other?** were measured using a CTD (Model 49 FastCat, Sea-Bird). Stereo images were collected every 10 s using a calibrated, downward-facing stereo camera pair (5-megapixel, 12-bit dynamic range GigE machine vision cameras; Prosilica) synced to a strobe (**[model important?]**); a third GigE camera was angled forward at and angle of 30^$\circ$^strobe synced with the downward-facing stereo cameras. All data were time-stamped and logged synchronously using **[list software, if used]**.

## Visual analysis  
All target species observed by each vehicle were identified to the lowest possible taxon, counted, and measured. The identification of fishes observed in SUB and ROV video was aided by audio annotations (SUB) and still images (ROV). The identification of fishes observed in the non-overlapping, color-corrected stereo images from the downward-facing AUV camera was aided by photos from the third angled camera. When fishes could not be identified to species species level, they were identified to the genus (e.g., unidentified rockfish, _Sebastes_ spp.; or unidentified thornyhead, _Sebastolobus_ spp.) or subgenus level (e.g., rosy-group rockfish, _Sebastomus_), if possible. Lengths of fishes observed by the AUV were estimated to 1 cm resolution using custom stereo image analysis software (Sebastes, NWFSC). Lengths of fishes observed from the SUB and ROV were estimated to the nearest 5- or 10-cm using calibrated parallel lasers for reference. When fish were oriented normal to the camera lens and near the reference lasers, length of fishes observed by the ROV were to the nearest 1 cm using image analysis software (ImageJ, National Institute of Health).

## Sampling effort
The abundance and biomass of observed fishes was calculated using the area of each transect. For the SUB, transect distance was estimated every **3 s** using **speed/distance** measured by the **DVL/gyrocompass**; transect width was estimated **every X interval** by the on-board scientist using the combination of: 1) a hand-held sonar, 2) the SUB's sonar **[What is this? Was it used?]**, and 3) a crossing laser set to intersect the parallel laser at **3 m** from the observer when the submersible was **1 m** above the seabed; and transect area was estimated as the summed product of transect distance and width estimates. For the ROV, transect distance was estimated from ROV speed, transect width was estimated from the ROV altitude and the optical properties of the video cameras, and transect area was estimated as the summed product of distance and transect width estimates measured every 2-s [@Stierhoff2016]. For the AUV, transect area was estimated **a)** as the sum of the area of non-overlapping stereo image pairs estimated using custom software (_Sebastes_, NWFSC) or **b)** altitude off the bottom and the specified camera field of view **(Please choose which method)**. Each vehicle aimed to survey the planned transects at a constant speed and altitude above the seabed. Transect segments during which the seabed was not clearly visible were removed from the analysis.  

## Seabed characterization  
Primary and secondary geologic seabed characteristics were described at the beginning of the transect, at the time of each fish observation, and also at any transition between different seabed types, allowing for the description of associations between each species and different seabed types and also the estimation of area searched within each seabed type. Both the primary (>50% of the seabed within the strip area) and secondary (20-50% of the seabed within the strip area) seabed characteristics were described. Seabed classifications generally followed the classification scheme of Greene et al. [-@Greene1999], and were based on particle size: mud (clay to silt; <0.06 mm), sand (0.06-2 mm), pebble (2-64 mm), cobble (64-256 mm), boulder (0.25-3 m), low-complexity (<0.25 m pavement) reef, and highcomplexity (>0.25 m) reef. The term "complexity" refers to the presence and the size of cracks and crevices in the seabed that may provide refuge to rockfishes. Based on the size and shape of these features, low-complexity and high-complexity reef probably serve the same ecological function as sand/pebble and cobble/boulder, respectively. The area of each substratum type in a transect was estimated as the product of the transect width and the distance between seabed types for the SUB and ROV, or as the total area of images containing similar seabed types for the AUV.  

## Population estimation
For each species, abundance (_N_) and biomass (_M_) was estimated using the strip transect sampling method [@Buckland2001]. For each sample (_i_, transect or grid), numeric density (_d~N~_) was calculated as: $d_{N_i} = n_i/a_i$, where _n_ is the number of individuals observed and _a_ is the sample area. Abundance within each stratum (_j_) was then calculated as: $N_j = d_{N_i} * A_j$, where _A_ is the stratum area. For each sample, biomass density (_d~M~_) was also calculated as: $d_{M_i} = (m_i * n_i) / A_i$, where _m_ is the total biomass of individuals observed in the sample, calculated as the sum of individual biomasses estimated from total length using published length-to-weight relationships (see **Table 1**). Biomass within each stratum was then calculated as: $M_j = d_{M_i} * A_j$. Biomasses for fish assigned to 10-cm length bins from ROV surveys, the midpoint of the size class was used to estimate biomass (e.g., 5 cm for the 0-10 cm class). For species where the length-to-weight relationship was unknown (e.g., dwarf-red rockfish, _S. rufinanus_; rosethorn rockfish, _S. simulator_; and pygmy rockfish, _S. wilsoni_), coefficients for closely related species were used [see @Hyde2007]. Coefficients for vermilion rockfish (_S. miniatus_) were used for sunset rockfish [_S. crocotulus_; @Hyde2008a]. Since many of the unidentified rockfishes were of the semi-pelagic, aggregating variety, coefficients were used from squarespot rockfishes (_S. hopkinsi_, the most commonly identified species in this study with similar behavior and vertical distribution). For unidentified rosy-group rockfishes (_Sebastomus sp._), coefficients were used from swordspine rockfish (_S. ensifer_, the most commonly identified _Sebastomus_ species observed in this study). Mean, CV of the mean, and 95%-quantile confidence intervals for abundance and biomass were estimated using a non-parametric bootstrap of `r n.boot` samples [@Efron1993].  

## Biodiversity estimates  
**[ROV]** Species richness ($S$); species diversity (Shannon $H$), and Simpson's lambda ($\lambda$) were computed for each transect and then summarized within each depth stratum and at each bank. The expected species richness (rarefaction) in a particular sample from that stratum was estimated and arefaction curves were generated for each bank using the. All biodiversity estimates were generated using the _vegan_ package [@Oksanen2012] in R [@RCoreTeam2017].  

# Results  
## Survey effort  
Using the SUB, a total of `r tx.summ.all$n[tx.summ.all$platform == "SUB"]` transects were conducted between `r round(tx.summ.all$depth.min[tx.summ.all$platform == "SUB"],0)` and `r round(tx.summ.all$depth.max[tx.summ.all$platform == "SUB"],0)` m on The Footprint (n = `r tx.summ.site$n[tx.summ.site$platform == "SUB" & tx.summ.site$site == "The Footprint"]` transects) and Piggy Bank (n = `r tx.summ.site$n[tx.summ.site$platform == "SUB" & tx.summ.site$site == "Piggy Bank"]` transects) covering a total distance of `r sprintf("%.1f",tx.summ.all$D[tx.summ.all$platform == "SUB"])` km and a total area of `r sprintf("%.4f",tx.summ.all$A[tx.summ.all$platform == "SUB"])` km^2^ (**Table 2**). Mean transect length was `r sprintf("%.0f",mean(tx.summ.sub$distance))` m (SE = `r sprintf("%.0f",sd(tx.summ.sub$distance)/sqrt(nrow(tx.summ.sub)))` m). Transect duration ranged from `r sprintf("%.0f",min(tx.summ.sub$duration))` to `r sprintf("%.0f",max(tx.summ.sub$duration))` min (mean = `r sprintf("%.0f",mean(tx.summ.sub$duration))` min, SE = `r sprintf("%.1f",sd(tx.summ.sub$duration)/sqrt(nrow(tx.summ.sub)))` min). 

Using the ROV, a total of `r tx.summ.all$n[tx.summ.all$platform == "ROV"]` transects were conducted between `r round(tx.summ.all$depth.min[tx.summ.all$platform == "ROV"],0)` and `r round(tx.summ.all$depth.max[tx.summ.all$platform == "ROV"],0)` m on The Footprint (n = `r tx.summ.site$n[tx.summ.site$platform == "ROV" & tx.summ.site$site == "The Footprint"]` transects) and Piggy Bank (n = `r tx.summ.site$n[tx.summ.site$platform == "ROV" & tx.summ.site$site == "Piggy Bank"]` transects) covering a total distance of `r sprintf("%.1f",tx.summ.all$D[tx.summ.all$platform == "ROV"])` km and a total area of `r sprintf("%.4f",tx.summ.all$A[tx.summ.all$platform == "ROV"])` km^2^ (**Table 2**). Mean transect length was `r sprintf("%.0f",mean(tx.summ.rov$distance))` m (SE = `r sprintf("%.0f",sd(tx.summ.rov$distance)/sqrt(nrow(tx.summ.rov)))` m). Transect duration ranged from `r sprintf("%.0f",min(tx.summ.rov$duration))` to `r sprintf("%.0f",max(tx.summ.rov$duration))` min (mean = `r sprintf("%.0f",mean(tx.summ.rov$duration))` min, SE = `r sprintf("%.1f",sd(tx.summ.rov$duration)/sqrt(nrow(tx.summ.rov)))` min). 

_**[AUV, from an early report]** `Twenty-seven` cells were sampled throughout the survey area covering a total of `70,006` m^2^ and ranging in depth from `99` to `487` m: `13` on The Footprint, `six` on the flank of Footprint, and `eight` on Piggy Bank (**Table X**).  `Seventeen` of the `27` cells were entirely within one 100-m depth stratum, while `ten` cells spanned two 100 m strata. The range of depths surveyed within a cell varied from 10 m to 83 m. Habitats encountered ranged from high-relief rock ridge to mud/sand bottom (**Figure X**)._ 

## Seabed composition  
_**[AUV, from an early report]** Cells surveyed on the top of Piggy Bank (200-300 m) contained rocky ridge substrate (30%), mud (33%) and similar amounts of boulder and cobble (17 and 19%, respectively). With increasing depth, the percentage of mud and cobble substrates increased. The top two depth strata on the Footprint were primarily cobble and boulder, with sand and rock ridge increasing with depth (**Figure X**.  Mud was the primary substrate observed in all depth strata on the flank of the Footprint (86, 99 and 97%)._

## Length frequency composition 

**[GENERATE LENGTH FREQUENCY PLOTS FOR EACH SURVEY METHOD]**  

Examine whether differences in length distributions contribute to any differences in biomass or abundance.

## Abundance and biomass estimates  
### SUB  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**

A total of `25,085` individuals from `29` _Sebastes_ species were observed, which as a group comprised ~`80`% of the total fishes encountered. Unidentified rockfishes (_Sebastes_ spp.) comprised Only `0.5`% of all rockfishes (excluding some young-of-year juveniles) to species or species group (i.e., Sebastomus). Dwarf rockfish species were most numerous and dominated by _S. hopkinsi_ (`20`% of all rockfishes), _S. semicinctus_ (`17`% of all rockfishes), _S. jordani_ (`12`% of all rockfishes), _S. wilsoni_ (pygmy `7`%), and _S. ensifer_ (`7`%). Of particular interest were the observations of `147` _S. paucispinis_ (`0.7`%), `38` _S. levis_ (`0.2`%), _S. miniatus_ (`0.1`%), , _S. eos_ (<`0.1`%), and `4`_S. gilli_ (<`0.1`%; a rare and elusive species). Among non-rockfish species, Pacific hake (mostly juveniles; `4`%) were relatively abundant and lingcod were not (`0.2`%). 
A total of `414,975` fishes and `60.3` mt of fish biomass on Piggy Bank (not including unidentified adult orjuvenile rockfishes nor sharpchin rockfish (_S. zacentrus_) because meaningful length-weight relationships were not available) (**Table 5**). _Sebastes jordani_ ($N$ = `163,022`), _S. rufus_ ($N$ = `116,040`), and _S. diploproa_ (64,489 individuals) were most abundant and comprised the greatest biomass (`18`%, `53`%, and `12`% of total biomass, respectively) on the Piggy Bank.  

A total of `1,953,844` fishes representing `147.6` mt of fish biomass (excluding biomass estimates of unidentified rockfishes and sharpchin rockfish, as noted above) on The Footprint. Three dwarf species of rockfishes (_S. jordani_, $N$ = `339,855`); _S. semicinctus_, $N$ = `302,275`; and _Sebastomus_ (likely _S. ensifer_), $N$ = `268,618`) were most abundant but together comprised only `27`% of the total biomass. Among the large-bodied species **[these are "large-bodied"?]**, _S. diploproa_ ($N$ = `221,329`, $B$ = `14.5` mt), juvenile _M. productus_ ($N$ = `164,087`, $B$ = `19.5` mt), and _S. rufus_ ($N$ = `68,629`, $B$ = `14.9` mt) were relatively abundant. _Sebastes levis_ ($N$ = `4,325`, $B$ = `4.2` mt) comprised only `0.2`% of total abundance and `2.8`% of total biomass on The Footprint. _Sebastes paucispinis_ ($N$ = `13,342`, $B$ = `8.6` mt) comprised `0.7`% of total abundance and `5.8`% of total biomass at this site.  

Combining estimates from both banks, a total of `2,368,819` fishes with a biomass of `207.9` mt (**Table 7**). _Sebastes jordani_, _S. semicinctus_, and _S. diploproa_ were most abundant overall. Juvenile _M. productus_, _S. rufus_, _S. ensifer_, and _S. hopkinsi_ were also abundant. If _S. ensifer_ and _Sebastomus_ sp. (which were likely _S. ensifer_) were combined, the abundance would be second only to _S. jordani_. Four species (_S. rufus_, `23`% of total biomass; _S. jordani_, 15%; _S. diploproa_, 10%; and juvenile _M. productus_, 10%) comprised over `58`% of the total biomass in the entire study area. 

The coefficient of variation (CV) ranged from `0.12` to `0.84` for estimates of total abundance and from `0.15` to `0.92` for estimates of total biomass over both banks combined (**Table 7**). The CV for total abundance was `0.30` for _S. levis_, `0.26` for _S. paucispinis_, and `0.32` for _S. rufus_; the CV for total biomass was `0.44` for _S. levis_, `0.27` for _S. paucispinis_, and `0.36` for _S. rufus_.  

### ROV 
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
Over `37,700` individuals from thirty-three _Sebastes_ species, _O. elongatus_, and _M. productus_ were counted during this survey. The groundfish community throughout the survey area was numerically dominated by four small, semi-pelagic and aggregating species (squarespot rockfish, _S. hopkinsi_; swordspine rockfish, _S. ensifer_; halfbanded rockfish, _S. semicinctus_; and shortbelly rockfish, _S. jordani_) that comprised ~`80`% of all rockfishes (**Table 1**). Among non-aggregating species, bank (_S. rufus_, `5`%) and swordspine rockfishes (_S. simulator_, `1.5`%) were commonly observed. _Sebastes rufus_ (n = `1,883`) was the most abundant target species. In comparison, _S. paucispinis_ (n = `232`), _S. levis_ (n = `62`), and _S. crocotulus_ (n = `16`) were much less abundant (**Table X**).  

Overall abundance and biomass estimates were calculated for `33` species of rockfish, three unidentified rockfish groups, _O. elongatus_, and _M. productus_ (**Table 3**). Estimates of abundance and biomass of each of these species within each depth strata on each bank is provided in **Appendix 3**  
Approximately 2.3 million rockfishes, _O. elongatus_, and _M. productus_ were observed between 100-400 m on both banks (**Table 3**). _Sebastes ensifer_ (`619,114`) was the most abundant species, which was slightly more abundant than _S. hopkinsi_ (`566,753`). Among target species, _S. rufus_ (`177,981`) were highly abundant. _Sebastes paucispinis_ (`12,624`), _S. chlorostictus_ (`5,206`), and _S. levis_ (`4,109`) were much less abundant than those smaller, aggregating species (**Table 3**).  

Total biomass of all species was approximately `287` metric tons (mt; 1 mt = 1,000 kg) in the same area (**Table 3**). Nearly `62`% of the total fish biomass was comprised of the combination of _S. rufus_ (`60` mt) and small, aggregating species (_S. hopkinsi_, _S. ensifer_, _S. jordan_i; `118` mt). The other target species, _S. paucispinis_ (`16.2` mt), _S. levis_ (`7.5` mt), and _S. chlorostictus_ (`2.5` mt) had relatively lower biomass.  

The overall coefficient of variation (CV) for abundance (range = `0.12`-`1.00`) and biomass estimates (range = `0.15`-`1.01`) varied greatly among all species (**Table 3**). Species whose abundance and biomass estimates with high CVs (i.e., greater than ~`0.50`) were those that were either rarely encountered (e.g., _S. crameri_, _S. lentiginosus_, _S. rufinanus_, and _S. serranoides_) or whose densities varied greatly with depth (e.g., _S. hopkinsi_, _S. jordani_, _S. ovalis_, and _S. semicinctus_, which were densely aggregated in the shallower strata of the Footprint and almost entirely absent on Piggy Bank). Among target species, the CV values were relatively low and ranged from `0.28`-`0.46` and `0.26`-`0.44` for abundance and biomass, respectively. For _S. levis_, the overall CV values of abundance and biomass were quite low (`0.28` and `0.30`, respectively), and probably reflect the relatively even distribution of this species among transects on the Footprint and their total absence from any transects on Piggy Bank (**Figure 2**). _Sebastes rufus_ also had very low CV values (`0.26` for both abundance and biomass), but in contrast to _S. levis_, was highly abundant in the deeper strata on both banks (**Fig. 2**). As expected, differences in the distribution of many species were apparent by depth and bank (**Fig. 2**). Small, more numerically abundant species (e.g., _S. ensifer_, _S. hopkinsi_, _S. semicinctus_, and _S. wilsoni_) were commonly encountered on the shallower (<200 m) portions of the Footprint. _Sebastes paucispinis_ and _S. levis_ were found almost exclusively on the Footprint. _Sebastes diploproa_, _S. rufus_, and _S. simulator_ were found throughout the deeper strata on both banks, and were the only species commonly observed on Piggy Bank.  

### AUV
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_A total of `21,228` fishes from `51` taxa were identified during the survey including `18` rockfish species (**Table X**). Rockfishes comprised `75`% of the fishes encountered, including groups of unidentified rockfish (_Sebastes_ spp., **X%**), rosy-group rockfishes (_Sebastomus_, **X%**), and thornyheads (_Sebastolobus_ sp., **X%**), and other species that could be identified to species (**X%**). Notable were observations of `11` cowcod (_S. levis_), 29 bocaccio (_S. paucispinis_) and one bronzespotted rockfish (_S. gilli_). In addition, `53` lingcod (_Ophiodon elongatus_), `19` Pacific hake (_Merluccius productus_) and `10` sablefish (_Anoplopoma fimbria_) were observed. Fish assemblages varied between depth strata and between the two banks. Twenty-nine taxa only occurred on the Footprint or along its Flank. Two species were observed on Piggy Bank only. _ 

## Biodiversity  
### SUB  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
Diversity (**or richness??**; measured as cumulative number of species in transects within a depth stratum, excluding groups), was highest on The Footprint in the 100-200 m (`23` species) and 200-300 m (`26` species) strata (**Table X**). Species richness ($S$) was lowest on Piggy Bank at both depth strata (`8` and `11` species in the 200-300 and 300-400 m strata, respectively).  

### ROV  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
Biodiversity also varied greatly by depth strata and bank (**Table 6**). The greatest number of species (richness = `15`) was observed in the 0-100 m depth stratum on the Footprint, and the fewest were observed in the 300-400 m stratum at Piggy Bank. The rarefied species richness (the number of species expected per number of samples) was greatest in the 300-400 m stratum at the Footprint, with all other strata having rarefied species richness between `3.5` and `5.1`. Neither of these richness parameters account for the abundance of different species so Shannon $H$ and Simpson $\lambda$, which do account for abundance differences, were also calculated. Again, the greatest diversity (both $H$ and $\lambda$, respectively) were observed in the 300-400 m stratum at the Footprint, but diversity was relatively uniform across all depth strata and banks. Biodiversity estimates for each transect is presented in **Appendix 4**.  

The species accumulation (rarefaction) curves from each bank have much different shapes (**Figure 9**). The curve for the Footprint rises steeply in the first few samples and begins to plateau after ~ **10** transects. The rarefaction curve at Piggy Bank increased at a slower rate and never reached an asymptote. Although there were fewer transects at Piggy Bank, the other diversity estimates corroborate the finding that there is less biodiversity at Piggy Bank compared to the Footprint.  

### AUV
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
Species richness (total species, excluding groups) was the highest in the 100-200 m stratum on the Footprint (N = 23 species) and in the 300-400 m stratum on the Flank (18 species, **Table x**). Species richness was lowest in all three strata on Piggy Bank (six species at 200-300 m, eight species at 300-400 m, and seven species at 400-500 m).

# Discussion  
## Survey effort 
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
The AUV was able to sample the deeper 400-500 m stratum on the flank of Footprint, and to provide fish and habitat information that was not available from the ROV or SUB (**The ROV could have sampled deeper but . 

## Abundance and biomass estimates
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**

### AUV  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
Species diversity was similar amongst all three methodologies showing greater species richness at the The Footprint and lower richness at Piggy Bank.  The ROV and the SUB included records of rockfish species not identified by the AUV.  This could be due to the fact that the cameras on the AUV are positioned downward, rather than forward facing, allowing fish directly in front of the unit to escape detection. Another possible reason could be the difficulty in identifying some rockfish species from the dorsal view.  The AUV detected comparable numbers of fishes, but the fish were identified to groupings (i.e. Unidentified rockfish, or Sebastomus) as opposed to species.

\newpage  

# Literature Cited

<div id = 'refs'></div>  

\newpage

# Tables  

**Table 1.** Coefficients used to convert total length (_TL_; cm) to weight (g) for biomass estimates.

```{r LengthWeightTable}
# Get species in study
lw_spp <- sort(unique(boot.data.rov$sciName))

# Subset and format table
lw_table <- lw.data %>%
  filter(sciName %in% lw_spp) %>% 
  rename(
      "Scientific name" = sciName,
      "Common name" = commonName,
      Sex = sex,
      Comment = comment) 

# Format and print L/W table
if (doc.type == "docx") {
  lw_table %>% 
    regulartable() %>% 
    italic(j = 1) %>%
    align(align = "center", part = "header") %>%
    autofit()
} else {
  lw_table %>% 
    rename(
      "$L_\\mathrm{max}$" = L_max,
      "$a$" = a,
      "$b$" = b) %>%
    kable(format = knitr.format,booktabs = T, escape = F,
          align = c("l","l","r","r","r","l","l","l"),
          digits = c(0,0,4,4,1,0,0,0)) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>%
    column_spec(1, italic = T)
}
```  

\newpage  

**Table 2** Number of samples, sampling distance (km), and sampling area (km^2^) for each vehicle, site, and depth stratum ("All" if sampling not stratified by depth; e.g., AUV).

```{r SampleSummaryTable}
# Format and print table of observations
if (doc.type == "docx") {
  sample.summ %>% 
    regulartable() %>% 
    align(align  = "center", part = "header") %>% 
    autofit()
} else {
  sample.summ %>% 
    kable(format      = knitr.format, booktabs = T, escape = F,
          align       = c("l","l","r","r","r","r"),
          digits      = c(0,0,0,0,2,4),
          format.args = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped", "condensed",
                                    "repeat_header", "scale_down"),
                  position = "center") %>% 
    collapse_rows(columns = c(1,2))
}
```

\newpage 

**Table 3.** Summary of observations from the ROV, SUB, AUV (**to be added later**), and All vehicles. **Data are presently sorted descending by % of all observations. We can sort by species name if preferred.**  

```{r ObsSummaryTable}
# Format and print table of observations
if (doc.type == "docx") {
  obs.all.summ %>% 
    regulartable() %>% 
    italic(j = 1) %>%
    add_header(`Scientific name`  = "",
               `Common name`  = "",
               "$N_R$" = "ROV", "$\\%_R$" = "ROV", 
               "$N_S$" = "SUB", "$\\%_S$" = "SUB", 
               "$N_G$" = "All", "$\\%_G$" = "All") %>% 
    merge_h(part = "header") %>% 
    align(align  = "center", part = "header") %>% 
    autofit()
} else {
  obs.all.summ %>% 
    kable(format      = knitr.format,booktabs = T, escape = F,
          align       = c("l","l","r","r","r","r","r","r"),
          digits      = c(0,0,0,1,0,1,0,1),
          format.args = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped", "condensed",
                                    "repeat_header"),
                  position = "center") %>% 
    column_spec(1, italic = T) %>% 
    add_header_above(c(" " = 2, "ROV" = 2, "SUB" = 2, "All" = 2)) 
}
```  

\newpage  

**Table 4.** Bootstrap estimates of abundance and biomass from the SUB. **Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummarySUB}
boot.summ.table <- boot.summ.sample.all %>% 
  left_join(select(spp, sciName, commonName)) %>% 
  select(sciName, commonName, everything(), -samples, -biom_cv_cut, -abund_cv_cut, -stratum_area) %>% 
  arrange(platform, desc(site), sciName) %>% 
  rename(`Scientific name`       = sciName,
         `Common name`           = commonName,
         Site                    = site,
         "Mean$_{N}$"            = abund.mean,
         "CV$_{N}$"              = abund.cv,
         "Lower CI$_{N, 95\\%}$" = abund.ci.low,
         "Upper CI$_{N, 95\\%}$" = abund.ci.hi,
         "Mean$_{M}$"            = biom.mean,
         "CV$_{M}$"              = biom.cv,
         "Lower CI$_{M, 95\\%}$" = biom.ci.low,
         "Upper CI$_{M, 95\\%}$" = biom.ci.hi) %>% 
  select(Site, everything())

# Select SUB results
boot.table.sub <- filter(boot.summ.table, platform == "SUB") %>% 
  select(-platform)

# Format and print bootstrap summary
if (doc.type == "docx") {
  boot.table.sub %>%
    regulartable() %>% 
    italic(j = 1) %>%
    add_header(
      `Scientific name`       = "",
      `Common name`           = "",
      Site                    = "",
      "Mean$_{N}$"            = "Abundance",
      "CV$_{N}$"              = "Abundance",
      "Lower CI$_{N, 95\\%}$" = "Abundance",
      "Upper CI$_{N, 95\\%}$" = "Abundance",
      "Mean$_{M}$"            = "Biomass",
      "CV$_{M}$"              = "Biomass",
      "Lower CI$_{M, 95\\%}$" = "Biomass",
      "Upper CI$_{M, 95\\%}$" = "Biomass") %>% 
    merge_h(part = "header") %>% 
    align(align = "center", part = "header") %>% 
    autofit()
} else {
  boot.table.sub %>% 
    kable(format          = knitr.format,booktabs = T, escape = F,
          align           = c("l","l","l",rep("r", 8)),
          digits          = c(0,0,0,rep(0,8)),
          format.args     = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>% 
    column_spec(2, italic = T) %>%
    collapse_rows(columns = c(1)) %>% 
    add_header_above(c(" " = 3, "Abundance" = 4, "Biomass" = 4)) 
}
```

\newpage  

**Table 4.** Bootstrap estimates of abundance and biomass from the ROV. **Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummaryROV}
# Select SUB results
boot.table.rov <- filter(boot.summ.table, platform == "ROV") %>% 
  select(-platform)

# Format and print bootstrap summary
if (doc.type == "docx") {
  boot.table.rov %>%
    regulartable() %>% 
    italic(j = 2) %>%
    add_header(
      "Site"                  = "",
      `Scientific name`       = "",
      `Common name`           = "",
      "Mean$_{N}$"            = "Abundance",
      "CV$_{N}$"              = "Abundance",
      "Lower CI$_{N, 95\\%}$" = "Abundance",
      "Upper CI$_{N, 95\\%}$" = "Abundance",
      "Mean$_{M}$"            = "Biomass",
      "CV$_{M}$"              = "Biomass",
      "Lower CI$_{M, 95\\%}$" = "Biomass",
      "Upper CI$_{M, 95\\%}$" = "Biomass") %>% 
    merge_h(part = "header") %>% 
    align(align = "center", part = "header") %>% 
    autofit()
} else {
  boot.table.rov %>% 
    kable(format          = knitr.format,booktabs = T, escape = F,
          align           = c("l","l","l",rep("r", 8)),
          digits          = c(0,0,0,rep(0,8)),
          format.args     = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>% 
    column_spec(2, italic = T) %>%
    collapse_rows(columns = c(1)) %>% 
    add_header_above(c(" " = 3, "Abundance" = 4, "Biomass" = 4)) 
}
```  

\newpage  

**Table 5.** Bootstrap estimates of abundance and biomass from the AUV. **[ADD]. Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummaryAUV}

```

\newpage 

# Figures  

```{r SurveyDomain,fig.align='center',out.width='7in'}
include_graphics(here("Figs/fig_survey_map.png"))
```  

**Figure 1.** Map of the survey area at The Footprint and Piggy Bank, indicating the extent of the sampling area (dashed box), depth strata sampled by the ROV and SUB (blue polygons), the 250 x 250 m grid sampled by the AUV, and transect locations (colored lines; blue = ROV, green = SUB, and orange = AUV). **NOTE: I created a fictitious fishnet for the AUV until I am provided the actual shapefile used to plan the survey.**

\newpage

```{r RasterAllCV,fig.align='center',out.width='7in'}
include_graphics(here("Figs/fig_raster_both_all.png"))
```  

**Figure 2.** Mean abundance (_N_; left), biomass (_M_, kg; right), and coefficient of variation (CV, %; fill color) of all species encountered by at least one vehicle and across all sampling strata. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV).

\newpage

```{r RasterSelectCV,fig.align='center',out.width='7in'}
include_graphics(here("Figs/fig_raster_both_select.png"))
```  

**Figure 3.** Mean abundance (_N_; left), biomass (_M_, kg; right), and coefficient of variation (CV, %; fill color) of select species across all sampling strata. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV).  

\newpage
\blandscape

```{r BootstrapBothFootprint,fig.align='center',out.width='9in'}
include_graphics(here("Figs/fig_density_both_footprint.png"))
```  

**Figure 4.**  Distribution of mean abundance (_N_; top) and biomass (_M_, kg; bottom) estimates of select species at The Footprint. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV). **[selected these species for exploration; can add/remove very easily, but chose these particulary interesting species initially]**

\newpage

```{r BootstrapBothPiggy,fig.align='center',out.width='9in'}
include_graphics(here("Figs/fig_density_both_piggy.png"))
```  

**Figure 5.** Distribution of mean abundance (_N_; top) and biomass (_M_, kg; bottom) estimates of select species at Piggy Bank. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV). **[selected these species for exploration as above; however, not all of the species in The Footprint figure were observed at Piggy Bank]**

\elandscape