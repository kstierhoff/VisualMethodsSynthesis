---
bibliography: bib/ast_bib.bib
csl: csl/ices-journal-of-marine-science.csl
header-includes: \usepackage{array} \usepackage{booktabs} \usepackage{calc} \usepackage{caption}
  \usepackage{colortbl} \usepackage{float} \usepackage{graphicx} \usepackage{hhline} \usepackage{isomath}
  \usepackage{longtable} \usepackage{multirow} \usepackage{pdflscape} \usepackage{siunitx} \usepackage[table]{xcolor} 
  \usepackage{tabu} \usepackage{tabularx} \usepackage{textcomp} \usepackage{threeparttable} \usepackage{upgreek}
  \usepackage{wrapfig} \newcommand{\blandscape}{\begin{landscape}} \newcommand{\elandscape}{\end{landscape}}
output:
  pdf_document:
    fig_caption: no
  html_document: default
  word_document:
    reference_docx: template/report_template_Rmarkdown.docx
---  

```{r LoadLibraries, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
# List packages required to run the script
pkgs <- c("sf","tidyverse","knitr","swfscMisc","lubridate","here","boot",
          "maps","readxl","maptools","png","mapdata","flextable",
          "cowplot","devtools","kableExtra","RODBC","pander","DBI",
          "rnaturalearth","odbc")
# Install and load all CRAN packages provided from a character vector
load_pkgs = function(pkgs){
  new_pkgs = pkgs[!(pkgs %in% installed.packages()[ ,'Package'])]
  if (length(new_pkgs) > 0) install.packages(new_pkgs)
  invisible(lapply(pkgs,function(x)
    suppressPackageStartupMessages(library(x,character.only = TRUE))))
}
# Load packages
load_pkgs(pkgs)

# Install and load surveyR package from github
if ("surveyR" %in% installed.packages()[ ,'Package'] == F) {
  install_github("kstierhoff/surveyR")
}
# Load surveyR
library(surveyR)

# Install and load slipper package from github
if ("slipper" %in% installed.packages()[ ,'Package'] == F) {
  install_github("jtleek/slipper")
}
# Load patchwork
library(slipper)

# determines method of table generation (whether kable or pander) for best formatting
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
if (is.null(doc.type)) {doc.type <- "html"}

# global knitr chunk options
knitr::opts_chunk$set(echo = F, warning = F, message = F, dev = "png", 
                      dev.args = list(type = "cairo"), dpi = 150)

# set global knitr options
options(knitr.kable.NA = '')

# determine global knitr table format
if (doc.type == "latex") {
  knitr.format <- "latex"
} else {
  knitr.format <- "html" 
}

# # global pander options
# panderOptions('table.style','rmarkdown'); panderOptions('table.split.table', Inf);
# panderOptions('digits', 6); panderOptions('round', 6); panderOptions('keep.trailing.zeros', TRUE);
# panderOptions('missing', "")

# processing instructions (TRUE/FALSE)
import.data <- F # Download data from SQL database
sub.source  <- "Access" # Or DSN if getting from database directly
save.figs   <- T # Draw plots and maps, or use existing
do.boot     <- F # Conduct bootstrap resampling
get.sf      <- F # Download costline data
```  

```{r ImportSurveyData}
strata.area <- read_csv(here("Data/strata_area.csv")) %>% 
  rename(site = site_name,
         stratum = depth_stratum) %>% 
  mutate(stratum_area = area*1e6) %>% 
  select(-area)
# Summarize strata area by site
site.area <- strata.area %>% 
  group_by(site) %>% 
  summarize(stratum_area = sum(stratum_area))
```


```{r ImportROV}
if (import.data) {
  channel = odbcConnect(dsn = 'ROV2')
  nav.rov              <- sqlQuery(channel,"
            SELECT dbo.tbl_NAV.*, dbo.tbl_LOGS.survey_number, dbo.tbl_LOGS.site_general
            FROM dbo.tbl_LOGS INNER JOIN dbo.tbl_NAV ON dbo.tbl_LOGS.dive_name = dbo.tbl_NAV.dive_name
            WHERE (((dbo.tbl_LOGS.survey_number)=40));")
  logs.rov             <- sqlFetch(channel, "dbo.tbl_LOGS")
  events.rov           <- sqlFetch(channel, "dbo.tbl_EVENTS") 
  video.obs.rov        <- sqlFetch(channel, "dbo.tbl_VIDEO_OBS")
  photo.info.rov       <- sqlFetch(channel, "dbo.tbl_PHOTO_INFO")
  photo.obs.rov        <- sqlFetch(channel, "dbo.tbl_PHOTO_OBS")
  lengths.rov          <- sqlFetch(channel, "dbo.tbl_FISH_LENGTHS")
  spp                  <- sqlFetch(channel, "dbo.tlu_SPECIES_CODES")
  size.codes           <- sqlFetch(channel, "dbo.tlu_SIZE_CODES")
  lw.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_WEIGHT_DATA")
  la.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_AGE_DATA")
  close(channel)
  
  save(nav.rov,logs.rov,events.rov,video.obs.rov,photo.info.rov,
       photo.obs.rov,lengths.rov,spp,lw.data,la.data,size.codes,
       file = here("Data/ROV/rov_data.Rdata"))
} else {
  load(here("Data/ROV/rov_data.Rdata"))
}

# Rename species code colums
spp <- spp %>% 
  rename(sciName = sci_name_full,
         commonName = common_name)

# Remove unused logs
logs.rov <- filter(logs.rov,survey_number == 40 & for_analysis == 1) %>% 
  rename(site = site_general)

# Read good nav IDs
nav.rov.good <- read_csv(here("Data/ROV/good_rov_nav.csv"))$nav_id

# Filter, rename nav
nav.rov        <- filter(nav.rov,dive_name %in% logs.rov$dive_name) %>%
  rename(site = site_general,
         long = long_r,
         lat  = lat_r,
         disp = disp_r) %>% 
  filter(nav_id %in% nav.rov.good) %>%
  mutate(depth = depth - altitude, # Calculate seabed depth from pressure and altitude
         stratum = cut(depth,seq(-400,0,100))) %>% 
  arrange(date_time)

# Add lat/long/depth and species information to observations
video.obs.rov <- filter(video.obs.rov,dive_name %in% logs.rov$dive_name) %>% 
  left_join(select(nav.rov,nav_id,lat,long,depth)) %>% 
  left_join(select(spp,species_code,sci_name,sciName,commonName,species_group)) %>% 
  left_join(select(size.codes,size_code,desc_coast11)) %>% 
  rename(size_class = desc_coast11) %>%
  mutate(geol_ps = paste(geol_prim,geol_sec,sep = "")) %>% 
  droplevels()

# Calculate transect width
cw.data <- calc_width(nav.rov$pitch,nav.rov$altitude,ROV = "Phantom")

# Merge data
nav.rov <- bind_cols(nav.rov,cw.data) %>% 
  filter(pitch < 0 & slant_range <= 6) %>% 
  mutate(area = center_width * disp)

# Summmarise distance by dive and depth stratum for bootstrap analysis
nav.rov.boot <- nav.rov %>% 
  group_by(dive_name,stratum) %>% 
  summarise(
    distance = sum(disp),
    area = sum(area))

nav.rov.summ <- nav.rov %>% 
  group_by(site,stratum) %>% 
  summarise(
    n.tx = n_distinct(dive_name),
    distance = sum(disp),
    survey_area = sum(area)) %>% 
  arrange(site,desc(stratum))

# Filter other data
events.rov <- filter(events.rov,dive_name %in% logs.rov$dive_name)

# Format L/W data table
lw.data <- filter(lw.data,to_use == 1) %>%
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(a)) %>% 
  left_join(select(spp,sciName,commonName)) %>% 
  select(sciName, commonName, a, b, L_max, sex, Reference, comment)

# Format L/age data table
la.data <- filter(la.data,to_use == 1) %>% 
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(L_inf))

# Extract only fish observations
obs.rov <- video.obs.rov %>% 
  filter(str_detect(sciName,"Sebastes|Sebastolobus|Sebastomus|Ophiodon|Merluccius")) %>% 
  left_join(select(lw.data,sciName,a,b,L_max)) %>% 
  mutate(stratum = cut(depth,seq(-400,0,100)),
         length_cm = size_code * 10 + 5,
         weight_g = a * length_cm^b * counts) %>% 
  droplevels()

# ggplot(obs.rov.summ, aes(length_cm, counts)) + geom_bar(stat = "identity") + 
#   facet_wrap(~sciName, scales = "free_y") + theme_bw() 

# ROV data for bootstrap analysis 
boot.data.rov <- obs.rov %>% 
  group_by(dive_name,stratum,sciName) %>% 
  summarise(counts      = sum(counts),
            weight_g    = sum(weight_g)) %>% 
  left_join(nav.rov.boot) %>%
  left_join(select(logs.rov,dive_name,site)) %>%
  mutate(dens_n = counts/area,         # Numeric density (n/m)
         dens_g = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund = dens_n*stratum_area, # Abundance (n)
         biom  = dens_g*stratum_area,
         platform = "ROV") %>%   # Biomass (g)
  arrange(desc(counts))

# Write to CSV
write_csv(boot.data.rov,here("Output/boot_data_rov.csv"))

# Filter photo info 
photo.info.rov <- filter(photo.info.rov,dive_name %in% logs.rov$dive_name)
# Process photo observations
photo.obs.rov  <- filter(photo.obs.rov,photo_id %in% photo.info.rov$photo_id) %>% 
  left_join(select(spp,sci_name,sciName,commonName)) %>%
  filter(str_detect(sciName,"Sebastes|Sebastolobus|Sebastomus|Ophiodon|Merluccius")) %>%
  droplevels()

# Add species info to length data
lengths.rov <- filter(lengths.rov,dive_name %in% logs.rov$dive_name) %>% 
  left_join(select(spp,species_code,sci_name,sciName,commonName,species_group)) %>% 
  droplevels()
```

```{r ImportSUB}
if (import.data) {
  if (sub.source == "DSN") {
    sub.con.dsn <- dbConnect(odbc::odbc(),.connection_string = "
                           Driver={SQL Server};
                           Server=128.114.3.186;
                           Database=riglevisbase;
                           Uid=kevin.stierhoff;
                           Pwd=rockfish;")
    
    # dbListTables(sub.con.dsn)
    dbDisconnect(sub.con.dsn)    
  } else {
    # Configure connection to Acess database
    sub.con <- channel <- odbcConnectAccess2007(here("Data/SUB/sub_data.accdb"))    
    # Import CTD data
    ctd.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_ctd") %>% 
      unite(date,year,month,day,sep = "-") %>% 
      mutate(time      = str_extract(realtime,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = paste(dive, transect, sep = "0")) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time)) %>% 
      rename(depth     = depth_m,
             oxy_conc  = Oxygen_ml_L,
             oxy_sat   = Oxygen_percent_saturation)
    
    # Import NAV data  
    nav.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_nav") %>% 
      rename(lat       = latitude,
             long      = longitude,
             cum_dist  = cum_dist_m) %>% 
      unite(date,year,month,day,sep = "-") %>% 
      mutate(time      = str_extract(time,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = str_sub(as.character(dv0tx0seg),1,4)) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time),
             dist = c(diff(cum_dist),0)) %>% 
      filter(transect != 0 & segment != 0 & dist < 5 & dist > -5)
    
    # Close connection
    close(sub.con)
    
    # Import density summary
    counts.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                           sheet = "Yok_Sub_Density_step3") %>% 
      rename(site = bank,
             dive_name = dive_tx,
             sciName   = Scientific_Name,
             counts    = SumOfSumOffreq,
             distance  = SumOfdist,
             stratum   = depth_bin) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             sciName   = str_replace(sciName,"unidentified sebastomus","Sebastomus spp."))
    
    # Get list of fishcodes and sciNames
    names.sub <- counts.sub %>% 
      select(sciName,fishcode) %>% 
      distinct() %>% 
      arrange(sciName)
    
    # Get transect distances
    nav.sub.summ <- counts.sub %>% 
      select(dive_name,distance) %>% 
      distinct() %>% 
      arrange(dive_name)

    # Import sub density summary
    biomass.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                           sheet = "Yok_Sub_Biomass_step2") %>% 
      rename(site = bank,
             dive_name = divetx,
             counts    = SumOffreq,
             length_cm = size_class) %>% 
      select(-a_coeff,-b_coeff,-tx_area_m2,-weight_g) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             stratum = cut(depth_bin * -0.9,seq(-400,0,100))) %>% 
      left_join(names.sub) %>% 
      left_join(select(lw.data,sciName,a,b,L_max)) %>% 
      left_join(nav.sub.summ) %>% 
      mutate(survey_area = distance * 2.5,
             weight_g = a * length_cm^b * counts)
  }
  # Save SUB data
  save(counts.sub,biomass.sub,ctd.sub,nav.sub,file = here("Data/SUB/sub_data.Rdata"))
} else {
  # Load SUB data
  load(here("Data/SUB/sub_data.Rdata"))
}

# ROV data for bootstrap analysis 
boot.data.sub <- biomass.sub %>% 
  group_by(site,dive_name,stratum,sciName) %>% 
  summarise(counts   = sum(counts),
            weight_g = sum(weight_g)) %>% 
  left_join(distinct(select(biomass.sub,dive_name,distance,area))) %>% 
  mutate(
    dens_n      = counts/area,         # Numeric density (n/m)
    dens_g      = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund  = dens_n*stratum_area, # Abundance (n)
         biom   = dens_g*stratum_area,
         platform = "SUB") # Biomass (g)

# Write to CSV
write_csv(boot.data.sub,here("Output/boot_data_sub.csv"))
```

```{r ImportAUV}
boot.data.all <- bind_rows(boot.data.rov, boot.data.sub)

boot.data.summ <- boot.data.all %>% 
  group_by(sciName, platform) %>% 
  summarize(counts = sum(counts)) %>% 
  spread(platform,counts) %>% 
  mutate(ALL = sum(ROV,SUB,na.rm = T)) %>% 
  arrange(desc(ALL))

write.csv(boot.data.summ,file = here("Output/obs_summ.csv"), row.names = F, quote = F, na = "-")

tx.rov <- n_distinct(nav.rov$dive_name)
dist.rov <- sum(nav.rov$disp)/1000
area.rov <- sum(nav.rov$area)/1000

tx.sub <- n_distinct(nav.sub$dive_name)
dist.sub <- sum(nav.sub$dist)/1000
area.sub <- dist.sub * 2.5

# nav.summ.sub <- nav.sub %>% 
#   group_by(site) %>% 
#   summarize(transects = n_distinct(dive_name))
```

```{r MapNav,eval=F}
# rnaturalearth vignette
# https://cran.r-project.org/web/packages/rnaturalearth/vignettes/rnaturalearth.html

# Get land features
if (get.sf) {
  # Download highres polygons for N. America
  na_sf <- ne_countries(type = 'countries', scale = 'large',returnclass = "sf")
  # Save sf objects
  save(na_sf,file = here("Data/GIS/na_sf.Rdata"))
} else {
  # Load sf objects
  load(here("Data/GIS/na_sf.Rdata"))
}

# Read shapefiles
sample_frame <- st_read(here("Data/GIS/sampling_frame.shp"))
depth_strata <- st_read(here("Data/GIS/depth_polygons.shp"))
depth_contours <- st_read(here("Data/GIS/depth_contours.shp"))
nav.auv <-st_read(here("Data/GIS/auv_nav_lines.shp"))

# Read rasters

# Map ROV tracks
survey.map <- ggplot(depth_strata) + geom_sf(aes(fill = stratum_z),alpha = 0.75) +
  geom_sf(data = depth_contours, colour = "black", size = 1) + 
  geom_sf(data = sample_frame, colour = "red", size = 2, fill = NA,linetype = "dashed") + 
  geom_path(data = nav.rov, aes(long,lat, group = dive_name), colour = "black", size = 1.5) +
  geom_path(data = nav.sub, aes(long,lat, group = dive_name), colour = "green", size = 1.5) +
  geom_sf(data = nav.auv, colour = "orange", size = 1) +
  scale_fill_manual(name = "Depth", values = c("white","lightblue1","royalblue","royalblue4")) +
  theme_bw() +
  xlab("Longitude") + ylab("Latitude") +
  xlim(-119.525, -119.435) + ylim(33.915, 33.97)

ggsave(survey.map, file = here("Figs/fig_site_map.png"),
       height = 12, width = 12)

# Change gridline colors

if (save.figs) {
  rov_counts <- ggplot(nav.rov,aes(long,lat,group = dive_name)) + geom_path() +  
    geom_point(data = obs.rov,aes(long,lat,size = counts)) + 
    facet_wrap(~sciName) +
    coord_sf() + 
    theme_bw()  
  ggsave(rov_counts,filename = here("Figs/fig_rov_counts.png"),height = 15, width = 15)
}
```  

```{r ROV_bootstrap}
if (do.boot) {
  # Bootstrap ROV abundance and biomass by strata
  B = 1000
  # i = "Sebastes levis"
  # j = "The Footprint"
  # k = "(-200,-100]"
  boot.df.rov <- data.frame()
  
  for (i in unique(boot.data.rov$sciName)) {
    for (j in unique(boot.data.rov$site)) {
      for (k in unique(boot.data.rov$stratum)) {
        boot.data <- filter(boot.data.rov, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:B)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.rov <- rbind(boot.df.rov,
                               data.frame(platform = "ROV", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,B),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.rov, file = here("Output/boot_results_rov.Rdata"))
} else {
  load(here("Output/boot_results_rov.Rdata"))
}
# Summarise ROV results
boot.summ.stratum.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# ggplot(boot.df.rov, aes(boot.abund, fill = stratum)) +
#   geom_density(alpha = 0.5) + facet_wrap(~sciName, scales = "free") + theme_bw()

boot.samples.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

boot.summ.sample.rov <- boot.samples.rov %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975)) %>% 
  arrange(sciName, site)

# ggplot(boot.samples.rov, aes(boot.abund, fill = site)) +
#   geom_density(alpha = 0.5) + facet_wrap(~sciName, scales = "free") + theme_bw()
```

```{r SUB_bootstrap}
if (do.boot) {
  # Bootstrap ROV abundance and biomass by strata
  B = 1000
  # Create data frame for storing results
  boot.df.sub <- data.frame()
  
  for (i in unique(boot.data.sub$sciName)) {
    for (j in unique(boot.data.sub$site)) {
      for (k in unique(boot.data.sub$stratum)) {
        boot.data <- filter(boot.data.sub, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:B)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.sub <- rbind(boot.df.sub,
                               data.frame(platform = "SUB", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,B),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.sub, file = here("Output/boot_results_sub.Rdata"))
} else {
  load(here("Output/boot_results_sub.Rdata"))
}
# Summarise ROV results
boot.summ.stratum.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# ggplot(boot.df.rov, aes(boot.abund, fill = stratum)) +
#   geom_density(alpha = 0.5) + facet_wrap(~sciName, scales = "free") + theme_bw()

boot.samples.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

boot.summ.sample.sub <- boot.samples.sub %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# ggplot(boot.samples.rov, aes(boot.abund, fill = site)) +
#   geom_density(alpha = 0.5) + facet_wrap(~sciName, scales = "free") + theme_bw()
```

```{r AUV_bootstrap,eval = T}
boot.summ.sample.auv <- boot.summ.sample.rov[0, ]
```

```{r ALL_bootstrap_summary}
boot.summ.sample.all <- bind_rows(boot.summ.sample.rov,boot.summ.sample.sub) %>% 
  ungroup() %>%
  mutate(sciName = fct_rev(factor(sciName)),
         biom_cv_cut = cut(biom.cv,c(0,25,50,75,100)),
         abund_cv_cut = cut(abund.cv,c(0,25,50,75,100)),
         sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>% 
  left_join(site.area) 

main.spp <- c("Sebastes paucispinis", "Sebastes levis","Sebastes chlorostictus","Ophiodon elongatus",
              "Sebastes crocotulus","Sebastes rufus")

fig.width = 5
fig.height = 7

ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic")) +
  ggtitle("Biomass (kg)")

ggsave(here("Figs/fig_raster_biomass_all.png"),height = fig.height, width = fig.width)

ggplot(filter(boot.summ.sample.all,sciName %in% main.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 3) +  
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic")) +
  ggtitle("Biomass (kg)")

ggsave(here("Figs/fig_raster_biomass_select.png"),height = 5, width = 5)

ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic")) +
  ggtitle("Abundance")

ggsave(here("Figs/fig_raster_abundance_all.png"),height = fig.height, width = fig.width)

ggplot(filter(boot.summ.sample.all,sciName %in% main.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 3) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic")) +
  ggtitle("Abundance")

ggsave(here("Figs/fig_raster_abundance_select.png"),height = 5, width = 5)
```

```{r ALL_bootstrap}
boot.samples.all <- bind_rows(boot.samples.rov, boot.samples.sub) %>% 
  ungroup() %>% 
  mutate(sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus"))

rov.colour = "yellow"
sub.colour = "blue"

ggplot(boot.samples.all, aes(boot.abund)) + geom_histogram(aes(fill = platform), alpha = 0.5) +
  facet_wrap(~sciName, scales = "free") + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() 

# Footprint data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "The Footprint"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "italic"),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_footprint.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "The Footprint"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "italic"),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_footprint.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_footprint.png"), height = 5, width = 12)

# Piggy Bank data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "Piggy Bank"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "Piggy Bank"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "italic"),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_piggy.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% main.spp & site == "Piggy Bank"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% main.spp & site == "Piggy Bank"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "italic"),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_piggy.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_piggy.png"), height = 5, width = 15)
```


**Comparing estimates of groundfish biomass, abundance, and diversity from different optical sampling methods** 

Kevin L. Stierhoff^1^, Mary M. Yoklavich^2^, and M. Elizabeth Clarke^3^

**Others:** Thomas E. Laidig^2^, Diana L. Watters^2^, Erica L. Fruh^3^, Jeff Anderson^4^, Jeremy C. Taylor^4^  

Draft date: `r format(Sys.time(), "%d %B %Y")`'

^1^Fisheries Resources Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
110 McAllister Way  
Santa Cruz, CA 95060, USA

^2^Fisheries Ecology Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
110 McAllister Way  
Santa Cruz, CA 95060, USA

^3^Office of the Science Director  
Northwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
2725 Montlake Boulevard East  
Seattle, WA 98112, USA  

^4^Coral Reef Ecology Division  
Pacific Islands Fisheries Science Center  
NOAA-National Marine Fisheries Service  
1845 Wasp Boulevard  
Honolulu, HI 96818  

\newpage

# Abstract  

TBD

\newpage  

# Introduction  

Many managed groundfish stocks on the U.S. west coast inhabit high-relief rocky areas that are inaccessible to traditional net-based survey methods (e.g., swept-area benthic trawls). Several species, such as cowcod (_Sebastes levis_) and yelloweye rockfish (_S. ruberrimus_), are strongly associated with these untrawlable habitats, have populations at various levels of depletion, and occupy habitats that have incurred substantial impacts from mobile fishing gear **[Did I get this correct??]** (Love and Yoklavich 2006; Yoklavich et al. 2007). Since much of the continental shelf and upper slope are closed to groundfishing, effective monitoring tools are required for species living in these untrawlable habitats.  

Non-lethal and non-destructive survey methods, whether optical, acoustical, or some combination of both, are needed to assess these vulnerable species while minimizing impacts on the fishes and their habitat. To that end, this study compared the results from visual transect surveys conducted in untrawlable habitat using a human-occupied submersible (SUB), an autonomous underwater vehicle (AUV), and a remotely operated vehicle (ROV). Specifically, each survey method was used to (1) identify, count, and estimate the sizes of rockfishes (_Sebastes_ spp.; both common and rare, large- and small-bodied, and semi-pelagic and highly demersal), lingcod (_Ophiodon elongatus_), thornyheads (_Sebastolobus_ sp.), and Pacific hake (_Merluccius productus_); (2) estimate the density, abundance, and biomass (and associated precision) for these taxa; and (3) estimate diversity within a prescribed study area.  

**More work will be spent on the Introduction at the end.**

# Methods  
## Survey area  
Underwater surveys of demersal fishes and their seabed habitats were conducted on two rocky seamounts - The Footprint and Piggy Bank - off southern California (**Figure 1**). The study site is located inside the State and Federal Footprint Marine Reserves, offshore of Santa Cruz Island, inside the Channel Islands National Marine Sanctuary. Piggy Bank is about 30 km^2^ in area, ranging in depth from 275 to 900 m; The Footprint is about 10 km^2^ in area, ranging in depth from 80 to 500 m. High-resolution bathymetry and broad-scale seabed classification from multibeam echosounder backscatter data were available prior to our surveys (Dartnell et al. 2005). The survey area was stratified into 100-m depth strata down to 400 m. The total area of each stratum was estimated using using GIS (ArcMap version 9.3; Esri, Inc.) (**Table X?**) and used to estimate total biomass and abundance from estimates of fish density. Large areas of soft sediment in the northeast section of the study site were excluded from our sampling frame.  

## Survey design  
Visual surveys were conducted using a SUB (_Dual Deepworker_, Nuytco) deployed from the F/V _Velero IV_ between 21 and 30 September 2011; using a remotely operated vehicle (ROV, _Phantom DS4_, Deep Ocean Exploration and Research) deployed from the F/V _Outer Limits_ during four legs between 21 September and 8 December 2011 (Leg 1: 21-22 September; Leg 2: 4 October; Leg 3: 12-13 October; and Leg 4: 4-8 December; and using an autonomous underwater vehicle (AUV, _Lucille_, SeaBED) between **21 and 30 September 2011 (check dates)** aboard the NOAA Vessel _Shearwater_. The sampling unit for the SUB and ROV was a transect and the sampling unit for the AUV was a transect grid (see below).

Transects were planned to occur in only one depth stratum. Some transects spanned multiple depths strata and were split into multiple transects by 100-m-depth bins. To reduce potential variability arising from very short transects, only those transects with lengths greater than 200 m were included in the analysis. Transect lengths were calculated from the speed of the ROV, and transect area was estimated every 2-s from the camera height, tilt angle, and horizontal viewing angle (Stierhoff et al., 2016).  

Each SUB dive included multiple, randomly located, 15-min-long transects within each stratum (**Figure X**). The number of transects per stratum was based on optimal sample variances from past visual surveys in the study area (**Yoklavich, unpublished data**), the area of each depth stratum (**Table 1**), and the amount of time available for the entire survey. A bootstrap analysis of coefficients of variation in density of various fish species and species
richness estimated from similar SUB transects conducted in 2005 on Footprint seamount at depths < 200 m. We concluded that 15 transects produced optimal sample variances for the area within the 100-200-m stratum at Footprint, and applied that ratio (15 transects/1.23 km^^) to determine the number of transects to be conducted within the other depth strata in the study area. We increased the number of transects within the <100 meter stratum based on relatively high density of fishes and species richness at that depth in the earlier survey of this area. Using ArcMap 9.3, the appropriate number of spatially random points were generated within each depth stratum to locate transects.  

For the AUV survey, a 250 x 250 m grid was superimposed on the survey area, then each cell was assigned to one of three focal areas: the top of Piggy Bank, the top of The Footprint and the deeper flank around The Footprint (**Figure 2**). Cells to be sampled were then selected randomly from each area. Within each cell, the AUV was programmed to survey pattern that covered the majority of the cell at a nominal height of **X m** above the seabed. The survey pattern consisted of five 200-m long transects connected by four 25-m long lines for a total transect distance of 1.1 km in each cell sampled. If randomly selected cells were close in proximiry, multiple cells could be sampled during one deployment. One to four cells were sampled per day and deployment duration varied from 45 to 88 min (mean = 74 min). Digital still images were collected every 10 s throughout each transect (see Survey Vehicles below).  

## Survey vehicles  
All visual transect surveys were conducted during daylight hours (~06:30 to 17:00 h PST) and spanned a variety of seabed types, from flat-sandy and mud seabeds to steeply sloping, high-relief rocky seabeds.  

### Human-occupied submersible  
A pilot operated the SUB while an experienced observer onboard identified all fish species and estimated their total length ($TL$) to the nearest 5-cm **[check this]**. Each transect was documented with two external high-definition (HD), three-color video cameras mounted at 45^$\circ$^ below horizontal on the starboard side of the SUB: one positioned in the same direction and field of view as the observer and the other camera located below the observer's field of view to record fishes in the area closest to the SUB that may not have been seen by the observer. The time on the video cameras were synchronized to **the GPS clock**. The observer's observations were logged in real-time on the audio track of the video recordings **and later reviewed and verified(?)**.  

The location of the SUB above the seabed was estimated using a USBL (TrackLink **5000HA (check this)**, LinkQuest) and dGPS. All data were time-stamped and logged synchronously every 3-s using integrated navigation software (WinFrog, Fugro Pelagos). The positioning system was linked to a GIS to track the SUB in real-time and so that a navigator aboard the support vessel could guide its path; the pilot and observer inside the SUB did not influence the direction of travel. During a transect, we tried to maintain a constant distance within 2 m of the seafloor and a constant speed between 0.5 and 1.0 kn, depending on substratum type (i.e., generally slower speed in complex habitats). Those segments of a transect in which the seafloor was not clearly visible were excised and not considered as part of the 15-min sample. The observer estimated fish sizes using paired lasers spaced 20-cm apart on either side of the main survey video camera as a guide. The length of each transect was determined using a DVL (**using speed, or dead reckoning between x/y/z estimates**) and ring-laser gyrocompass (**Make, Model**) attached to the outside of the submersible. An average **[and SD/SE??]** transect width of `2.5` m was estimated by the scientific observer with the aid of a hand-held sonar, the submersibless sonar, and a crossing laser set **to intersect the parallel laser** at `3` m from the observer when the submersible was `1` m above the seabed. Temperature, salinity, depth, and dissolved oxygen were measured every **X** s using a CTD (SBE-19, Seabird) and oxygen sensor **(Make, Model)**.  

### Remotely operated vehicle  
The location of the ROV above the seabed was estimated using an ultra-short baseline (USBL) acoustic tracking system (TrackLink 5000HA, LinkQuest, Inc.) and differential global positioning system (dGPS, CSI Wireless dGPS MAX). The length of each transect was estimated from the ROV speed that was measured using a Doppler velocity log (DVL, Workhorse Navigator, Teledyne RD Instruments). Water-column and near-bottom water quality parameters [e.g., temperature, salinity, dissolved oxygen (DO) concentration and DO saturation (%)] were measured during each transect using a CTD (Citadel CTD-ES, Teledyne RD Instruments) and optode (Model 3930, Aanderaa, Inc.). All data were time-stamped and logged synchronously using WinFrog integrated navigation software (Fugro Pelagos, Inc.). Reference lasers (spaced 20 and 60 cm-apart) were used to estimate fish lengths and transect widths (see Effort analysis below). All video footage was recorded to digital-video tape (DVCAM) and later used for enumerating fishes and characterizing the seabed. To aid in the identification and measurement of fishes observed on the video tapes, and also for better characterizing seabed substrates, high-quality digital still images were collected haphazardly. 

The location of transects during Leg 1 (**Figure X**, orange transects) were selected based on preliminary acoustic backscatter data collected by the SWFSC’s Advanced Survey Technology (AST) group between 13 and 14 September. Subsequent transects were selected at random (Legs 2-4, **Figure X**).  

### Autonomous underwater vehicle  
Stereo images of the seabed were collected every 10 s using a **calibrated?**, downward-facing stereo camera pair (5-megapixel, 12-bit dynamic range machine vision cameras; GigE, Prosilica) synced to a strobe (**[model important?]**); a third GigE camera was angled forward at and angle of 30^$\circ$^strobe synced with the cameras. The location of the AUV above the seabed was estimated using a USBL acoustic tracking system (TrackLink **1500/5000HA**, LinkQuest, Inc.) and dGPS (**Model, Manufacturer??**), and the depth was determined using a depth sensor (**Model?**, Paroscientific). Scientists communicated with the AUV using an acoustic modem (256008 acoustic micromodem, WHOI) at depth and a radio modem (Model FGR-115 RCRF, FreeWave) at the surface. Physical oceanographic measurements were made using an onboard CTD (Model 49 FastCat, Sea-Bird).

## Visual analysis methods  
All target species observed in video recordings were identified, with the aid of high-resolution still images when availble, to the lowest possible taxon and counted. When fishes could not be identified to species, they were identified to the genus (e.g., unidentified rockfish, _Sebastes_ spp.; or unidentified thornyhead, _Sebastolobus_ spp.) or subgenus level (e.g., rosy-group rockfish, _Sebastomus_).  

### SUB  
Video transects and associated audio annotations made by the observer during each dive were reviewed following the survey. All observed fishes within 2 m of the seabed were identified to lowest possible taxon, counted, and measured (to nearest 5 cm).  

### ROV
For each observation, total length (_TL_; cm) was estimated to the nearest 10 cm (e.g., 0-10 cm, 10-20 cm, etc.) using the parallel lasers for reference. When fish were oriented normal to the camera lens and near the reference lasers, _TL_ was measured more precisely (i.e., nearest 1 cm) using image analysis package (ImageJ, National Institute of Health).  

## Characterization of seabed type
**[Not sure if we'll keep this section, but I've inserted text here in case.]**  
### SUB  
Seafloor substrate was classified using in order of decreasing particle size and vertical relief (as described in Greene et al. 1999): rock (R), boulder (B), cobble (C), and mud (M). A two-character code was used to quantify patches of uniform substratum type along each transect (as described in Yoklavich et al., 2000). The primary character in the code represented the substratum type that accounted for at least 50% of the patch, and the secondary character represented the substratum type accounting for at least 20% of the patch (e.g., CM represented a patch of at least 50% cobbles and at least 20% mud). The area of each substratum patch along a transect was estimated as the product of the transect width and the length of the patch.  

### ROV  
Primary and secondary geologic seabed characteristics were described at the beginning of the transect, at the time of each fish observation, and also at any transition between different seabed types, allowing for the description of associations between each species and different seabed types and also the estimation of area searched within each seabed type. Both the primary (>50% of the seabed within the strip area) and secondary (20-50% of the seabed within the strip area) seabed characteristics were described. Seabed classifications generally followed the classification scheme of Greene et al. (1999),
and were based on particle size: mud (clay to silt; <0.06 mm), sand (0.06-2 mm), pebble (2-64 mm), cobble (64-256 mm), boulder (0.25-3 m), low-complexity (<0.25 m pavement) reef, and highcomplexity (>0.25 m) reef. The term “complexity” refers to the presence and the size of cracks and
crevices in the seabed that may provide refuge to rockfishes. Based on the size and shape of these features, low-complexity and high-complexity reef probably serve the same ecological function as sand/pebble and cobble/boulder, respectively.  

### AUV
Seafloor habitats in each photograph were categorized using a two-character code (**Table X**) The first character signified the primary habitat type that covered greater than 50% of the field of view, while the second character defined the secondary habitat type covering between 20% and 50%.  If the primary habitat coverage exceeded 80%, that letter was denoted twice (e.g., CC).

## Estimation of abundance and biomass
### ROV (and SUB?)
**[Methods may be same for ROV and SUB]** The total abundance and biomass of each species was estimated within each stratum. Total abundance ($N$) in each transect was estimated using the strip transect method (Buckland et al. 2001) by multiplying the mean density of each species ($D$; **get correct symbol**) within a stratum by the total area ($A$) within that stratum (**Table X**). For each transect, density was calculated as: $D = n / a$, where $n$ is the number of individuals encountered and $a$ is the transect area. The total area of each depth stratum was estimated using ArcGIS (**Table 2**). The biomass ($B$) for each species was estimated from $TL$ as: $B = a * (TL)^b$, where $a$ and $b$ are the taken from published relationships between TL and mass (**Appendix/Table X**). For fishes assigned to 10-cm length bins, the midpoint of each size class was used to estimate biomass (e.g., 5 cm for the 0-10 cm class). Many species for which few or no voucher specimens are available (e.g., dwarf-red rockfish, _S. rufinanus_; rosethorn rockfish, _S. simulator_; and pygmy rockfish, _S. wilsoni_), coefficients for closely related species (as described by Hyde & Vetter 2007) were used. The relationship for vermilion rockfish (_S. miniatus_) was substituted for the newly described sunset rockfish (_S. crocotulus_; Hyde et al. 2008). Since many of the unidentified rockfishes were of the semi-pelagic, aggregating variety, coefficients for squarespot rockfishes (_S. hopkinsi_, the most common species with similar behavior and vertical distribution) were used. For unidentified rosy-group fishes (_Sebastomus_), coefficients for swordspine rockfish (_S. ensifer_, the most common _Sebastomus_ species observed) was used. Mean, CV of the mean, and 90%-quantile confidence intervals for abundance and biomass were estimated using a non-parametric bootstrap of 1,000 samples (Efron & Tibshirani 1993).  

### SUB  
To estimate total biomass of species, we used the length-weight relationship

We substituted coefficients from closely related species for chameleon (_S. phillipsi_), dwarf-red (_S. rufinanus_), and pygmy (_S. wilsoni_) rockfishes and unidentified thornyheads and _Sebastomus_ because coefficients were unavailable for these taxa. Biomass density (kg 100 m^-2^) was then calculated for each taxon on each transect by summing the weights of individuals and dividing by the transect area. The mean and variance of biomass density were calculated from transects within each depth stratum, and expanded to total biomass and variance by multiplying by the area of the depth stratum. Total biomass and variance for each bank and the banks combined were estimated by summing biomass and variance for all depth strata. Coefficient of variation (CV) was calculated as CV = sqrt(var(B)/B).  

### AUV  
Digital still images were downloaded at the end of each mission and color-corrected. All non-overlapping images from the port, downward-facing camera were reviewed to identify and count all fish observed; images from the angled camera were used to aid in the identification of fishes observed. The area of each image was estimated using the measured altitude above the seabed and the specified camera field of view.  

## Biodiversity estimates  
### SUB

### ROV  
Species richness ($S$); species diversity (Shannon $H’$), and Simpson's lambda ($\lambda$) were computed for each transect and then summarized within each depth stratum and at each bank. The expected species richness (rarefaction) in a particular sample from that stratum was estimated and arefaction curves were generated for each bank using the. All biodiversity estimates were generated using the _vegan_ package (**Oksanen et al. 2012**) in R (**R Development Core Team 2011**).  

### AUV  

# Results  
## Survey effort  
**[Assemble a table of n transects, distance, and area for each method, bank, and depth stratum.]**  

### SUB  
A total of `69` transects were conducted between `95`-`400` m during `17` dives on Footprint (n = `55` transects) and Piggy Bank (n = `14` transects) covering a total distance of `52000` m^2^ (total area = `0.05` km^2^) (**Table X**; **Figure X**). Mean transect length was `294` m (SE = `8` m). Dive duration ranged from 1.4 to `3.2` h (mean = `2.3` h, SE = `0.1` h).  

### ROV  
A total of `r 37` transects were surveyed from ~`r 90` to `r 390` m. The majority of transects were conducted between the depths of 100 to 300 m on the Footprint, and from 200 to 300 m on Piggy Bank (**Table 2**, **Fig. 1**). The transect length ranged from ~`r 300` to `r 1300` m (mean = `r  "X"` m, SD = `r "SD"`), area ranged from (mean = `r  "X"` m^2^, SD = `r "SD"`), and duration ranged from ` r20` to `r 140` min (mean = `r  "X"` min, SD = `r "SD"`). The average transect width was `r 2.97` (SD = `r 1.34`). Due to technical problems with the ROV, inclement weather, or both, the ROV portion of this comparative survey had to be completed in several “legs” spanning several months between September and December. **Calculate new estimates of area using method of Stierhoff et al. 2016.**  

### AUV
Twenty-seven cells were sampled throughout the survey area covering a total of 70,006 m^2^ and ranging in depth from 99 to 487 m: 13 on The Footprint, six on the flank of Footprint, and eight on Piggy Bank (**Table x**, **Figure 2**).  Seventeen of the 27 cells was entirely within one 100-m depth stratum, while ten cells spanned two 100 m strata. The range of depths surveyed within a cell varied from 10 m to 83 m. Habitats encountered ranged from high-relief rock ridge to mud/sand bottom (**Figure x**). Cells surveyed on the top of Piggy Bank (200-300 m) contained rocky ridge substrate (30%), mud (33%) and similar amounts of boulder and cobble (17 and 19%, respectively). With increasing depth, the percentage of mud and cobble substrates increased. The top two depth strata on the Footprint were primarily cobble and boulder, with sand and rock ridge increasing with depth (**Figure X**.  Mud was the primary substrate observed in all depth strata on the flank of the Footprint (86, 99 and 97%).  

## Length frequency composition 

**[GENERATE LENGTH FREQUENCY PLOTS FOR EACH SURVEY METHOD]**
Examine whether differences in length distributions contribute to any differences in biomass or abundance.

## Abundance and biomass estimates  
### SUB  
A total of `25,085` individuals from `29` _Sebastes_ species were observed, which as a group comprised ~`80`% of the total fishes encountered. Unidentified rockfishes (_Sebastes_ spp.) comprised Only `0.5`% of all rockfishes (excluding some young-of-year juveniles) to species or species group (i.e., Sebastomus). Dwarf rockfish species were most numerous and dominated by _S. hopkinsi_ (`20`% of all rockfishes), _S. semicinctus_ (`17`% of all rockfishes), _S. jordani_ (`12`% of all rockfishes), _S. wilsoni_ (pygmy `7`%), and _S. ensifer_ (`7`%). Of particular interest were the observations of `147` _S. paucispinis_ (`0.7`%), `38` _S. levis_ (`0.2`%), _S. miniatus_ (`0.1`%), , _S. eos_ (<`0.1`%), and `4`_S. gilli_ (<`0.1`%; a rare and elusive species). Among non-rockfish species, Pacific hake (mostly juveniles; `4`%) were relatively abundant and lingcod were not (`0.2`%).  

A total of `414,975` fishes and `60.3` mt of fish biomass on Piggy Bank (not including unidentified adult orjuvenile rockfishes nor sharpchin rockfish (_S. zacentrus_) because meaningful length-weight relationships were not available) (**Table 5**). _Sebastes jordani_ ($N$ = `163,022`), _S. rufus_ ($N$ = `116,040`), and _S. diploproa_ (64,489 individuals) were most abundant and comprised the greatest biomass (`18`%, `53`%, and `12`% of total biomass, respectively) on the Piggy Bank.  

A total of `1,953,844` fishes representing `147.6` mt of fish biomass (excluding biomass estimates of unidentified rockfishes and sharpchin rockfish, as noted above) on The Footprint. Three dwarf species of rockfishes (_S. jordani_, $N$ = `339,855`); _S. semicinctus_, $N$ = `302,275`; and _Sebastomus_ (likely _S. ensifer_), $N$ = `268,618`) were most abundant but together comprised only `27`% of the total biomass. Among the large-bodied species **[these are "large-bodied"?]**, _S. diploproa_ ($N$ = `221,329`, $B$ = `14.5` mt), juvenile _M. productus_ ($N$ = `164,087`, $B$ = `19.5` mt), and _S. rufus_ ($N$ = `68,629`, $B$ = `14.9` mt) were relatively abundant. _Sebastes levis_ ($N$ = `4,325`, $B$ = `4.2` mt) comprised only `0.2`% of total abundance and `2.8`% of total biomass on The Footprint. _Sebastes paucispinis_ ($N$ = `13,342`, $B$ = `8.6` mt) comprised `0.7`% of total abundance and `5.8`% of total biomass at this site.  

Combining estimates from both banks, a total of `2,368,819` fishes with a biomass of `207.9` mt (**Table 7**). _Sebastes jordani_, _S. semicinctus_, and _S. diploproa_ were most abundant overall. Juvenile _M. productus_, _S. rufus_, _S. ensifer_, and _S. hopkinsi_ were also abundant. If _S. ensifer_ and _Sebastomus_ sp. (which were likely _S. ensifer_) were combined, the abundance would be second only to _S. jordani_. Four species (_S. rufus_, `23`% of total biomass; _S. jordani_, 15%; _S. diploproa_, 10%; and juvenile _M. productus_, 10%) comprised over `58`% of the total biomass in the entire study area. 

The coefficient of variation (CV) ranged from `0.12` to `0.84` for estimates of total abundance and from `0.15` to `0.92` for estimates of total biomass over both banks combined (**Table 7**). The CV for total abundance was `0.30` for _S. levis_, `0.26` for _S. paucispinis_, and `0.32` for _S. rufus_; the CV for total biomass was `0.44` for _S. levis_, `0.27` for _S. paucispinis_, and `0.36` for _S. rufus_.  

### ROV 
Over `37,700` individuals from thirty-three _Sebastes_ species, _O. elongatus_, and _M. productus_ were counted during this survey. The groundfish community throughout the survey area was numerically dominated by four small, semi-pelagic and aggregating species (squarespot rockfish, _S. hopkinsi_; swordspine rockfish, _S. ensifer_; halfbanded rockfish, _S. semicinctus_; and shortbelly rockfish, _S. jordani_) that comprised ~`80`% of all rockfishes (**Table 1**). Among non-aggregating species, bank (_S. rufus_, `5`%) and swordspine rockfishes (_S. simulator_, `1.5`%) were commonly observed. _Sebastes rufus_ (n = `1,883`) was the most abundant target species. In comparison, _S. paucispinis_ (n = `232`), _S. levis_ (n = `62`), and _S. crocotulus_ (n = `16`) were much less abundant (**Table X**).  

Overall abundance and biomass estimates were calculated for `33` species of rockfish, three unidentified rockfish groups, _O. elongatus_, and _M. productus_ (**Table 3**). Estimates of abundance and biomass of each of these species within each depth strata on each bank is provided in **Appendix 3**  
Approximately 2.3 million rockfishes, _O. elongatus_, and _M. productus_ were observed between 100-400 m on both banks (**Table 3**). _Sebastes ensifer_ (`619,114`) was the most abundant species, which was slightly more abundant than _S. hopkinsi_ (`566,753`). Among target species, _S. rufus_ (`177,981`) were highly abundant. _Sebastes paucispinis_ (`12,624`), _S. chlorostictus_ (`5,206`), and _S. levis_ (`4,109`) were much less abundant than those smaller, aggregating species (**Table 3**).  

Total biomass of all species was approximately `287` metric tons (mt; 1 mt = 1,000 kg) in the same area (**Table 3**). Nearly `62`% of the total fish biomass was comprised of the combination of _S. rufus_ (`60` mt) and small, aggregating species (_S. hopkinsi_, _S. ensifer_, _S. jordan_i; `118` mt). The other target species, _S. paucispinis_ (`16.2` mt), _S. levis_ (`7.5` mt), and _S. chlorostictus_ (`2.5` mt) had relatively lower biomass.  

The overall coefficient of variation (CV) for abundance (range = `0.12`-`1.00`) and biomass estimates (range = `0.15`-`1.01`) varied greatly among all species (**Table 3**). Species whose abundance and biomass estimates with high CVs (i.e., greater than ~`0.50`) were those that were either rarely encountered (e.g., _S. crameri_, _S. lentiginosus_, _S. rufinanus_, and _S. serranoides_) or whose densities varied greatly with depth (e.g., _S. hopkinsi_, _S. jordani_, _S. ovalis_, and _S. semicinctus_, which were densely aggregated in the shallower strata of the Footprint and almost entirely absent on Piggy Bank). Among target species, the CV values were relatively low and ranged from `0.28`-`0.46` and `0.26`-`0.44` for abundance and biomass, respectively. For _S. levis_, the overall CV values of abundance and biomass were quite low (`0.28` and `0.30`, respectively), and probably reflect the relatively even distribution of this species among transects on the Footprint and their total absence from any transects on Piggy Bank (**Figure 2**). _Sebastes rufus_ also had very low CV values (`0.26` for both abundance and biomass), but in contrast to _S. levis_, was highly abundant in the deeper strata on both banks (**Fig. 2**). As expected, differences in the distribution of many species were apparent by depth and bank (**Fig. 2**). Small, more numerically abundant species (e.g., _S. ensifer_, _S. hopkinsi_, _S. semicinctus_, and _S. wilsoni_) were commonly encountered on the shallower (<200 m) portions of the Footprint. _Sebastes paucispinis_ and _S. levis_ were found almost exclusively on the Footprint. _Sebastes diploproa_, _S. rufus_, and _S. simulator_ were found throughout the deeper strata on both banks, and were the only species commonly observed on Piggy Bank.  

### AUV
**[WAITING FOR LIZ'S UPDATED RESULTS]**
A total of `21,228` fishes from `51` taxa were identified during the survey including `18` rockfish species (**Table X**). Rockfishes comprised `75`% of the fishes encountered, including groups of unidentified rockfish (_Sebastes_ spp., **X%**), rosy-group rockfishes (_Sebastomus_, **X%**), and thornyheads (_Sebastolobus_ sp., **X%**), and other species that could be identified to species (**X%**). Notable were observations of `11` cowcod (_S. levis_), 29 bocaccio (_S. paucispinis_) and one bronzespotted rockfish (_S. gilli_). In addition, `53` lingcod (_Ophiodon elongatus_), `19` Pacific hake (_Merluccius productus_) and `10` sablefish (_Anoplopoma fimbria_) were observed. Fish assemblages varied between depth strata and between the two banks. Twenty-nine taxa only occurred on the Footprint or along its Flank. Two species were observed on Piggy Bank only.  

## Biodiversity  
### SUB  
Diversity (**or richness??**; measured as cumulative number of species in transects within a depth stratum, excluding groups), was highest on The Footprint in the 100-200 m (`23` species) and 200-300 m (`26` species) strata (**Table X**). Species richness ($S$) was lowest on Piggy Bank at both depth strata (`8` and `11` species in the 200-300 and 300-400 m strata, respectively).  

### ROV  
Biodiversity also varied greatly by depth strata and bank (**Table 6**). The greatest number of species (richness = `15`) was observed in the 0-100 m depth stratum on the Footprint, and the fewest were observed in the 300-400 m stratum at Piggy Bank. The rarefied species richness (the number of species expected per number of samples) was greatest in the 300-400 m stratum at the Footprint, with all other strata having rarefied species richness between `3.5` and `5.1`. Neither of these richness parameters account for the abundance of different species so Shannon $H’$ and Simpson $\lambda$, which do account for abundance differences, were also calculated. Again, the greatest diversity (both $H’$ and $\lambda$, respectively) were observed in the 300-400 m stratum at the Footprint, but diversity was relatively uniform across all depth strata and banks. Biodiversity estimates for each transect is presented in **Appendix 4**.  

The species accumulation (rarefaction) curves from each bank have much different shapes (**Figure 9**). The curve for the Footprint rises steeply in the first few samples and begins to plateau after ~ **10** transects. The rarefaction curve at Piggy Bank increased at a slower rate and never reached an asymptote. Although there were fewer transects at Piggy Bank, the other diversity estimates corroborate the finding that there is less biodiversity at Piggy Bank compared to the Footprint.  

### AUV
**[WAITING FOR LIZ'S UPDATED RESULTS]**
Species richness (total species, excluding groups) was the highest in the 100-200 m stratum on the Footprint (N = 23 species) and in the 300-400 m stratum on the Flank (18 species, **Table x**). Species richness was lowest in all three strata on Piggy Bank (six species at 200-300 m, eight species at 300-400 m, and seven species at 400-500 m).

# Discussion  
## Survey effort 
The AUV was able to sample the deeper 400-500 m stratum on the flank of Footprint, and to provide fish and habitat information that was not available from the ROV or SUB (**The ROV could have sampled deeper but . 

## Abundance and biomass estimates  

### AUV  

The species encountered by the AUV, ROV, and SUB were comparable.  

Species diversity was similar amongst all three methodologies showing greater species richness at the The Footprint and lower richness at Piggy Bank.  The ROV and the SUB included records of rockfish species not identified by the AUV.  This could be due to the fact that the cameras on the AUV are positioned downward, rather than forward facing, allowing fish directly in front of the unit to escape detection. Another possible reason could be the difficulty in identifying some rockfish species from the dorsal view.  The AUV detected comparable numbers of fishes, but the fish were identified to groupings (i.e. Unidentified rockfish, or Sebastomus) as opposed to species.

\newpage

# Tables  

**Table 1.** Coefficients used to convert total length (_TL_; cm) to weight (g) for biomass estimates.

```{r LengthWeightTable}
# Get species in study
lw_spp <- sort(unique(boot.data.rov$sciName))

# Subset and format table
lw_table <- lw.data %>%
  filter(sciName %in% lw_spp) %>% 
  rename(
      "Scientific name" = sciName,
      "Common name" = commonName,
      Sex = sex,
      Comment = comment) 

# Format and print L/W table
if (doc.type == "docx") {
  lw_table %>% 
    regulartable() %>% 
    italic(j = 1) %>%
    align(align = "center",part = "header") %>%
    autofit()
} else {
  lw_table %>% 
    rename(
      "$L_\\mathrm{max}$" = L_max,
      "$a$" = a,
      "$b$" = b) %>% 
    kable(format = knitr.format,booktabs = T, escape = F,
          align = c("l","l","r","r","r","l","l","l"),
          digits = c(0,0,4,4,1,0,0,0)) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>%
    column_spec(1, italic = T) %>% 
    row_spec(0, align = c("c"))
}
```  

\newpage  

# Figures  

```{r SurveyDomain,fig.height=6.5,fig.width=3.5,eval=FALSE}
# insert image if Word or HTML output
if(doc.type == "docx" | doc.type == "html"){
# read image file and print result
img <- readPNG(here("Figs/fig_ROV_survey_design.png"))
grid.raster(img)
}
```  

\begin{center}
\includegraphics[width = 5 in]{../Figs/fig_ROV_survey_design.png}
\end{center}

**Figure 1.** Map of the survey area indicating the extent of the sampling area, which includes The Footprint and Piggy Bank (dashed yellow box), depth strata (blue polygons), and the 250 x 250 m grid used to randomly select AUV sample locations. The area within each polygon is in **Table X.** **[Replace with new figure without ROV transects, showing AUV 250x250 m grid and randomly selected cells]**.  

\newpage

```{r AUVSamplingDesign,fig.height=6.5,fig.width=3.5,eval=FALSE}
# insert image if Word or HTML output
if(doc.type == "docx" | doc.type == "html"){
# read image file and print result
img <- readPNG(here("Figs/fig_ROV_survey_design.png"))
grid.raster(img)
}
```  

\begin{center}
\includegraphics[width = 5 in]{../Figs/fig_ROV_survey_design.png}
\end{center}

**Figure 2.** Locations of ROV, SUB, and AUV transects at the Footprint and Piggy Bank.  

\newpage

# Literature cited