---
header-includes: \usepackage{array} \usepackage{booktabs} \usepackage{calc} \usepackage{caption}
  \usepackage{colortbl} \usepackage{float} \usepackage{graphicx} \usepackage{hhline} \usepackage{isomath}
  \usepackage{longtable} \usepackage{multirow} \usepackage{pdflscape} \usepackage{siunitx} \usepackage[table]{xcolor} 
  \usepackage{tabu} \usepackage{tabularx} \usepackage{textcomp} \usepackage{threeparttable} \usepackage{upgreek}
  \usepackage{wrapfig} \newcommand{\blandscape}{\begin{landscape}} \newcommand{\elandscape}{\end{landscape}}
output:
  pdf_document:
    fig_caption: no
  html_document: default
  word_document:
    reference_docx: template/report_template_Rmarkdown.docx
    pandoc_args: [
     "--filter", "yaml/pandoc_newpage_filter.R"
     ]
bibliography: bib/ast_bib.bib
csl: csl/ices-journal-of-marine-science.csl
---  

```{r ConfigureDocument, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
# Install and load pacman (library management package)
if (!require("pacman")) install.packages("pacman")

# Install and load required packages
pacman::p_load(raster,tidyverse,knitr,swfscMisc,lubridate,here,boot,sf,
          maps,readxl,maptools,png,mapdata,flextable,knitr,
          cowplot,devtools,kableExtra,RODBC,pander,DBI,rgdal,
          rnaturalearth,odbc,shadowtext)

# Install and load Github packages
pacman::p_load_gh(c("kstierhoff/surveyR","tidyverse/ggplot2"))

# determines method of table generation (whether kable or pander) for best formatting
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')
if (is.null(doc.type)) {doc.type <- "html"}

# global knitr chunk options
knitr::opts_chunk$set(echo = F, warning = F, message = F, dev = "png", 
                      dev.args = list(type = "cairo"), dpi = 150)

# set global knitr options
options(knitr.kable.NA = '')

# determine global knitr table format
if (doc.type == "latex") {
  knitr.format <- "latex"
} else {
  knitr.format <- "html" 
}

# processing instructions (TRUE/FALSE)
import.data <- F # Download data from SQL database
save.figs   <- T # Draw plots and maps, or use existing
do.boot     <- F # Conduct bootstrap resampling
do.spatial  <- F # Perform spatial analyses (typically done once, or if data change)
get.sf      <- F # Download costline data
n.boot      <- 1000 # Number of bootstrap samples

# Data sources
sub.source  <- "Access" # Or DSN if getting from database directly

# Set plotting preferences
rov.colour = "yellow"
sub.colour = "blue"
auv.colour = "green"

# Species filters ---------------------------
# List used to filter by genus
filter.spp <- "Sebastes|Sebastolobus|Sebastomus|Ophiodon|Merluccius"
# Define list of select species of interest
select.spp <- c("Sebastes paucispinis","Sebastes levis","Sebastes chlorostictus","Ophiodon elongatus",
              "Sebastes crocotulus","Sebastes rufus")
# Define species to exclude from biomass comparisons
exclude.spp <- c("Sebastes sp.","Sebastomus sp.","Sebastolobus sp.","Merluccius productus")

# Set figure dimensions
fig.width  = 5
fig.height = 7
```  

```{r ImportSurveyData}
# Import stratum shapefile for ROV and SUB survey
depth_strata    <- st_read(here("Data/GIS/depth_polygons.shp")) %>% 
  mutate(stratum_area = area_sqkm*1e6)

# Create data frame with stratum area by site and depth
strata.area <- select(depth_strata, site, stratum, stratum_area) %>% 
  st_set_geometry(NULL)

# Summarize strata area by site
site.area <- strata.area %>% 
  group_by(site) %>% 
  summarize(stratum_area = sum(stratum_area))
```

```{r ImportROV}
# Either import ROV data from the database, or load already imported data
if (import.data) {
  # Configure database channel
  channel = odbcConnect(dsn = 'ROV2')
  # Import nav data
  nav.rov.all <- sqlQuery(channel,"
            SELECT dbo.tbl_NAV.*, dbo.tbl_LOGS.survey_number, dbo.tbl_LOGS.site_general
            FROM dbo.tbl_LOGS INNER JOIN dbo.tbl_NAV ON dbo.tbl_LOGS.dive_name = dbo.tbl_NAV.dive_name
            WHERE (((dbo.tbl_LOGS.survey_number)=40));")
  # Import transect logs
  logs.rov.all         <- sqlFetch(channel, "dbo.tbl_LOGS")
  # Import event logs
  events.rov           <- sqlFetch(channel, "dbo.tbl_EVENTS") 
  # Import video annotations
  video.obs.rov        <- sqlFetch(channel, "dbo.tbl_VIDEO_OBS")
  # Import photo info
  photo.info.rov       <- sqlFetch(channel, "dbo.tbl_PHOTO_INFO")
  # Import photo obs
  photo.obs.rov        <- sqlFetch(channel, "dbo.tbl_PHOTO_OBS")
  # Import lengths from ImageJ
  lengths.rov          <- sqlFetch(channel, "dbo.tbl_FISH_LENGTHS")
  # Import species info
  spp                  <- sqlFetch(channel, "dbo.tlu_SPECIES_CODES")
  # Import size codes
  size.codes           <- sqlFetch(channel, "dbo.tlu_SIZE_CODES")
  # Import length-to-weight and length-to-age data
  lw.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_WEIGHT_DATA")
  la.data              <- sqlFetch(channel, "dbo.tlu_LENGTH_AGE_DATA")
  close(channel)
  
  # Save imported raw data
  save(nav.rov.all,logs.rov.all,events.rov,video.obs.rov,photo.info.rov,
       photo.obs.rov,lengths.rov,spp,lw.data,la.data,size.codes,
       file = here("Data/ROV/rov_data.Rdata"))
} else {
  # Load imported data
  load(here("Data/ROV/rov_data.Rdata"))
}

# Standardize species code columns
spp <- spp %>% 
  rename(sciName = sci_name_full,
         commonName = common_name)

# Remove unused logs; used to filter other data later
logs.rov <- filter(logs.rov.all,survey_number == 40 & for_analysis == 1) %>% 
  rename(site = site_general)

# Process ROV nav data ------------------------------------------------
# Standardize nav columns
nav.rov.all <- nav.rov.all %>% 
  rename(site = site_general,
         long = long_r,
         lat  = lat_r,
         disp = disp_r) %>% 
  # Add for analysis from dive logs
  left_join(select(logs.rov.all, dive_name, for_analysis)) 

# Read good nav IDs from CSV (some nav records with bad USBL fixes were removed)
nav.id.good <- read_csv(here("Data/ROV/good_rov_nav.csv"))$nav_id

# Get nav_ids of "bad" USBL fixes
nav.id.bad <- filter(nav.rov.all, !nav_id %in% nav.id.good)$nav_id

# Remove bad nav records from master data frame
nav.rov.good <- nav.rov.all %>% 
  filter(nav_id %in% nav.id.good)

# Replace bad fixes with nearest (in time) good fix
for (i in nav.id.bad) {
  # Find good nav record with smallest difftime
  min.diff <- which.min(abs(difftime(nav.rov.all$date_time[nav.rov.all$nav_id == i],nav.rov.good$date_time)))
  # Replace lat and log for bad records with good fixes nearby
  nav.rov.all$lat[nav.rov.all$nav_id == i] <- nav.rov.good$lat[min.diff]
  nav.rov.all$long[nav.rov.all$nav_id == i] <- nav.rov.good$long[min.diff]
}

# Intersect nav with depth polygons to assign sampling strata
if (do.spatial) {
  # Do intersection and save results
  nav.rov.int <- nav.rov.all %>% 
    st_as_sf(coords = c("long","lat"), crs = 4326) %>% 
    st_intersection(select(depth_strata, stratum)) %>% 
    st_set_geometry(NULL)
  # Save results
  save(nav.rov.int, file = here("Data/ROV/rov_nav_intersection.Rdata"))
} else {
  # Load intersection results
  load(here("Data/ROV/rov_nav_intersection.Rdata"))
}

# Calculate transect width
cw.data <- calc_width(nav.rov.all$pitch, nav.rov.all$altitude, ROV = "Phantom")

# Add transect width, compute area and seabed depth, and filter bad data
nav.rov <- nav.rov.all %>% 
  # Add cw data
  bind_cols(cw.data) %>%
  # Compute seabed depth and area
  mutate(area = center_width * disp,
         depth = depth - altitude) %>% 
  left_join(select(nav.rov.int, nav_id, stratum)) %>% 
  # Filter to remove unused transects and time off effort
  filter(for_analysis == 1, pitch < 0, slant_range <= 6, nav_id %in% nav.rov.int$nav_id) %>%
  # Arrange by date/time
  arrange(date_time)

# # Plot all nav and nav used in the analysis 
# ggplot(nav.rov.all, aes(long, lat, group = dive_name)) + geom_path() +
#   geom_point(data = nav.rov, aes(long, lat), shape = 21, size = 1, alpha = 0.5, colour = "red", fill = NA) 
# 
# # Plot all nav and nave used in the analysis by stratum
# ggplot(nav.rov.all, aes(long, lat, group = dive_name)) + geom_path() +
#   geom_point(data = nav.rov, aes(long, lat, colour = stratum), size = 1, alpha = 0.5)

# Summmarise nav by dive and depth stratum for bootstrap analysis
nav.rov.boot <- nav.rov %>% 
  group_by(dive_name, stratum, site) %>% 
  summarise(
    distance  = sum(disp),
    area      = sum(area),
    depth.min = min(abs(depth)),
    depth.max = max(abs(depth)),
    duration  = n()*2/60) # Duration (s) is number of nav records x2

# # Identify transects less than 100 m in length
# nav.rov.short <- nav.rov %>%
#   left_join(select(nav.rov.boot, dive_name, stratum, distance)) %>%
#   filter(distance < 80)

# nav.rov.short %>% 
#   group_by(dive_name, stratum) %>% 
#   summarise(distance = sum(distance)) %>% 
#   arrange(distance)

# # Plot transects less than 100 m in length
# ggplot(nav.rov.all, aes(long, lat, group = dive_name)) + geom_path() +
#   geom_point(data = nav.rov.short, aes(long, lat, colour = stratum), size = 1, alpha = 0.5)

# Summarize nav by site and stratum for tables
nav.rov.summ <- nav.rov %>% 
  group_by(site, stratum) %>% 
  summarise(
    n.tx = n_distinct(dive_name),
    depth.min = min(abs(depth)),
    depth.max = max(abs(depth)),
    distance = sum(disp),
    survey_area = sum(area)) %>% 
  mutate(platform = "ROV") %>% 
  arrange(site,stratum) 

# Filter other data
events.rov <- filter(events.rov,dive_name %in% logs.rov$dive_name)

# Format L/W data table
lw.data <- filter(lw.data, to_use == 1) %>%
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(a)) %>% 
  left_join(select(spp,sciName,commonName)) %>% 
  select(sciName, commonName, a, b, L_max, sex, Reference, comment)

# Format L/age data table
la.data <- filter(la.data, to_use == 1) %>% 
  select(-id,-to_use) %>% 
  rename(sciName = sci_name_full,
         Reference = reference) %>% 
  arrange(sciName) %>% 
  filter(!is.na(L_inf))

# Create final observation data frame
# Add lat/long/depth and species information to observations
obs.rov <- video.obs.rov %>% 
  # Add for analysis from dive logs
  left_join(select(logs.rov.all, dive_name, for_analysis)) %>% 
  # Filter only observations for present survey
  filter(dive_name %in% nav.rov.all$dive_name) %>% 
  # Add lat, long, and depth
  left_join(select(nav.rov.all, nav_id, lat, long, depth)) %>% 
  # Add stratum from spatial intersection
  left_join(select(nav.rov.int, nav_id, stratum)) %>% 
  # Add spp info 
  left_join(select(spp, species_code, sci_name, sciName, commonName, species_group)) %>% 
  # Add size class info
  left_join(select(size.codes, size_code, size_class = desc_coast11)) %>% 
  # Create primary/secondary geology class
  mutate(geol_ps = paste(geol_prim, geol_sec, sep = "")) %>% 
  # Extract only fish observations
  filter(str_detect(sciName, filter.spp)) %>% 
  # Add length/weight data
  left_join(select(lw.data,sciName, a, b, L_max)) %>% 
  # Compute lengths from size codes, and weight from length and total count
  mutate(length_cm = size_code * 10 + 5,
         weight_g = a * length_cm^b * counts) %>% 
  droplevels()

# # Plot observations by stratum
# ggplot(nav.rov.all, aes(long, lat, group = dive_name)) + geom_path() +
#   geom_point(data = filter(obs.rov, !is.na(stratum)), aes(long, lat, colour = stratum), size = 1, alpha = 0.5) +
#   geom_point(data = filter(obs.rov, is.na(stratum)), aes(long, lat), size = 2, colour = "red") +
#   geom_point(data = filter(obs.rov, nav_id %in% nav.rov.short$nav_id), aes(long, lat), size = 2, colour = "blue")
# 
# # Summarize obs removed by removing short transeacts (< 80 m)
# obs.rov %>% filter(nav_id %in% nav.rov.short$nav_id) %>% 
#   group_by(sciName) %>% 
#   count() %>% 
#   arrange(desc(n))

# Summarize observations for bootstrap analysis
obs.rov.pos <- obs.rov %>% 
  group_by(dive_name, stratum, sciName) %>% 
  summarise(counts   = sum(counts),
            weight_g = sum(weight_g)) 

# Expand observations to create zeros for counts and weights 
# when fish not observed in a transect
obs.rov.boot <- obs.rov.pos %>%
  select(-weight_g) %>% 
  spread(key = sciName, value = counts, fill = 0) %>% 
  gather(sciName, counts,-dive_name,-stratum) %>% 
  left_join(select(obs.rov.pos, -counts)) %>% 
  replace_na(list(weight_g = 0))

# Summarize ROV observations
obs.rov.summ <- obs.rov %>% 
  group_by(sciName, commonName) %>% 
  summarise(nROV = sum(counts)) %>% 
  arrange(desc(nROV)) %>% 
  mutate(pctROV = nROV/sum(.$nROV)*100)
  
# ROV data for bootstrap analysis 
# Combine obs and nav 
boot.data.rov <- obs.rov.boot %>%
  left_join(select(nav.rov.boot, -depth.min, -depth.max, -duration)) %>%
  mutate(dens_n = counts/area,         # Numeric density (n/m)
         dens_g = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund = dens_n*stratum_area, # Abundance (n)
         biom  = dens_g*stratum_area,
         platform = "ROV") %>%   # Biomass (g)
  filter(dive_name %in% nav.rov.int$dive_name) %>% 
  arrange(desc(counts)) %>% 
  select(site, everything())

# # Plot all nav and nav used in the analysis
# ggplot(nav.rov.all, aes(long, lat, group = dive_name)) + geom_path() +
#   geom_path(data = filter(nav.rov.all, dive_name == "11-277A"), aes(long, lat, group = dive_name), colour = "red")

# Write to CSV
write_csv(boot.data.rov,here("Output/boot_data_rov.csv"))

# Filter photo info 
photo.info.rov <- filter(photo.info.rov,dive_name %in% logs.rov$dive_name)
# Process photo observations
photo.obs.rov  <- filter(photo.obs.rov,photo_id %in% photo.info.rov$photo_id) %>% 
  left_join(select(spp,sci_name,sciName,commonName)) %>%
  filter(str_detect(sciName,filter.spp)) %>%
  droplevels()

# Add species info to length data
lengths.rov <- filter(lengths.rov,dive_name %in% logs.rov$dive_name) %>% 
  left_join(select(spp,species_code,sci_name,sciName,commonName,species_group)) %>% 
  droplevels()

lw.data.rov <- obs.rov %>% 
  select(sciName, commonName, counts, length_cm, weight_g)
  
# Expand data frame by counts for plotting length frequencies
lw.data.rov <- obs.rov[rep(row.names(obs.rov),obs.rov$counts), ] %>% 
  select(sciName, commonName, counts, length_cm, weight_g) %>% 
  mutate(platform = "ROV")
```

```{r ImportSUB}
if (import.data) {
  if (sub.source == "DSN") {
    sub.con.dsn <- dbConnect(odbc::odbc(),.connection_string = "
                           Driver={SQL Server};
                           Server=128.114.3.186;
                           Database=riglevisbase;
                           Uid=kevin.stierhoff;
                           Pwd=rockfish;")
    
    # dbListTables(sub.con.dsn)
    dbDisconnect(sub.con.dsn)    
  } else {
    # Configure connection to Acess database
    sub.con <- channel <- odbcConnectAccess2007(here("Data/SUB/sub_data.accdb"))    
    # Import NAV data  
    nav.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_nav") %>% 
      filter(transect != 0 & segment != 0) %>% 
      rename(lat       = latitude,
             long      = longitude,
             cum_dist  = cum_dist_m) %>% 
      unite(date,year,month,day,sep = "-") %>% 
      mutate(time      = str_extract(time,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = paste(dive, transect, sep = "0")) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time),
             dist = c(diff(cum_dist),0)) %>% 
      filter(dist < 5 & dist > -5)
    
    # Import CTD data
    ctd.sub <-  sqlFetch(sub.con, "tbl_Gear_Compare_Yok_ctd") %>% 
      unite(date,year,month,day,sep = "-") %>% 
      filter(transect != 0 & segment != 0) %>% 
      mutate(time      = str_extract(realtime,"\\d{2}:\\d{2}:\\d{2}"),
             dive_name = paste(dive, transect, sep = "0")) %>% 
      unite(date_time,date,time,sep = " ") %>% 
      mutate(date_time = ymd_hms(date_time)) %>% 
      rename(depth     = depth_m,
             oxy_conc  = Oxygen_ml_L,
             oxy_sat   = Oxygen_percent_saturation) %>% 
      filter(dive_name %in% nav.sub$dive_name)
    
    # Close connection
    close(sub.con)
    
    # Import density summary to get counts
    counts.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                             sheet = "Yok_Sub_Density_step3") %>% 
      rename(site = bank,
             dive_name = dive_tx,
             sciName   = Scientific_Name,
             counts    = SumOfSumOffreq,
             distance  = SumOfdist) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             stratum = cut(depth_bin * -0.9,seq(-400,0,100)),
             sciName   = str_replace(sciName,"unidentified sebastomus","Sebastomus sp."),
             sciName   = str_replace(sciName,"Sebastes spp.","Sebastes sp."),
             sciName   = str_replace(sciName,"Sebastolobus spp.","Sebastolobus sp."),
             sciName   = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>%
      left_join(select(spp, sciName, commonName)) %>% 
      droplevels()
    
    # Get list of fishcodes and sciNames
    names.sub <- counts.sub %>% 
      select(sciName,fishcode) %>% 
      distinct() %>% 
      arrange(sciName)
    
    # Import biomass summary 
    lengths.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                             sheet = "Yok_Sub_Biomass_step2") %>% 
      left_join(names.sub) %>% 
      rename(site = bank,
             dive_name = divetx,
             counts    = SumOffreq,
             length_cm = size_class) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             sciName   = str_replace(sciName,"unidentified sebastomus","Sebastomus sp."),
             sciName   = str_replace(sciName,"Sebastes spp.","Sebastes sp."),
             sciName   = str_replace(sciName,"Sebastolobus spp.","Sebastolobus sp."),
             sciName   = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus")) %>%
      left_join(select(spp, sciName, commonName)) %>% 
      droplevels()
    
    # Get transect distances
    tx.dist.sub <- counts.sub %>% 
      select(dive_name,distance) %>% 
      distinct() %>% 
      arrange(dive_name)
    
    # Import sub density summary
    biomass.sub <- read_excel(here("Data/SUB/sub_data.xlsx"),
                           sheet = "Yok_Sub_Biomass_step2") %>% 
      rename(site = bank,
             dive_name = divetx,
             counts    = SumOffreq,
             length_cm = size_class) %>% 
      select(-a_coeff,-b_coeff,-tx_area_m2,-weight_g) %>% 
      mutate(site = str_replace(site,"footprint","The Footprint"),
             site = str_replace(site,"piggy","Piggy Bank"),
             stratum = cut(depth_bin * -0.9,seq(-400,0,100))) %>% 
      left_join(names.sub) %>% 
      left_join(select(lw.data,sciName,a,b,L_max)) %>% 
      left_join(tx.dist.sub) %>% 
      mutate(area = distance * 2.5,
             weight_g = a * length_cm^b * counts)
    
    # Get strata for each transect to add to CTD
    tx.strata.sub <- biomass.sub %>% 
      select(site, dive_name, stratum) %>% 
      distinct() %>% 
      arrange(dive_name)
    
    # Add transect info to CTD data for summarizing later
    ctd.sub <- ctd.sub %>% 
      left_join(tx.strata.sub)
  }
  # Save SUB data
  save(counts.sub, biomass.sub, ctd.sub, nav.sub, tx.dist.sub, lengths.sub, 
       file = here("Data/SUB/sub_data.Rdata"))
} else {
  # Load SUB data
  load(here("Data/SUB/sub_data.Rdata"))
}

# Get min and max depth from SUB CTD
ctd.sub.summ <- ctd.sub %>% 
  group_by(dive_name) %>% 
  summarise(depth.min = min(depth),
            depth.max = max(depth))

# Summarize transect duration and distance for the SUB
tx.summ.sub <- nav.sub %>% 
  group_by(dive_name) %>% 
  summarise(
    duration = as.numeric(difftime(max(date_time),min(date_time),units = "mins"))) %>% 
  mutate(platform = "SUB") %>% 
  left_join(tx.dist.sub)

# Summarize SUB nav by site and stratum for tables
nav.sub.summ <- biomass.sub %>%
  select(site, stratum, dive_name, distance, area) %>% 
  distinct() %>% 
  left_join(ctd.sub.summ) %>%
  group_by(site,stratum) %>%
  summarise(
    n.tx = n_distinct(dive_name),
    depth.min = min(depth.min, na.rm = T),
    depth.max = max(depth.max, na.rm = T),
    distance = sum(distance),
    survey_area = sum(area)) %>%
  mutate(platform = "SUB") %>% 
  arrange(site,desc(stratum))

# Summarise positive transects
obs.sub.pos <- counts.sub %>%
  group_by(dive_name, stratum, sciName) %>%
  summarise(counts = sum(counts)) %>% 
  filter(str_detect(sciName,filter.spp)) 

# Summarise positive biomass
biom.sub.pos <- biomass.sub %>% 
  group_by(dive_name, stratum, sciName) %>%
  summarise(weight_g = sum(weight_g)) %>% 
  filter(str_detect(sciName,filter.spp))

# Combine counts and biomass 
obs.sub.boot <- obs.sub.pos %>% 
  spread(key = sciName, value = counts, fill = 0) %>% 
  gather(sciName, counts, -dive_name, -stratum) %>% 
  left_join(select(biom.sub.pos, dive_name, stratum, sciName, weight_g)) %>% 
  filter(!(is.na(weight_g) & counts > 0)) %>% 
  replace_na(list(weight_g = 0)) %>%
  filter(str_detect(sciName,filter.spp)) %>% 
  left_join(select(spp, sciName, commonName))

# Summarize SUB observations
obs.sub.summ <- obs.sub.boot %>% 
  group_by(sciName, commonName) %>% 
  filter(str_detect(sciName,filter.spp)) %>% 
  summarise(nSUB = as.integer(sum(counts))) %>% 
  arrange(desc(nSUB)) %>% 
  mutate(pctSUB = nSUB/sum(.$nSUB)*100)

# SUB data for bootstrap analysis 
boot.data.sub <- biomass.sub %>% 
  group_by(site,dive_name,stratum,sciName) %>% 
  summarise(counts   = sum(counts),
            weight_g = sum(weight_g)) %>% 
  left_join(distinct(select(biomass.sub, dive_name, distance, area))) %>% 
  mutate(
    dens_n      = counts/area,         # Numeric density (n/m)
    dens_g      = weight_g/area) %>%   # Biomass density (g/m)
  left_join(strata.area) %>%
  mutate(abund  = dens_n*stratum_area, # Abundance (n)
         biom   = dens_g*stratum_area,
         platform = "SUB") # Biomass (g)

# Write to CSV
write_csv(boot.data.sub,here("Output/boot_data_sub.csv"))

# Expand data frame by counts
lw.data.sub <- lengths.sub[rep(row.names(lengths.sub),lengths.sub$counts), ] %>% 
  select(sciName, commonName, counts, length_cm, weight_g) %>% 
  mutate(platform = "SUB")
```

```{r ImportAUV}

```

```{r ObsSummary}
# Combine summaries from each vehicle
obs.all.summ <- obs.rov.summ %>%
  left_join(obs.sub.summ) %>% 
  # left_join(obs.auv.summ) %>% 
  replace_na(list(nROV = 0, nSUB = 0)) %>%
  # replace_na(list(nROV = 0, nSUB = 0), nAUV = 0) %>% 
  mutate(nGrand = nROV + nSUB) %>% 
  mutate(pctGrand = nGrand/sum(.$nGrand)*100) %>% 
  arrange(desc(pctGrand), sciName) 

# Write to CSV
write.csv(obs.all.summ,file = here("Output/obs_summ.csv"), row.names = F, quote = F, na = "-")

# Filter to include only those species to be included in the comparison
# Removes rare and/or unidentified species that were not measured
comp.spp <- obs.all.summ %>% 
 filter(nGrand > 20 & !sciName %in% exclude.spp)
```

```{r LengthWeightHistogram}
# Combine all L/W data
lw.data.all <- lw.data.rov %>% 
  bind_rows(lw.data.sub)

# Length histogram for all species
lw.hist.all <- ggplot(filter(lw.data.all, sciName %in% comp.spp$sciName), aes(length_cm, fill = platform)) +
  geom_histogram(breaks = seq(0,70,10),colour = "white",alpha = 0.5) +
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  facet_wrap(~sciName, scales = "free_y", ncol = 5) +
  theme_bw() +
  theme(strip.text.x         = element_text(face = "bold.italic"),
        strip.background     = element_blank(),
        legend.position      = c(1,1),
        legend.justification = c(1,1),
        legend.background    = element_blank()) +
  xlab("\nTotal length (cm)") + ylab("Frequency\n")

# Save figure
ggsave(lw.hist.all, filename = here("Figs/fig_histogram_length_comp.png"),
       height = 10, width = 10)

# Length histogram for select species
lw.hist.select <- ggplot(filter(lw.data.all, sciName %in% select.spp), aes(length_cm, fill = platform)) +
  geom_histogram(breaks = seq(0,70,10),colour = "white",alpha = 0.5) +
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + 
  # scale_y_continuous(expand = c(0,0,0,0.05)) +
  theme_bw() +
  facet_wrap(~sciName, scales = "free_y", ncol = 2) +
  theme_bw() +
  theme(strip.text.x         = element_text(face = "bold.italic"),
        strip.background     = element_blank(),
        legend.position      = c(1,1),
        legend.justification = c(1,1),
        legend.background    = element_blank()) +
  xlab("\nTotal length (cm)") + ylab("Frequency\n")

# Save figure
ggsave(lw.hist.select, filename = here("Figs/fig_histogram_length_comp_select.png"),
       height = 10, width = 7)
```

```{r CombineBootstrapData}
# Combine data from all vehicles for the bootstrap analysis

# Add AUV data
boot.data.all <- bind_rows(boot.data.rov, boot.data.sub) %>%  
  filter(str_detect(sciName,filter.spp)) %>% 
  filter(!sciName %in% exclude.spp)

# # Summarize observations from each vehicle for tabular output
# obs.summ.all <- boot.data.all %>% 
#   group_by(sciName, platform) %>% 
#   summarize(counts = sum(counts)) %>% 
#   spread(platform,counts) %>% 
#   mutate(ALL = sum(ROV,SUB,na.rm = T)) %>% 
#   arrange(desc(ALL))

# # Write to CSV
# write.csv(obs.summ.all,file = here("Output/obs_summ.csv"), row.names = F, quote = F, na = "-")
```

```{r CreateSiteMap}
# rnaturalearth vignette
# https://cran.r-project.org/web/packages/rnaturalearth/vignettes/rnaturalearth.html

# Get land features
if (get.sf) {
  # Download highres polygons for N. America
  na_sf <- ne_countries(type = 'countries', scale = 'large', returnclass = "sf") %>% 
    filter(subregion %in% c("Northern America") & admin %in% c("United States of America","Canada"))
  # Save sf objects
  save(na_sf,file = here("Data/GIS/na_sf.Rdata"))
} else {
  # Load sf objects
  load(here("Data/GIS/na_sf.Rdata"))
}

if (save.figs) {
  # Read bathy and hillshade rasters
  # https://nrelscience.org/2013/05/30/this-is-how-i-did-it-mapping-in-r-with-ggplot2/
  bathy <- raster(here("Data/GIS/bathy_wgs84.tif")) %>% 
    rasterToPoints() %>% 
    as.data.frame() %>% 
    rename(long = x,
           lat = y,
           depth = bathy_wgs84)
  
  hill <- raster(here("Data/GIS/hill_wgs84.tif")) %>% 
    rasterToPoints() %>% 
    as.data.frame() %>% 
    rename(long = x,
           lat = y,
           hill = hill_wgs84)
  
  # Read shapefiles
  sample_frame    <- st_read(here("Data/GIS/sampling_frame.shp"))
  sample_frame_jb <- st_read(here("Data/GIS/sampling_frame_jb.shp"))
  depth_contours  <- st_read(here("Data/GIS/depth_contours.shp"))
  nav.auv         <- st_read(here("Data/GIS/auv_nav_lines.shp"))
  grid.auv        <- st_read(here("Data/GIS/auv_grid_clipped.shp"))
  bank_labels     <- read_csv(here("Data/GIS/bank_labels.csv"))
  
  # Map ROV tracks
  survey.map <- ggplot() +
    geom_raster(data = hill, aes(long, lat, alpha = hill), show.legend = F) +
    geom_sf(data = depth_strata, aes(fill = stratum_z), alpha = 0.5) +
    geom_sf(data = depth_contours, colour = "gray20", size = 1) + 
    geom_sf(data = grid.auv, fill = NA) +
    geom_sf(data = sample_frame, colour = "black", size = 1.5, fill = NA, linetype = "dashed") + 
    geom_sf(data = sample_frame_jb, colour = "red", size = 1.5, fill = NA, linetype = "dashed") +
    geom_shadowtext(data = bank_labels, aes(long, lat, label = label), 
                    size = 5, fontface = "bold", color = "black", bg.color = "white") +
    geom_path(data = nav.rov, aes(long,lat, group = dive_name), colour = "black",  size = 0.5) +
    geom_path(data = nav.sub, aes(long,lat, group = dive_name), colour = "green", size = 0.5) +
    geom_sf(data = nav.auv, colour = "orange", size = 0.5) +
    scale_alpha(range = c(1, 0.1)) +
    scale_fill_manual(name = "Depth", values = c("white","lightblue1","royalblue","royalblue4")) +
    xlab("\nLongitude") + ylab("Latitude\n") +
    coord_sf(xlim = c(-119.525, -119.435), ylim = c(33.915, 33.97)) +
    theme_bw() +
    theme(axis.text.x      = element_text(size = 11),
          axis.text.y      = element_text(size = 11, angle = 90, hjust = 0.5),
          axis.title.x     = element_text(size = 16),
          axis.title.y     = element_text(size = 16),
          panel.grid.major = element_line(colour = "white"))
  
  # Save site map
  ggsave(survey.map, file = here("Figs/fig_survey_map.png"),
         height = 10, width = 12)
}
```  

```{r ROV_bootstrap}
# Bootstrap ROV abundance and biomass by strata
if (do.boot) {
  # i = "Sebastes levis"
  # j = "The Footprint"
  # k = "(-200,-100]"
  boot.df.rov <- data.frame()
  
  for (i in unique(boot.data.rov$sciName)) {
    for (j in unique(boot.data.rov$site)) {
      for (k in unique(boot.data.rov$stratum)) {
        boot.data <- filter(boot.data.rov, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:n.boot)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.rov <- rbind(boot.df.rov,
                               data.frame(platform = "ROV", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,n.boot),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.rov, file = here("Output/boot_results_rov.Rdata"))
} else {
  load(here("Output/boot_results_rov.Rdata"))
}
# Summarise ROV results by stratum
boot.summ.stratum.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# Calculate ROV biomass and abundance across all strata
boot.samples.rov <- boot.df.rov %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

# Summarise ROV biomass and abundance across all strata
boot.summ.sample.rov <- boot.samples.rov %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975)) %>% 
  arrange(as.character(sciName))
```

```{r SUB_bootstrap}
if (do.boot) {
  # Bootstrap SUB abundance and biomass by strata
  # Create data frame for storing results
  boot.df.sub <- data.frame()
  
  for (i in unique(boot.data.sub$sciName)) {
    for (j in unique(boot.data.sub$site)) {
      for (k in unique(boot.data.sub$stratum)) {
        boot.data <- filter(boot.data.sub, sciName == i & site == j & stratum == k)
        if (nrow(boot.data) > 0) {
          boot.abund <- NA_real_
          boot.biom  <- NA_real_
          for (ii in seq(1:n.boot)) {
            boot.abund[ii] <- mean(sample(boot.data$abund,nrow(boot.data),replace = T))
            boot.biom[ii]  <- mean(sample(boot.data$biom,nrow(boot.data),replace = T))/1000 # Biomass (kg)
          }
          boot.df.sub <- rbind(boot.df.sub,
                               data.frame(platform = "SUB", sciName = i, site = j, 
                                          stratum = k, sample = seq(1,n.boot),
                                          boot.abund, boot.biom))
        }
      }
    }
  }
  # Save bootstrap results
  save(boot.df.sub, file = here("Output/boot_results_sub.Rdata"))
} else {
  load(here("Output/boot_results_sub.Rdata"))
}
# Summarise SUB results by stratum
boot.summ.stratum.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,stratum) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))

# Calculate SUB biomass and abundance across all strata
boot.samples.sub <- boot.df.sub %>% 
  group_by(platform,sciName,site,sample) %>% 
  summarise(
    boot.abund = sum(boot.abund),
    boot.biom = sum(boot.biom))

# Summarise SUB biomass and abundance across all strata
boot.summ.sample.sub <- boot.samples.sub %>% 
  group_by(platform,sciName,site) %>% 
  summarise(
    samples      = n(),
    abund.mean   = mean(boot.abund),
    abund.cv     = sd(boot.abund)/abund.mean * 100,
    abund.ci.low = quantile(boot.abund, 0.025),
    abund.ci.hi  = quantile(boot.abund, 0.975),
    biom.mean    = mean(boot.biom),
    biom.cv      = sd(boot.biom)/biom.mean * 100,
    biom.ci.low  = quantile(boot.biom, 0.025),
    biom.ci.hi   = quantile(boot.biom, 0.975))
```

```{r AUV_bootstrap,eval = T}
boot.summ.sample.auv <- boot.summ.sample.rov[0, ]
```

```{r ALL_bootstrap_summary}
boot.summ.sample.all <- bind_rows(boot.summ.sample.rov,boot.summ.sample.sub) %>% 
  ungroup() %>%
  mutate(sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus"),
         sciName = fct_rev(factor(sciName)),
         biom_cv_cut = cut(biom.cv,c(0,25,50,75,100)),
         abund_cv_cut = cut(abund.cv,c(0,25,50,75,100))) %>% 
  left_join(site.area) %>% 
  arrange(platform, site, sciName)

raster.biomass.all <- ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y      = element_blank(),
        axis.title.y     = element_blank(),
        strip.background = element_blank(),
        strip.text.x     = element_text(face = "bold")) +
  ggtitle("Biomass")

ggsave(raster.biomass.all, filename = here("Figs/fig_raster_biomass_all.png"),
       height = fig.height, width = fig.width)

raster.biomass.select <- ggplot(filter(boot.summ.sample.all,sciName %in% select.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = biom.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(biom.mean,0), big.mark = ",")),size = 3) +  
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y      = element_blank(),
        axis.title.y     = element_blank(),
        strip.background = element_blank(),
        strip.text.x     = element_text(face = "bold")) +
  ggtitle("Biomass")

ggsave(raster.biomass.select, filename = here("Figs/fig_raster_biomass_select.png"),height = 5, width = 5)

raster.abundance.all <- ggplot(boot.summ.sample.all, aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 2.5) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = "none") +
  ggtitle("Abundance")

ggsave(raster.abundance.all, filename = here("Figs/fig_raster_abundance_all.png"),height = fig.height, width = fig.width)

raster.abundance.select <- ggplot(filter(boot.summ.sample.all,sciName %in% select.spp), aes(factor(sciName),platform)) + geom_raster(aes(fill = abund.cv)) + 
  scale_fill_gradientn(name = "CV (%)\n", colours = c("green","lightgreen","yellow","orange","red"), limits = c(0,100)) +
  geom_text(aes(label = prettyNum(round(abund.mean,0), big.mark = ",")),size = 3) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_flip() + xlab("Species") + ylab("Vehicle") +
  facet_wrap(~site, nrow = 1) + 
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = "none") +
  ggtitle("Abundance")

ggsave(raster.abundance.select, filename = here("Figs/fig_raster_abundance_select.png"),height = 5, width = 5)

raster.both.all <- plot_grid(raster.abundance.all, raster.biomass.all, nrow = 1)
ggsave(raster.both.all, filename = here("Figs/fig_raster_both_all.png"),height = 8, width = 10)

raster.both.select <- plot_grid(raster.abundance.select, raster.biomass.select, nrow = 1)
ggsave(raster.both.select, filename = here("Figs/fig_raster_both_select.png"),height = 4, width = 10)
```

```{r ALL_bootstrap_samples}
boot.samples.all <- bind_rows(boot.samples.rov, boot.samples.sub) %>% 
  ungroup() %>% 
  mutate(sciName = str_replace(sciName,"Sebastes miniatus","Sebastes crocotulus"))

# Footprint data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% select.spp & site == "The Footprint"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_footprint.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% select.spp & site == "The Footprint"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x = element_text(face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_footprint.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_footprint.png"), height = 5, width = 12)

# Piggy Bank data
boot.abund.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% select.spp & site == "Piggy Bank"), aes(boot.abund)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "Piggy Bank"), 
             aes(xintercept = abund.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x     = element_text(face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x      = element_blank(),
        axis.text.y      = element_blank()) +
  xlab("Abundance") + ylab("Density")

ggsave(boot.abund.dens.plot, filename = here("Figs/fig_density_abundance_piggy.png"), height = 2, width = 15)

boot.biom.dens.plot <- ggplot(filter(boot.samples.all, sciName %in% select.spp & site == "Piggy Bank"), aes(boot.biom)) + 
  geom_density(aes(fill = platform), alpha = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.low, colour = platform), linetype = "dashed", size = 0.5) +
  # geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "The Footprint"), 
  #            aes(xintercept = abund.ci.hi, colour = platform), linetype = "dashed", size = 0.5) +
  geom_vline(data = filter(boot.summ.sample.all, sciName %in% select.spp & site == "Piggy Bank"), 
             aes(xintercept = biom.mean, colour = platform), size = 1) +
  facet_wrap(~sciName, scales = "free", nrow = 1) + 
  scale_fill_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  scale_colour_manual(name = "Vehicle", values = c("ROV" = rov.colour, "SUB" = sub.colour)) + theme_bw() +
  theme(strip.text.x     = element_text(face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x      = element_blank(),
        axis.text.y      = element_blank()) +
  xlab("Biomass") + ylab("Density")

ggsave(boot.biom.dens.plot, filename = here("Figs/fig_density_biomass_piggy.png"), height = 2, width = 15)

boot.dens.plot.all <- plot_grid(boot.abund.dens.plot,boot.biom.dens.plot, ncol = 1)

ggsave(boot.dens.plot.all, filename = here("Figs/fig_density_both_piggy.png"), height = 5, width = 15)
```

```{r SampleSummary}
sample.summ <- boot.data.all %>% 
  select(platform, site, stratum, dive_name, distance, area) %>% 
  distinct() %>% 
  group_by(platform, site, stratum) %>% 
  summarise(
    n_samples = n(),
    distance  = sum(distance)/1000,
    area      = sum(area)*1e-6) %>% 
  mutate(
    stratum.name = case_when(
      stratum == "(-100,0]" ~ "<100 m",
      stratum == "(-200,-100]" ~ "100-200 m",
      stratum == "(-300,-200]" ~ "200-300 m",
      stratum == "(-400,-300]" ~ "300-400 m",
      TRUE ~ "All")) %>% 
  select(Vehicle = platform, Site = site, Stratum = stratum.name, 
         Samples = n_samples, Distance = distance, Area = area)

# Summarize transect duration and distance for the ROV
tx.summ.rov <- nav.rov %>% 
  group_by(dive_name) %>% 
  summarise(
    distance = sum(disp),
    duration = as.numeric(difftime(max(date_time),min(date_time),units = "mins"))) %>% 
  mutate(platform = "ROV")
  
# Site totals of transects, distance, area and depth range for each vehicle
tx.summ.site <- nav.rov.summ %>%
  bind_rows(nav.sub.summ) %>% 
  # bind_rows(nav.auv.summ) %>% 
  group_by(platform,site) %>% 
  summarise(n = sum(n.tx),
            D = sum(distance)/1000,
            A = sum(survey_area)*1e-6,
            depth.min = min(depth.min),
            depth.max = max(depth.max))

# Site totals of transects, distance, area and depth range for each vehicle
tx.summ.all <- tx.summ.site %>%
  group_by(platform) %>% 
  summarise(n = sum(n),
            D = sum(D),
            A = sum(A),
            depth.min = min(depth.min),
            depth.max = max(depth.max))
```

**Estimates of groundfish biomass, abundance, and diversity using different optical sampling methods in untrawlable habitats** 

Kevin L. Stierhoff^1^, Mary M. Yoklavich^2^, and M. Elizabeth Clarke^3^, Jeff Anderson^4^, Erica L. Fruh^3^, Thomas E. Laidig^2^, Scott A. Mau^1^, David W. Murfin^1^, Abigail Powell^3^, Jeremy C. Taylor^4^, Diana L. Watters^2^  

^1^Fisheries Resources Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
8901 La Jolla Shores Drive
La Jolla, CA 92037, USA

^2^Fisheries Ecology Division  
Southwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
110 McAllister Way  
Santa Cruz, CA 95060, USA

^3^Office of the Science Director  
Northwest Fisheries Science Center  
NOAA-National Marine Fisheries Service  
2725 Montlake Boulevard East  
Seattle, WA 98112, USA  

^4^Coral Reef Ecology Division  
Pacific Islands Fisheries Science Center  
NOAA-National Marine Fisheries Service  
1845 Wasp Boulevard  
Honolulu, HI 96818  

Draft date: `r format(Sys.time(), "%d %B %Y")`

\newpage

# Abstract  

**[To Do last]**

\newpage  

# Introduction  

Many managed groundfish stocks on the U.S. west coast inhabit high-relief rocky areas that are inaccessible to traditional net-based survey methods (e.g., swept-area benthic trawls). Several species, such as cowcod (_Sebastes levis_) and yelloweye rockfish (_S. ruberrimus_), are strongly associated with these untrawlable habitats, have populations at various levels of depletion, and occupy habitats that have incurred substantial impacts [@Love2006a; @Yoklavich2007]. Because large areas of the continental shelf and upper slope are closed to fishing, fishery-independent monitoring tools, whether optical, acoustical, or some combination of both, are required to assess populations of depleted groundfish species while minimizing impacts to their vulnerable habitats. 

**[MORE]**

In order to develop a long-term plan to monitor groundfishes in untrawlable habitats, the capability and efficiency of the survey tools must be evaluated. Accordingly, we conducted a field study to compare population estimates of ecologically and commercially important groundfishes in complex rocky areas of southern CA using three tools: a human-occupied submersible (SUB), a Seabed autonomous underwater vehicle (AUV), and a remotely operated vehicle (ROV). Specific objectives were to: 1) identify, count, and measure rockfishes (_Sebastes_ spp.; both common and rare, large- and small-bodied, and semi-pelagic and highly demersal), lingcod (_Ophiodon elongatus_), thornyheads (_Sebastolobus_ sp.), and Pacific hake (_Merluccius productus_); 2) estimate the density, abundance, and biomass (and associated precision) for these taxa; and 3) estimate groundfish diversity within a prescribed study area.  

# Methods  
## Survey area  
Underwater surveys of demersal fishes and their seabed habitats were conducted on two rocky banks - The Footprint and Piggy Bank - off southern California (**Figure 1**). The study site is located inside the State and Federal Footprint Marine Reserves, offshore of Santa Cruz Island, inside the Channel Islands National Marine Sanctuary. Piggy Bank is about 30 km^2^ in area, ranging in depth from 275 to 900 m; The Footprint is about 10 km^2^ in area, ranging in depth from 80 to 500 m. High-resolution bathymetry and broad-scale seabed classification from multibeam echosounder backscatter data were available prior to our surveys [@Dartnell2005]. For the SUB and ROV surveys, each bank was stratified into 100-m depth strata down to 400 m. The total area of each stratum was estimated using a geographic inforamtion system (GIS, ArcMap version 9.3; Esri, Inc.). **How was the survey area stratified prior to the AUV survey?** Large areas of soft sediment in the northeast section of the study site were excluded from the SUB and ROV sampling frame but were sampled using the AUV. **Will we remove AUV samples collected in the soft substrates?**  

## Survey design  
Visual surveys were conducted during daylight hours (~06:30 to 17:00 h PST) using a SUB (_Dual DeepWorker_, Nuytco Research Ltd.) deployed from the fishing vessel (F/V) _Velero IV_ 21-30 September 2011; ROV (_Phantom DS4_, Deep Ocean Exploration and Research) deployed from the F/V _Outer Limits_ during four legs (due to technical problems, inclement weather, or both) between 21 September-8 December 2011 (Leg 1: 21-22 September; Leg 2: 4 October; Leg 3: 12-13 October; and Leg 4: 4-8 December; and AUV (_Lucille_, SeaBED) between 21-30 September 2011 (check dates) aboard the research vessel (R/V) _Shearwater_.  

The densities of target species (**Table 1**) were estimated by each vehicle using strip transect sampling within a prescribed survey area (**Figure 1**). For the SUB and ROV surveys, each bank was stratified into four 100-m depth bins between 0 and 400 m (**Figure 1**). Within each depth stratum, transect locations were randomly selected prior to the survey and oriented approximately parallel to isobaths to avoid sampling across multiple strata. Transects were either of fixed duration (~15 min, SUB) or distance (~500 m, ROV). The SUB and ROV aimed to survey at a constant altitude and within ~2 m of the seafbed and a constant speed of 0.5-1.0 kn, but altitude, speed, or both sometimes varied by substrate type (i.e., generally slower speed **and higher altitude(?)** in complex habitats). On occasion, ROV transects spanned multiple depth strata, which were post-stratified into multiple transects; only transects greater than 200 m-long were included in the analysis. Additional SUB transects were allocated to the 0-100 m depth strata since earlier studies indicated relatively high groundfish diversity, species richness, or both at those depths at this site. For the AUV survey, a 250 x 250 m grid was superimposed on the survey area (**Figure 1**), then each grid cell was assigned to one of three regions: Piggy Bank, The Footprint, and the deeper flank around The Footprint. Within each region, cells were randomly selected and sampled following a pattern of five parallel 200-m long transects connected by four 25-m long perpinducular trasnects (total transect distance of 1.1 km) at an altitude of approximately 3.5-4 m above the seabed. The analysis included only areas sampled by all three vehicles (i.e., $\leq$ 400 m at The Footprint and Piggy Bank), which excluded some transects conducted by the AUV (e.g., the large area of soft sediment in the northeast section of the study area).  

## Survey vehicles  
### Human-occupied submersible  
A pilot operated the untethered SUB while an experienced scientist inside the SUB identified all fishes and estimated their size along multiple 15-min transects during each dive. The location of the SUB above the seabed was estimated using an ultrashort baseline (USBL) acoustic tracking system (TrackLink 5000HA; LinkQuest) and differential global positioning system (dGPS) interfaced with a GIS and used by a navigator aboard the support vessel to track the path of the SUB. Each transect was also documented by two high-definition (HD), three-color video cameras mounted at 45^$\circ$^ below horizontal on the starboard side of the SUB: one positioned in the same direction and field of view as the onboard observer and the other camera located below the observer's field of view to record fishes in the area closest to the SUB that may not have been seen by the observer. Camera times were synchronized to the GPS clock; observations from the scientist were recorded on the audio track of the video camera and later reviewed in the laboratory. Paired lasers spaced 20-cm apart on either side of the main video camera were used for reference to estimate fish size. Distance and speed was measured using a Doppler velocity log (DVL; NavQuest 600 Micro, LinkQuest, Inc.) and ring-laser gyro (CDL MiniRLG2; Teledyne, Inc.) attached to the SUB. All data were time-stamped and logged synchronously every 3 s using integrated navigation software (WinFrog, Fugro Pelagos).  

### Remotely operated vehicle  
A pilot aboard the vessel operated the ROV along planned transect routes. The location of the ROV above the seabed was estimated using a USBL (TrackLink 5000HA; LinkQuest) and dGPS (dGPS MAX, CSI Wireless). Video was recorded from a single standard definition (NTSC; 460+ lines of resolution) color video camera (EVI-330, Sony) mounted on a variable-pitch tray, and later used for enumerating fishes and describing seabed characteristics. High-resolution (3 megapixel) images were collected haphazardly using a digital still camera (Scorpio, Insite Pacific) mounted on the same tray and used to aid the identification and measurement of fishes observed in video recordings. The altitude and speed of the ROV was measured using a DVL (1200 kHz Workhorse Navigator, Teledyne RD Instruments) and used to estimate transect distance and width. Reference lasers spaced 20 and 60 cm-apart were used to estimate fish size. Temperature, salinity, and DO were measured during each transect using a CTD (Citadel CTD-ES, Teledyne RD Instruments) and optode (Model 3930, Aanderaa, Inc.). All data were time-stamped and logged synchronously using integrated navigation software (Winfrog, Fugro Pelagos). 

### Autonomous underwater vehicle  
The AUV navigated along its programmed route using a DVL (1200 kHz Workhorse Navigator; Teledyne RD Instruments), gyrocompass/inertial motion sensor (iXSea, OCTANS), and the GPS coordinates acquired while on the surface at the dive launch point. The actual location of the AUV above the seabed was estimated from the support vessel using a USBL acoustic tracking system (TrackLink 1500, LinkQuest, Inc.) and dGPS. The depth of the AUV was determined using a pressure sensor (**Model?**, Paroscientific). Stereo images were collected every 10 s using a calibrated, downward-facing stereo camera pair (5-megapixel, 12-bit dynamic range GigE machine vision cameras; Prosilica) synced to a strobe (**[model important?]**); a third GigE camera was angled forward at 30^$\circ$^ and synced with the downward-facing stereo cameras. All data were time-stamped and logged synchronously using **integrated navigation software (Winfrog, Fugro Pelagos??)**.

## Visual analysis  
All species were identified to the lowest possible taxon, counted, and measured. The identification of fishes observed in SUB and video was aided by audio annotations from an experienced on-board scientist, while high-resolution still images aided the identification of fishes observed using the ROV. Identification of fishes observed in non-overlapping, color-corrected stereo images from the downward-facing AUV camera was aided by photos from the third angled camera. When fishes could not be identified to species, they were identified to the genus (e.g., unidentified rockfish, _Sebastes_ spp.; or unidentified thornyhead, _Sebastolobus_ spp.) or subgenus level (e.g., rosy-group rockfish, _Sebastomus_). The total length (TL) of fishes observed by the AUV were estimated to 1 cm resolution using custom stereo image analysis software (**One Two Red Blue**, NWFSC). The TL of fishes observed from the SUB and ROV were estimated to the nearest 5- or 10-cm, respectively, using calibrated parallel lasers for reference. Some fish oriented perpindicular to the ROV camera lens and near the reference lasers were measured to the nearest 1 cm using image analysis software (ImageJ, National Institute of Health).

## Sampling effort
Abundance and biomass of fishes were calculated using the area of each transect. For the SUB, transect distance was estimated using distance measured by the DVL and ring-laser gyro; transect width was estimated by the scientist inside the SUB with the aid of a hand-held sonar and a crossing laser set to intersect the parallel laser at 3 m from the observer when the submersible was 1 m above the seabed. Transect area was estimated as the product of transect distance and width (a fixed transect width of 2.5 m). For the ROV, transect distance was estimated from ROV speed, transect width was estimated from the ROV altitude and the optical properties of the video cameras, and transect area was estimated as the summed product of distance and transect width estimates measured every 2-s [@Stierhoff2016]. For the AUV, transect area was estimated **a)** as the sum of the area of non-overlapping stereo image pairs estimated using custom software (_Sebastes_, NWFSC) or **b)** altitude off the bottom and the specified camera field of view **(Please choose which method, _a_ or _b_)**. Each vehicle aimed to survey the planned transects at a constant speed and altitude above the seabed. Transect segments during which the seabed was not clearly visible were removed from the data analysis for each vehicle.  

## Seabed characterization  
Primary and secondary geologic seabed characteristics were described at the beginning of the transect, at the time of each fish observation, and also at any transition between different seabed types, allowing for the description of associations between each species and seabed types and also for the estimation of area searched within each seabed type. Both primary (>50% of the seabed within the strip area) and secondary (20-50% of the seabed within the strip area) substrate types were quantified. Substrate classification generally followed Greene et al. [-@Greene1999], and were based on particle size: mud (clay to silt; <0.06 mm), sand (0.06-2 mm), pebble (2-64 mm), cobble (64-256 mm), boulder (0.25-3 m), low-relief bedrock ("pavement"; <1 m vertical relief for the SUB and <0.25 m for the ROV), and high-relief bedrock (>1 m vertcial relief for the SUB and >0.25 m for the ROV). The area of each substratum type in a transect was estimated as the product of the transect width and the distance between substratum types for the SUB and ROV surveys, or as the total area of images containing similar substratum types for the AUV survey.  

## Population estimation
Abundance (_N_) and biomass (_M_) of each taxon was estimated using the strip transect sampling method [@Buckland2001]. For each sample (_i_, transect or grid), numeric density (_d~N~_) was calculated as: $d_{N_i} = n_i/a_i$, where _n_ is the number of individuals observed and _a_ is the sample area. Abundance within each **depth** stratum (_j_) was then calculated as: $N_j = d_{N_i} * A_j$, where _A_ is the stratum area. For each sample, biomass density (_d~M~_) was calculated as: $d_{M_i} = (m_i * n_i) / A_i$, where _m_ is the total biomass of individuals observed in the sample, calculated as the sum of individual biomasses estimated from TL using published length-to-weight relationships (see **Table 1**). Biomass within each stratum was then calculated as: $M_j = d_{M_i} * A_j$. The midpoint of each size class (e.g., 5 cm for the 0-10 cm class) was used to estimate biomass for fish assigned to 10-cm length bins fromt the ROV survey. For species where the length-to-weight relationship was unknown (e.g., dwarf-red rockfish, _S. rufinanus_; rosethorn rockfish, _S. simulator_; and pygmy rockfish, _S. wilsoni_), coefficients for closely related species were used [see @Hyde2007]. Coefficients for vermilion rockfish (_S. miniatus_) were used for sunset rockfish [_S. crocotulus_; @Hyde2008a]. Because many of the unidentified rockfishes were semi-pelagic and aggregating, coefficients were used from squarespot rockfishes (_S. hopkinsi_, the most commonly identified species in this study with similar behavior and vertical distribution). For unidentified rosy-group rockfishes (_Sebastomus sp._), coefficients were used from swordspine rockfish (_S. ensifer_, the most commonly identified _Sebastomus_ species observed in this study). Mean, CV of the mean, and 95%-quantile confidence intervals for abundance and biomass were estimated using a non-parametric bootstrap of `r n.boot` samples [@Efron1993].  

## Biodiversity estimates  
**Do we want to describe diversity?**
_**[ROV]** Species richness (_S_); species diversity (Shannon _H’_), and Simpson's lambda ($\lambda$) were computed for each transect and then summarized within each depth stratum and at each bank. The expected species richness (rarefaction) in a particular sample from that stratum was estimated and arefaction curves were generated for each bank using the. All biodiversity estimates were generated using the _vegan_ package [@Oksanen2012] in R [@RCoreTeam2017]._  

# Results  
## Survey effort  
Using the SUB, a total of `r tx.summ.all$n[tx.summ.all$platform == "SUB"]` transects were conducted between `r round(tx.summ.all$depth.min[tx.summ.all$platform == "SUB"],0)` and `r round(tx.summ.all$depth.max[tx.summ.all$platform == "SUB"],0)` m at The Footprint (n = `r tx.summ.site$n[tx.summ.site$platform == "SUB" & tx.summ.site$site == "The Footprint"]` transects) and Piggy Bank (n = `r tx.summ.site$n[tx.summ.site$platform == "SUB" & tx.summ.site$site == "Piggy Bank"]` transects) covering a total distance of `r sprintf("%.1f",tx.summ.all$D[tx.summ.all$platform == "SUB"])` km and a total area of `r sprintf("%.4f",tx.summ.all$A[tx.summ.all$platform == "SUB"])` km^2^ (**Table 2**). Mean transect length was `r sprintf("%.0f",mean(tx.summ.sub$distance))` m (SE = `r sprintf("%.0f",sd(tx.summ.sub$distance)/sqrt(nrow(tx.summ.sub)))` m). Transect duration ranged from `r sprintf("%.0f",min(tx.summ.sub$duration))` to `r sprintf("%.0f",max(tx.summ.sub$duration))` min (mean = `r sprintf("%.0f",mean(tx.summ.sub$duration))` min, SE = `r sprintf("%.1f",sd(tx.summ.sub$duration)/sqrt(nrow(tx.summ.sub)))` min). 

Using the ROV, a total of `r tx.summ.all$n[tx.summ.all$platform == "ROV"]` transects were conducted between `r round(tx.summ.all$depth.min[tx.summ.all$platform == "ROV"],0)` and `r round(tx.summ.all$depth.max[tx.summ.all$platform == "ROV"],0)` m on The Footprint (n = `r tx.summ.site$n[tx.summ.site$platform == "ROV" & tx.summ.site$site == "The Footprint"]` transects) and Piggy Bank (n = `r tx.summ.site$n[tx.summ.site$platform == "ROV" & tx.summ.site$site == "Piggy Bank"]` transects) covering a total distance of `r sprintf("%.1f",tx.summ.all$D[tx.summ.all$platform == "ROV"])` km and a total area of `r sprintf("%.4f",tx.summ.all$A[tx.summ.all$platform == "ROV"])` km^2^ (**Table 2**). Mean transect length was `r sprintf("%.0f",mean(tx.summ.rov$distance))` m (SE = `r sprintf("%.0f",sd(tx.summ.rov$distance)/sqrt(nrow(tx.summ.rov)))` m). Transect duration ranged from `r sprintf("%.0f",min(tx.summ.rov$duration))` to `r sprintf("%.0f",max(tx.summ.rov$duration))` min (mean = `r sprintf("%.0f",mean(tx.summ.rov$duration))` min, SE = `r sprintf("%.1f",sd(tx.summ.rov$duration)/sqrt(nrow(tx.summ.rov)))` min).  

_**[AUV, from an early report]** `Twenty-seven` cells were sampled throughout the survey area covering a total of `70,006` m^2^ and ranging in depth from `99` to `487` m: `13` on The Footprint, `six` on the flank of Footprint, and `eight` on Piggy Bank (**Table X**).  `Seventeen` of the `27` cells were entirely within one 100-m depth stratum, while `ten` cells spanned two 100 m strata. The range of depths surveyed within a cell varied from 10 m to 83 m. Habitats encountered ranged from high-relief rock ridge to mud/sand bottom (**Figure X**)._ 

## Summary of observations
A total of `r nrow(obs.all.summ)` groundfish species were observed and quantified, including `r sum(str_detect(obs.all.summ$sciName,"Sebastes"))` species of rockfish (_Sebastes_ spp.), `r num2words(sum(str_detect(obs.all.summ$sciName,"Sebastolobus")))` species of thornyheads (_Sebastolobus_ spp.), lingcod (_Ophiodon elongatus_), and hake (_Merluccius productus_; **Table 3**). Rockfishes were the most common groundfishes encountered, comprising `r round(sum(obs.all.summ$pctGrand[str_detect(obs.all.summ$sciName,"Sebastes")]))`% (n = `r prettyNum(sum(obs.all.summ$nGrand),big.mark=",")`) of all individuals counted.  

Using the SUB, a total of `r prettyNum(sum(obs.sub.summ$nSUB),big.mark=",")` individuals were observed from `r nrow(obs.sub.summ)` groundfish species or species groups. A total of `r sprintf("%.0f",sum(str_detect(obs.sub.summ$sciName,"Sebastes")))` rockfish species were encountered, which as a group comprised `r round(sum(obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes")]))`% (n = `r prettyNum(sum(obs.sub.summ$nSUB[grep("Sebastes",obs.sub.summ$sciName)]),big.mark=",")`) of the total individual groundfishes observed (**Table 3**). Unidentified rockfishes (_Sebastes_ sp.) comprised `r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes sp.")])`% of all rockfishes (including some young-of-year juveniles); all other rockfishes were identified to species or species group (e.g., "rosy-group" or _Sebastomus_ sp.; n = `r prettyNum(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastomus sp.")],big.mark = ",")` or `r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastomus sp.")])`%). Dwarf rockfish species were most numerous among all target species and dominated by squarespot (`r sprintf("%.0f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes hopkinsi")])`%), halfbanded (`r sprintf("%.0f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes semicinctus")])`%), shortbelly (`r sprintf("%.0f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes jordani")])`%), pygmy (`r sprintf("%.0f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes wilsoni")])`%), and swordspine rockfish (`r sprintf("%.0f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes ensifer")])`%). Among the species of interest were observations of `r sprintf("%.0f",obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastes paucispinis")])` bocaccio (`r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes paucispinis")])`%), `r round(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastes levis")])` cowcod (`r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes levis")])`%), `r round(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastes crocotulus")])` sunset (`r sprintf("%.2f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes crocotulus")])`%), and `r num2words(round(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastes eos")]))` pink rockfish (`r sprintf("%.2f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes eos")])`%). Of particular interest was the observation of `r num2words(round(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Sebastes gilli")]))` bronzespotted rockfish (_S. gilli_; `r sprintf("%.2f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Sebastes gilli")])`%), a rare and elusive species. Among non-rockfish species, hake (mostly juveniles; n = `r prettyNum(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Merluccius productus")],big.mark = ",")` or `r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Merluccius productus")])`%) were relatively abundant but lingcod were not (n = `r round(obs.sub.summ$nSUB[str_detect(obs.sub.summ$sciName,"Ophiodon elongatus")])` or `r sprintf("%.1f",obs.sub.summ$pctSUB[str_detect(obs.sub.summ$sciName,"Ophiodon elongatus")])`%).  

Using the ROV, a total of `r prettyNum(sum(obs.rov.summ$nROV),big.mark=",")` individuals were observed from `r nrow(obs.rov.summ)` groundfish species or species groups. A total of `r sprintf("%.0f",sum(str_detect(obs.rov.summ$sciName,"Sebastes")))` rockfish species were encountered, which as a group comprised `r round(sum(obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes")]))`% (n = `r prettyNum(sum(obs.rov.summ$nROV[grep("Sebastes",obs.rov.summ$sciName)]),big.mark=",")`) of the total groundfishes observed (**Table 3**). Unidentified rockfishes (_Sebastes_ sp.) comprised `r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes sp.")])`% of all rockfishes observed using the ROV; all other rockfishes were identified to species or species group (e.g., _Sebastomus_ sp.; `r sprintf("%.0f",obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastomus sp.")])` or `r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastomus sp.")])`%). Dwarf rockfish species were most numerous among all species of interest and dominated by squarespot (`r sprintf("%.0f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes hopkinsi")])`%), swordspine (`r sprintf("%.0f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes ensifer")])`%), halfbanded (`r sprintf("%.0f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes semicinctus")])`%), shortbelly (`r sprintf("%.0f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes jordani")])`%), pygmy (`r sprintf("%.0f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes wilsoni")])`%). Among the species of interest were the observations of `r sprintf("%.0f",obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastes paucispinis")])` bocaccio (`r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes paucispinis")])`%), `r round(obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastes levis")])` cowcod (`r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes levis")])`%), `r round(obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastes crocotulus")])` sunset (`r sprintf("%.2f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes crocotulus")])`%), and `r round(obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastes eos")])` pink rockfish (`r sprintf("%.2f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes eos")])`%). Similar to the SUB, `r num2words(round(obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Sebastes gilli")]))` bronzespotted rockfish (`r sprintf("%.2f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Sebastes gilli")])`%) were observed using the ROV. Among non-rockfish species, neither hake (n = `r sprintf("%.0f",obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Merluccius productus")])` or `r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Merluccius productus")])`%) nor lingcod were (n = `r round(obs.rov.summ$nROV[str_detect(obs.rov.summ$sciName,"Ophiodon elongatus")])` or `r sprintf("%.1f",obs.rov.summ$pctROV[str_detect(obs.rov.summ$sciName,"Ophiodon elongatus")])`%) were abundant.  

_**Using the AUV, ...**_

## Seabed composition  
_**[AUV, from an early report]** Cells surveyed on the top of Piggy Bank (200-300 m) contained rocky ridge substrate (30%), mud (33%) and similar amounts of boulder and cobble (17 and 19%, respectively). With increasing depth, the percentage of mud and cobble substrates increased. The top two depth strata on the Footprint were primarily cobble and boulder, with sand and rock ridge increasing with depth (**Figure X**.  Mud was the primary substrate observed in all depth strata on the flank of the Footprint (86, 99 and 97%)._

## Length frequency composition 
_Examine whether differences in length distributions contribute to any differences in biomass or abundance._  

The length composition of observed fishes varied by survey platform **(Figure 6)**.

## Abundance and biomass estimates  
### SUB  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**

_A total of `414,975` fishes and `60.3` mt of fish biomass on Piggy Bank (not including unidentified adult orjuvenile rockfishes nor sharpchin rockfish (_S. zacentrus_) because meaningful length-weight relationships were not available) (**Table 5**). _Sebastes jordani_ ($N$ = `163,022`), _S. rufus_ ($N$ = `116,040`), and _S. diploproa_ (64,489 individuals) were most abundant and comprised the greatest biomass (`18`%, `53`%, and `12`% of total biomass, respectively) on the Piggy Bank. _ 

_A total of `1,953,844` fishes representing `147.6` mt of fish biomass (excluding biomass estimates of unidentified rockfishes and sharpchin rockfish, as noted above) on The Footprint. Three dwarf species of rockfishes (_S. jordani_, $N$ = `339,855`); _S. semicinctus_, $N$ = `302,275`; and _Sebastomus_ (likely _S. ensifer_), $N$ = `268,618`) were most abundant but together comprised only `27`% of the total biomass. Among the large-bodied species **[these are "large-bodied"?]**, _S. diploproa_ ($N$ = `221,329`, $B$ = `14.5` mt), juvenile _M. productus_ ($N$ = `164,087`, $B$ = `19.5` mt), and _S. rufus_ ($N$ = `68,629`, $B$ = `14.9` mt) were relatively abundant. _Sebastes levis_ ($N$ = `4,325`, $B$ = `4.2` mt) comprised only `0.2`% of total abundance and `2.8`% of total biomass on The Footprint. _Sebastes paucispinis_ ($N$ = `13,342`, $B$ = `8.6` mt) comprised `0.7`% of total abundance and `5.8`% of total biomass at this site._

_Combining estimates from both banks, a total of `2,368,819` fishes with a biomass of `207.9` mt (**Table 7**). _Sebastes jordani_, _S. semicinctus_, and _S. diploproa_ were most abundant overall. Juvenile _M. productus_, _S. rufus_, _S. ensifer_, and _S. hopkinsi_ were also abundant. If _S. ensifer_ and _Sebastomus_ sp. (which were likely _S. ensifer_) were combined, the abundance would be second only to _S. jordani_. Four species (_S. rufus_, `23`% of total biomass; _S. jordani_, 15%; _S. diploproa_, 10%; and juvenile _M. productus_, 10%) comprised over `58`% of the total biomass in the entire study area._

_The coefficient of variation (CV) ranged from `0.12` to `0.84` for estimates of total abundance and from `0.15` to `0.92` for estimates of total biomass over both banks combined (**Table 7**). The CV for total abundance was `0.30` for _S. levis_, `0.26` for _S. paucispinis_, and `0.32` for _S. rufus_; the CV for total biomass was `0.44` for _S. levis_, `0.27` for _S. paucispinis_, and `0.36` for _S. rufus_._  

### ROV 
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_Over `37,700` individuals from thirty-three _Sebastes_ species, _O. elongatus_, and _M. productus_ were counted during this survey. The groundfish community throughout the survey area was numerically dominated by four small, semi-pelagic and aggregating species (squarespot rockfish, _S. hopkinsi_; swordspine rockfish, _S. ensifer_; halfbanded rockfish, _S. semicinctus_; and shortbelly rockfish, _S. jordani_) that comprised ~`80`% of all rockfishes (**Table 1**). Among non-aggregating species, bank (_S. rufus_, `5`%) and swordspine rockfishes (_S. simulator_, `1.5`%) were commonly observed. _Sebastes rufus_ (n = `1,883`) was the most abundant target species. In comparison, _S. paucispinis_ (n = `232`), _S. levis_ (n = `62`), and _S. crocotulus_ (n = `16`) were much less abundant (**Table X**)._  

_Overall abundance and biomass estimates were calculated for `33` species of rockfish, three unidentified rockfish groups, _O. elongatus_, and _M. productus_ (**Table 3**). Estimates of abundance and biomass of each of these species within each depth strata on each bank is provided in **Appendix 3**  
Approximately 2.3 million rockfishes, _O. elongatus_, and _M. productus_ were observed between 100-400 m on both banks (**Table 3**). _Sebastes ensifer_ (`619,114`) was the most abundant species, which was slightly more abundant than _S. hopkinsi_ (`566,753`). Among target species, _S. rufus_ (`177,981`) were highly abundant. _Sebastes paucispinis_ (`12,624`), _S. chlorostictus_ (`5,206`), and _S. levis_ (`4,109`) were much less abundant than those smaller, aggregating species (**Table 3**)._  

_Total biomass of all species was approximately `287` metric tons (mt; 1 mt = 1,000 kg) in the same area (**Table 3**). Nearly `62`% of the total fish biomass was comprised of the combination of _S. rufus_ (`60` mt) and small, aggregating species (_S. hopkinsi_, _S. ensifer_, _S. jordan_i; `118` mt). The other target species, _S. paucispinis_ (`16.2` mt), _S. levis_ (`7.5` mt), and _S. chlorostictus_ (`2.5` mt) had relatively lower biomass._  

_The overall coefficient of variation (CV) for abundance (range = `0.12`-`1.00`) and biomass estimates (range = `0.15`-`1.01`) varied greatly among all species (**Table 3**). Species whose abundance and biomass estimates with high CVs (i.e., greater than ~`0.50`) were those that were either rarely encountered (e.g., _S. crameri_, _S. lentiginosus_, _S. rufinanus_, and _S. serranoides_) or whose densities varied greatly with depth (e.g., _S. hopkinsi_, _S. jordani_, _S. ovalis_, and _S. semicinctus_, which were densely aggregated in the shallower strata of the Footprint and almost entirely absent on Piggy Bank). Among target species, the CV values were relatively low and ranged from `0.28`-`0.46` and `0.26`-`0.44` for abundance and biomass, respectively. For _S. levis_, the overall CV values of abundance and biomass were quite low (`0.28` and `0.30`, respectively), and probably reflect the relatively even distribution of this species among transects on the Footprint and their total absence from any transects on Piggy Bank (**Figure 2**). _Sebastes rufus_ also had very low CV values (`0.26` for both abundance and biomass), but in contrast to _S. levis_, was highly abundant in the deeper strata on both banks (**Fig. 2**). As expected, differences in the distribution of many species were apparent by depth and bank (**Fig. 2**). Small, more numerically abundant species (e.g., _S. ensifer_, _S. hopkinsi_, _S. semicinctus_, and _S. wilsoni_) were commonly encountered on the shallower (<200 m) portions of the Footprint. _Sebastes paucispinis_ and _S. levis_ were found almost exclusively on the Footprint. _Sebastes diploproa_, _S. rufus_, and _S. simulator_ were found throughout the deeper strata on both banks, and were the only species commonly observed on Piggy Bank._  

### AUV
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_A total of `21,228` fishes from `51` taxa were identified during the survey including `18` rockfish species (**Table X**). Rockfishes comprised `75`% of the fishes encountered, including groups of unidentified rockfish (_Sebastes_ spp., **X%**), rosy-group rockfishes (_Sebastomus_, **X%**), and thornyheads (_Sebastolobus_ sp., **X%**), and other species that could be identified to species (**X%**). Notable were observations of `11` cowcod (_S. levis_), 29 bocaccio (_S. paucispinis_) and one bronzespotted rockfish (_S. gilli_). In addition, `53` lingcod (_Ophiodon elongatus_), `19` Pacific hake (_Merluccius productus_) and `10` sablefish (_Anoplopoma fimbria_) were observed. Fish assemblages varied between depth strata and between the two banks. Twenty-nine taxa only occurred on the Footprint or along its Flank. Two species were observed on Piggy Bank only. _ 

## Biodiversity  
### SUB  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_Diversity (**or richness??**; measured as cumulative number of species in transects within a depth stratum, excluding groups), was highest on The Footprint in the 100-200 m (`23` species) and 200-300 m (`26` species) strata (**Table X**). Species richness ($S$) was lowest on Piggy Bank at both depth strata (`8` and `11` species in the 200-300 and 300-400 m strata, respectively)._  

### ROV  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_Biodiversity also varied greatly by depth strata and bank (**Table 6**). The greatest number of species (richness = `15`) was observed in the 0-100 m depth stratum on the Footprint, and the fewest were observed in the 300-400 m stratum at Piggy Bank. The rarefied species richness (the number of species expected per number of samples) was greatest in the 300-400 m stratum at the Footprint, with all other strata having rarefied species richness between `3.5` and `5.1`. Neither of these richness parameters account for the abundance of different species so Shannon $H’$ and Simpson $\lambda$, which do account for abundance differences, were also calculated. Again, the greatest diversity (both $H’$ and $\lambda$, respectively) were observed in the 300-400 m stratum at the Footprint, but diversity was relatively uniform across all depth strata and banks. Biodiversity estimates for each transect is presented in **Appendix 4**._  

_The species accumulation (rarefaction) curves from each bank have much different shapes (**Figure 9**). The curve for the Footprint rises steeply in the first few samples and begins to plateau after ~ **10** transects. The rarefaction curve at Piggy Bank increased at a slower rate and never reached an asymptote. Although there were fewer transects at Piggy Bank, the other diversity estimates corroborate the finding that there is less biodiversity at Piggy Bank compared to the Footprint._  

### AUV
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_Species richness (total species, excluding groups) was the highest in the 100-200 m stratum on the Footprint (N = 23 species) and in the 300-400 m stratum on the Flank (18 species, **Table x**). Species richness was lowest in all three strata on Piggy Bank (six species at 200-300 m, eight species at 300-400 m, and seven species at 400-500 m)._

# Discussion  
## Survey effort 
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_The AUV was able to sample the deeper 400-500 m stratum on the flank of Footprint, and to provide fish and habitat information that was not available from the ROV or SUB (**The ROV could have sampled deeper but..._ 

## Abundance and biomass estimates
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**

### AUV  
**ALL TEXT IN THIS SECTION IS COPY/PASTE FROM THE VARIOUS REPORTS; MUST UPDATE USING NEW RESULTS**
_Species diversity was similar amongst all three methodologies showing greater species richness at the The Footprint and lower richness at Piggy Bank.  The ROV and the SUB included records of rockfish species not identified by the AUV.  This could be due to the fact that the cameras on the AUV are positioned downward, rather than forward facing, allowing fish directly in front of the unit to escape detection. Another possible reason could be the difficulty in identifying some rockfish species from the dorsal view.  The AUV detected comparable numbers of fishes, but the fish were identified to groupings (i.e. Unidentified rockfish, or Sebastomus) as opposed to species._

\newpage  

# Literature Cited

<div id = 'refs'></div>  

\newpage

# Tables  

**Table 1.** Coefficients used to convert total length (_TL_; cm) to weight (g) for biomass estimates using the equation: W = _a_*TL^_b_^.

```{r LengthWeightTable}
# Get species in study
lw_spp <- sort(unique(boot.data.rov$sciName))

# Subset and format table
lw_table <- lw.data %>%
  filter(sciName %in% lw_spp) %>% 
  rename(
      "Scientific name" = sciName,
      "Common name" = commonName,
      Sex = sex,
      Comment = comment) 

# Format and print L/W table
if (doc.type == "docx") {
  lw_table %>% 
    regulartable() %>% 
    italic(j = 1) %>%
    align(align = "center", part = "header") %>%
    autofit()
} else {
  lw_table %>% 
    rename(
      "$L_\\mathrm{max}$" = L_max,
      "$a$" = a,
      "$b$" = b) %>%
    kable(format = knitr.format,booktabs = T, escape = F,
          align = c("l","l","r","r","r","l","l","l"),
          digits = c(0,0,4,4,1,0,0,0)) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>%
    column_spec(1, italic = T)
}
```  

\newpage  

**Table 2** Number of samples, sampling distance (km), and sampling area (km^2^) for each vehicle, site, and depth stratum ("All" if sampling not stratified by depth; e.g., AUV).

```{r SampleSummaryTable}
# Format and print table of observations
if (doc.type == "docx") {
  sample.summ %>% 
    regulartable() %>% 
    align(align  = "center", part = "header") %>% 
    autofit()
} else {
  sample.summ %>% 
    kable(format      = knitr.format, booktabs = T, escape = F,
          align       = c("l","l","r","r","r","r"),
          digits      = c(0,0,0,0,2,4),
          format.args = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped", "condensed",
                                    "repeat_header", "scale_down"),
                  position = "center") %>% 
    collapse_rows(columns = c(1,2))
}
```

\newpage 

**Table 3.** Counts (_N_) and percent total (%) of each taxon observed by the ROV (_N_~R~ and %~R~), SUB (_N_~S~ and %~S~), AUV (_N_~A~ and %~A~), and the grand totals observed by all vehicles (_N_~G~ and %~G~).  

```{r ObsSummaryTable}
# Format and print table of observations
obs.all.summ <- obs.all.summ %>% 
  rename(
      "Scientific name" = sciName,
      "Common name"     = commonName,
      "$N_R$"             = nROV,
      "$\\%_R$"           = pctROV,
      "$N_S$"             = nSUB,
      "$\\%_S$"           = pctSUB,
      "$N_G$"             = nGrand,
      "$\\%_G$"           = pctGrand)

if (doc.type == "docx") {
  obs.all.summ %>% 
    regulartable() %>% 
    italic(j = 1) %>%
    add_header(`Scientific name`  = "",
               `Common name`  = "",
               "$N_R$" = "ROV", "$\\%_R$" = "ROV", 
               "$N_S$" = "SUB", "$\\%_S$" = "SUB", 
               "$N_G$" = "All", "$\\%_G$" = "All") %>% 
    merge_h(part = "header") %>% 
    align(align  = "center", part = "header") %>% 
    autofit()
} else {
  obs.all.summ %>% 
    kable(format      = knitr.format,booktabs = T, escape = F,
          align       = c("l","l","r","r","r","r","r","r"),
          digits      = c(0,0,0,1,0,1,0,1),
          format.args = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped", "condensed",
                                    "repeat_header"),
                  position = "center") %>% 
    column_spec(1, italic = T) %>% 
    add_header_above(c(" " = 2, "ROV" = 2, "SUB" = 2, "All" = 2)) 
}
```  

\newpage  

**Table 4.** Bootstrap estimates of abundance and biomass from the SUB. **Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummarySUB}
boot.summ.table <- boot.summ.sample.all %>% 
  left_join(select(spp, sciName, commonName)) %>% 
  select(sciName, commonName, everything(), -samples, -biom_cv_cut, -abund_cv_cut, -stratum_area) %>% 
  arrange(platform, desc(site), sciName) %>% 
  rename(`Scientific name`       = sciName,
         `Common name`           = commonName,
         Site                    = site,
         "Mean$_{N}$"            = abund.mean,
         "CV$_{N}$"              = abund.cv,
         "Lower CI$_{N, 95\\%}$" = abund.ci.low,
         "Upper CI$_{N, 95\\%}$" = abund.ci.hi,
         "Mean$_{M}$"            = biom.mean,
         "CV$_{M}$"              = biom.cv,
         "Lower CI$_{M, 95\\%}$" = biom.ci.low,
         "Upper CI$_{M, 95\\%}$" = biom.ci.hi) %>% 
  select(Site, everything())

# Select SUB results
boot.table.sub <- filter(boot.summ.table, platform == "SUB") %>% 
  select(-platform)

# Format and print bootstrap summary
if (doc.type == "docx") {
  boot.table.sub %>%
    regulartable() %>% 
    italic(j = 1) %>%
    add_header(
      `Scientific name`       = "",
      `Common name`           = "",
      Site                    = "",
      "Mean$_{N}$"            = "Abundance",
      "CV$_{N}$"              = "Abundance",
      "Lower CI$_{N, 95\\%}$" = "Abundance",
      "Upper CI$_{N, 95\\%}$" = "Abundance",
      "Mean$_{M}$"            = "Biomass",
      "CV$_{M}$"              = "Biomass",
      "Lower CI$_{M, 95\\%}$" = "Biomass",
      "Upper CI$_{M, 95\\%}$" = "Biomass") %>% 
    merge_h(part = "header") %>% 
    align(align = "center", part = "header") %>% 
    autofit()
} else {
  boot.table.sub %>% 
    kable(format          = knitr.format,booktabs = T, escape = F,
          align           = c("l","l","l",rep("r", 8)),
          digits          = c(0,0,0,rep(0,8)),
          format.args     = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>% 
    column_spec(2, italic = T) %>%
    collapse_rows(columns = c(1)) %>% 
    add_header_above(c(" " = 3, "Abundance" = 4, "Biomass" = 4)) 
}
```

\newpage  

**Table 4.** Bootstrap estimates of abundance and biomass from the ROV. **Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummaryROV}
# Select SUB results
boot.table.rov <- filter(boot.summ.table, platform == "ROV") %>% 
  select(-platform)

# Format and print bootstrap summary
if (doc.type == "docx") {
  boot.table.rov %>%
    regulartable() %>% 
    italic(j = 2) %>%
    add_header(
      "Site"                  = "",
      `Scientific name`       = "",
      `Common name`           = "",
      "Mean$_{N}$"            = "Abundance",
      "CV$_{N}$"              = "Abundance",
      "Lower CI$_{N, 95\\%}$" = "Abundance",
      "Upper CI$_{N, 95\\%}$" = "Abundance",
      "Mean$_{M}$"            = "Biomass",
      "CV$_{M}$"              = "Biomass",
      "Lower CI$_{M, 95\\%}$" = "Biomass",
      "Upper CI$_{M, 95\\%}$" = "Biomass") %>% 
    merge_h(part = "header") %>% 
    align(align = "center", part = "header") %>% 
    autofit()
} else {
  boot.table.rov %>% 
    kable(format          = knitr.format,booktabs = T, escape = F,
          align           = c("l","l","l",rep("r", 8)),
          digits          = c(0,0,0,rep(0,8)),
          format.args     = list(big.mark = ",")) %>% 
    kable_styling(latex_options = c("striped","condensed",
                                    "repeat_header","scale_down"),
                  position = "center") %>% 
    column_spec(2, italic = T) %>%
    collapse_rows(columns = c(1)) %>% 
    add_header_above(c(" " = 3, "Abundance" = 4, "Biomass" = 4)) 
}
```  

\newpage  

**Table 5.** Bootstrap estimates of abundance and biomass from the AUV. **[ADD]. Data are presently sorted by site and species name. Consider sorting descending by abundance or biomass.**

```{r BootSummaryAUV}

```

\newpage 

# Figures  

```{r SurveyDomain,fig.align='center',out.width='7in'}
include_graphics(here("Figs/fig_survey_map.png"))
```  

**Figure 1.** Map of the survey area at The Footprint and Piggy Bank, indicating the extent of the sampling area (dashed box), depth strata sampled by the ROV and SUB (blue polygons), the 250 x 250 m grid sampled by the AUV, and transect locations (colored lines; blue = ROV, green = SUB, and orange = AUV). **NOTE: I created a fictitious fishnet for the AUV until I am provided the actual shapefile used to plan the survey.**

\newpage

```{r RasterAllCV,fig.align='center',out.width='6in'}
include_graphics(here("Figs/fig_raster_both_all.png"))
```  

**Figure 2.** Mean abundance (_N_; left), biomass (_M_, kg; right), and coefficient of variation (CV, %; fill color) of all species encountered by at least one vehicle and across all sampling strata. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV).

\newpage

```{r RasterSelectCV,fig.align='center',out.width='7in'}
include_graphics(here("Figs/fig_raster_both_select.png"))
```  

**Figure 3.** Mean abundance (_N_; left), biomass (_M_, kg; right), and coefficient of variation (CV, %; fill color) of select species across all sampling strata. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV).  

\newpage
\blandscape

```{r BootstrapBothFootprint,fig.align='center',out.width='9in'}
include_graphics(here("Figs/fig_density_both_footprint.png"))
```  

**Figure 4.**  Distribution of mean abundance (_N_; top) and biomass (_M_, kg; bottom) estimates of select species at The Footprint. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV). **[selected these species for exploration; can add/remove very easily, but chose these particulary interesting species initially]**

\newpage

```{r BootstrapBothPiggy,fig.align='center',out.width='9in'}
include_graphics(here("Figs/fig_density_both_piggy.png"))
```  

**Figure 5.** Distribution of mean abundance (_N_; top) and biomass (_M_, kg; bottom) estimates of select species at Piggy Bank. Estimates were produced using bootstrap resampling (n = `r n.boot` samples) from each sampling strata (depth and bank for the SUB and ROV; bank for the AUV). **[selected these species for exploration as above; however, not all of the species in The Footprint figure were observed at Piggy Bank]**

\elandscape
\newpage  

```{r LengthHistogramAll,fig.align='center',out.width='6in'}
include_graphics(here("Figs/fig_histogram_length_comp.png"))
```  

**Figure 6.** Length (_TL_, cm)distribution of fishes observed using the three vehicles. **[Selected these species for exploration as above; however, not all of the species in The Footprint figure were observed at Piggy Bank. Excluded unidentified rockfishes (_Sebastes_ and _Sebastomus_), thornyheads (_Sebastolobus_), and hake.]**

\newpage  

```{r LengthHistogramSelect,fig.align='center',out.height='8in'}
include_graphics(here("Figs/fig_histogram_length_comp_select.png"))
```  

**Figure 7.** Length (_TL_, cm)distribution of fishes observed using the three vehicles. **[In addition to those excluded above (unidentified rockfishes (_Sebastes_ and _Sebastomus_), thornyheads (_Sebastolobus_), and hake), also excluded species not of great interest.**